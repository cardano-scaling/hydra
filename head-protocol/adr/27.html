<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.3">
<title data-rh="true">27. Network failures model | Hydra Head protocol documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://hydra.family/head-protocol/adr/27"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="27. Network failures model | Hydra Head protocol documentation"><meta data-rh="true" name="description" content="Status"><meta data-rh="true" property="og:description" content="Status"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-09-09T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/abailly-iohk,https://github.com/pgrange"><meta data-rh="true" property="article:tag" content="Superseded"><link data-rh="true" rel="icon" href="/head-protocol/img/hydra.png"><link data-rh="true" rel="canonical" href="https://hydra.family/head-protocol/adr/27"><link data-rh="true" rel="alternate" href="https://hydra.family/head-protocol/adr/27" hreflang="en"><link data-rh="true" rel="alternate" href="https://hydra.family/head-protocol/adr/27" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://hydra.family/head-protocol/adr/27","mainEntityOfPage":"https://hydra.family/head-protocol/adr/27","url":"https://hydra.family/head-protocol/adr/27","headline":"27. Network failures model\n","name":"27. Network failures model\n","description":"Status","datePublished":"2023-09-09T00:00:00.000Z","author":[{"@type":"Person","name":"Arnaud Bailly","description":"Lead Architect","url":"https://github.com/abailly-iohk","image":"https://github.com/abailly-iohk.png"},{"@type":"Person","name":"Pascal Grange","description":"Senior Software Engineer","url":"https://github.com/pgrange","image":"https://github.com/pgrange.png"}],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://hydra.family/head-protocol/adr","name":"Architecture Decision Records"}}</script><link rel="alternate" type="application/rss+xml" href="/head-protocol/adr/rss.xml" title="Hydra Head protocol documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/head-protocol/adr/atom.xml" title="Hydra Head protocol documentation Atom Feed">










<script src="https://plausible.io/js/script.js" defer="defer" data-domain="hydra.family"></script><link rel="stylesheet" href="/head-protocol/assets/css/styles.c5866d8a.css">
<script src="/head-protocol/assets/js/runtime~main.ce5d1039.js" defer="defer"></script>
<script src="/head-protocol/assets/js/main.fbd98af1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><header aria-label="Main" class="flex navbar tablet:py-[30px] !px-0 shadow-none z-50 border-b border-[#EAEAEB] pt-3 pb-4 tablet:px-2 navbar--fixed-top"><div class="w-full px-6"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/head-protocol/"><div class="navbar__logo"><img src="/head-protocol/img/hydra.png" alt="Hydra Head protocol" class="themedComponent_mlkZ themedComponent--light_NVdE" style="height:27px;margin-top:2.5px"><img src="/head-protocol/img/hydra-white.png" alt="Hydra Head protocol" class="themedComponent_mlkZ themedComponent--dark_xIcU" style="height:27px;margin-top:2.5px"></div></a><a class="hover:text-primary-light navbar__item navbar__link" href="/head-protocol/docs">User manual</a><a class="hover:text-primary-light navbar__item navbar__link" href="/head-protocol/docs/dev">Developer documentation</a></div><div class="navbar__items navbar__items--right"><a class="hover:text-primary-light navbar__item navbar__link" href="/head-protocol/topologies">Topologies</a><a class="hover:text-primary-light navbar__item navbar__link" href="/head-protocol/use-cases">Use cases</a><a class="hover:text-primary-light navbar__item navbar__link" href="/head-protocol/docs/faqs">FAQs</a><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button><a href="https://github.com/cardano-scaling/hydra" target="_blank" rel="noopener noreferrer" class="hover:text-primary-light mx-3 py-1"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" viewBox="0 0 25 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.279 0C5.48905 0 0 5.49998 0 12.3042C0 17.7432 3.51702 22.3472 8.39607 23.9767C9.00607 24.0991 9.22952 23.7119 9.22952 23.3862C9.22952 23.1009 9.20941 22.1232 9.20941 21.1044C5.79368 21.8379 5.08238 19.6377 5.08238 19.6377C4.53345 18.2117 3.72011 17.8452 3.72011 17.8452C2.60214 17.0914 3.80154 17.0914 3.80154 17.0914C5.04166 17.1729 5.69239 18.3544 5.69239 18.3544C6.78999 20.2284 8.55869 19.6989 9.27023 19.3729C9.37178 18.5784 9.69726 18.0284 10.0429 17.7229C7.31857 17.4377 4.45227 16.3784 4.45227 11.6522C4.45227 10.3077 4.93987 9.20771 5.71249 8.35222C5.59059 8.04672 5.16356 6.78347 5.83464 5.09273C5.83464 5.09273 6.87143 4.76673 9.20916 6.35572C10.21 6.08639 11.2422 5.94938 12.279 5.94823C13.3158 5.94823 14.3727 6.09097 15.3487 6.35572C17.6867 4.76673 18.7234 5.09273 18.7234 5.09273C19.3945 6.78347 18.9672 8.04672 18.8453 8.35222C19.6383 9.20771 20.1058 10.3077 20.1058 11.6522C20.1058 16.3784 17.2395 17.4172 14.4949 17.7229C14.9423 18.1099 15.3283 18.8432 15.3283 20.0044C15.3283 21.6544 15.3082 22.9787 15.3082 23.3859C15.3082 23.7119 15.5319 24.0991 16.1417 23.9769C21.0207 22.3469 24.5377 17.7432 24.5377 12.3042C24.5578 5.49998 19.0487 0 12.279 0Z" fill="currentColor"></path></svg></a><a href="https://discord.com/invite/Qq5vNTg9PT" target="_blank" rel="noopener noreferrer" class="hover:text-primary-light mx-3 py-1"><svg xmlns="http://www.w3.org/2000/svg" width="23" height="18" viewBox="0 0 23 18"><path d="M19.4778 1.49632C18.0074 0.806713 16.4357 0.286253 14.7879 0C14.7626 0 14.7246 0 14.7119 0.0390345C14.5091 0.403356 14.2809 0.884782 14.1288 1.27513C12.3543 1.00189 10.6051 1.00189 8.8686 1.27513C8.71649 0.884782 8.47566 0.416368 8.27286 0.0390345C8.26019 0.0130115 8.22216 0 8.19681 0C6.54903 0.286253 4.9773 0.793701 3.51965 1.49632C3.50697 1.49632 3.4943 1.50933 3.4943 1.52234C0.50294 6.08938 -0.308275 10.5523 0.0973328 14.9632C0.0973328 14.9892 0.110008 15.0023 0.122683 15.0153C2.08734 16.4986 4.00131 17.3964 5.86457 17.9949C5.88992 17.9949 5.92794 17.9949 5.94062 17.9689C6.38425 17.3443 6.77718 16.6937 7.11941 16.0041C7.14476 15.9651 7.11941 15.9131 7.08139 15.9C6.4603 15.6528 5.86457 15.3536 5.2815 15.0283C5.2308 15.0023 5.2308 14.9372 5.2815 14.8982C5.40826 14.8071 5.52233 14.703 5.63641 14.6119C5.66176 14.5989 5.68711 14.5859 5.71246 14.6119C9.47701 16.3815 13.5584 16.3815 17.2723 14.6119C17.2976 14.6119 17.323 14.6119 17.3483 14.6119C17.4624 14.703 17.5892 14.8071 17.7032 14.8982C17.7413 14.9242 17.7413 15.0023 17.7032 15.0283C17.1328 15.3666 16.5371 15.6658 15.9034 15.9C15.8653 15.9131 15.84 15.9651 15.8653 16.0041C16.2076 16.6937 16.6005 17.3443 17.0441 17.9689C17.0568 17.9949 17.0948 18.0079 17.1202 17.9949C18.9961 17.3964 20.9101 16.4986 22.8747 15.0153C22.8874 15.0023 22.9001 14.9762 22.9001 14.9632C23.3817 9.86271 22.1015 5.4388 19.5031 1.52234C19.5031 1.50933 19.4904 1.49632 19.4778 1.49632ZM7.6898 12.2828C6.5617 12.2828 5.62374 11.2159 5.62374 9.90175C5.62374 8.58759 6.53635 7.52064 7.6898 7.52064C8.84325 7.52064 9.78121 8.6006 9.75586 9.90175C9.75586 11.2159 8.84325 12.2828 7.6898 12.2828ZM15.333 12.2828C14.2049 12.2828 13.2669 11.2159 13.2669 9.90175C13.2669 8.58759 14.1795 7.52064 15.333 7.52064C16.4864 7.52064 17.4244 8.6006 17.399 9.90175C17.399 11.2159 16.4864 12.2828 15.333 12.2828Z" fill="currentColor"></path></svg></a><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></header><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Architecture Decision Records</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/32">32. Network layer properties, implementation using etcd
</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/31">31. Achieve constant memory in hydra-node
</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/23">23. Local chain state in chain layer
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/24">24. Persist state changes incrementally
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/25">25. Event-sourced, resource-based API
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/26">26. Stateless transaction observation &amp; construction
</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/head-protocol/adr/27">27. Network failures model
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/28">28. Offline mode
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/29">29. EventSource &amp; EventSink abstractions
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/30">30. Use CBOR in external representation of Cardano transactions
</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/13">13. Plutus Contracts Testing Strategy
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/14">14. Token usage in Hydra Scripts
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/15">15. Configuration Through an Admin API
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/16">16. Keep Rejected ADRs
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/17">17. Use UDP protocol for Hydra networking
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/18">18. Single state in Hydra.Node.
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/19">19. Use of reference scripts
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/20">20. Handling time
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/21">21. Bounded transaction validity on Hydra protocol transactions
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/22">22. Test High-level Properties using Model-Based Testing
</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2021</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/1">1. Record Architecture Decisions
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/2">2. Reactive Core
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/3">3. Asynchronous Duplex Client API</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/4">4. Use Handle to model Effects
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/5">5. Use io-classes
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/6">6. Network broadcasts all messages
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/7">7. Use with-pattern based component interfaces
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/8">8. Custom Prelude
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/9">9. Simplify Logging
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/10">10. Use direct connection to `cardano-node`
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/11">11. Use cardano-api
</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/head-protocol/adr/12">12. Top-down Test-driven Design
</a></li></ul></div></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">27. Network failures model
</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-09-09T00:00:00.000Z">September 9, 2023</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/abailly-iohk" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/abailly-iohk.png" alt="Arnaud Bailly"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/abailly-iohk" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Arnaud Bailly</span></a></div><small class="authorTitle_nd0D" title="Lead Architect">Lead Architect</small><div class="authorSocials_rSDt"></div></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/pgrange" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/pgrange.png" alt="Pascal Grange"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/pgrange" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Pascal Grange</span></a></div><small class="authorTitle_nd0D" title="Senior Software Engineer">Senior Software Engineer</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2>
<p>Superseded by <a href="/head-protocol/adr/32">ADR 32</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2>
<p>The current Head cluster is very fragile as has been observed on several occasions: A single hiccup in the connectivity between nodes while a head is open and nodes are exchanging messages can very easily lead to the Head being stuck and require an emergency closing, possibly even manually.</p>
<p>We want Hydra to be <em>Consistent</em> in the presence of <em>Network Partitions</em>, under the <em>fail-recovery</em> model assumption, eg. processes may fail by stopping and later recovering. Our system lies in the <a href="https://en.wikipedia.org/wiki/CAP_theorem" target="_blank" rel="noopener noreferrer">CP</a> space of the landscape mapped by the CAP theorem.</p>
<p>We have identified 3 main sources of failures in the <em>fail-recovery</em> model that can lead to a head being stuck:</p>
<ol>
<li>The network layer can drop messages from the moment a node <code>broadcast</code>s it, leading to some messages not being received at the other end</li>
<li>The sending node can crash in between the moment the state is changed (and persisted) and the moment a message is actually sent through the network (or even when it calls <code>broadcast</code>)</li>
<li>The receiving node can crash in between the moment the message has been received in the network layer, and it&#x27;s processed (goes through the queue)</li>
</ol>
<p>We agree that we&#x27;ll want to address all those issues in order to provide a good user experience, as not addressing 2. and 3. can lead to hard to troubleshoot issues with heads. We have not experienced those issues yet as they would probably only crop up under heavy loads, or in the wild. But we also agree we want to tackle 1. first because it&#x27;s where most of the risk lies. By providing a <em>Reliable Broadcast</em> layer, we will significantly reduce the risks and can then later on address the other points.</p>
<p>Therefore, the scope of this ADR is to address only point 1. above: Ensure broadcast messages are eventually received by all peers, given the sender does not stop before.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="discussion">Discussion<a href="#discussion" class="hash-link" aria-label="Direct link to Discussion" title="Direct link to Discussion">​</a></h3>
<ul>
<li>We are currently using the <a href="https://github.com/input-output-hk/ouroboros-network" target="_blank" rel="noopener noreferrer">ouroboros-framework</a> and <a href="https://github.com/input-output-hk/typed-protocols" target="_blank" rel="noopener noreferrer">typed-protocols</a> network stack as a mere <a href="https://osi-model.com/transport-layer/" target="_blank" rel="noopener noreferrer">transport</a> layer.<!-- -->
<ul>
<li>Being built on top of TCP, ouroboros multiplexer (Mux) provides the same reliability guarantees, plus the multiplexing capabilities of course</li>
<li>It also takes care of reconnecting to peers when a failure is detected which relieves us from doing so, but any reconnection implies a reset of each peer&#x27;s state machine which means we need to make sure any change to the state of pending/received messages is handled by the applicative layer</li>
<li>Our <a href="https://github.com/cardano-scaling/hydra/blob/8a8e0829964132bde8949e5249a1ab303af92fb8/hydra-node/src/Hydra/Network/Ouroboros/Type.hs#L31" target="_blank" rel="noopener noreferrer">FireForget protocol</a> ignores connections/disconnections</li>
<li>Ouroboros/typed-protocols provides enough machinery to implement a reliable broadcast protocol, for example by reusing existing <code>[KeepAlive](https://github.com/input-output-hk/ouroboros-network/tree/master/ouroboros-network-protocols/src/Ouroboros/Network/Protocol/KeepAlive)</code> protocol and building a more robust point-to-point protocol than what we have now</li>
<li>There is a minor limitation, namely that the subscription mechanism does not handle connections individually, but as a set of equivalent point-to-point full duplex connections whose size (valency) needs to be maintained at a certain threshold, which means that unless backed in the protocol itself, protocol state-machine and applications are not aware of the identity of the remote peer</li>
</ul>
</li>
<li>We have built our <code>Network</code> infrastructure over the concept of relatively independent layers, each implementing a similar interface with different kind of messages, to <code>broadcast</code> messages to all peers and be notified of incoming messages through a <code>callback</code>.<!-- -->
<ul>
<li>
<p>This pipes-like abstraction allows us to compose our network stack like:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> withAuthentication (contramap Authentication tracer) signingKey otherParties $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  withHeartbeat nodeId connectionMessages $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    withOuroborosNetwork (contramap Network tracer) localhost peers</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>This has the nice property that we can basically swap the lower layers should we need to, for example to use <a href="https://github.com/cardano-scaling/hydra/blob/abailly-iohk/multi-node-udp/hydra-node/src/Hydra/Network/UDP.hs" target="_blank" rel="noopener noreferrer">UDP</a>, or add other layers for example to address specific head instances in presence of <a href="https://github.com/cardano-scaling/hydra/blob/abailly-iohk/multi-node-udp/hydra-node/src/Hydra/Network/MultiHead.hs#L26" target="_blank" rel="noopener noreferrer">multiple heads</a></p>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2>
<ul>
<li>We implement our own message tracking and resending logic as a standalone <code>Network</code> layer</li>
<li>That layer consumes and produces <code>Authenticated msg</code> messages as it relies on identifying the source of messages</li>
<li>It uses a vector of monotonically increasing <em>sequence numbers</em> associated with each party (including itself) to track what are the last messages from each party and to ensure FIFO delivery of messages<!-- -->
<ul>
<li>This <em>vector</em> is used to identify peers which are lagging behind, resend the missing messages, or to drop messages which have already been received</li>
<li>The <em>Heartbeat</em> mechanism is relied upon to ensure dissemination of state even when the node is quiescent</li>
</ul>
</li>
<li>We do not implement a <em>pull-based</em> message communication mechanism as initially envisioned</li>
<li>We do not persist messages either on the receiving or sending side at this time</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2>
<ul>
<li>We keep our existing <code>Network</code> interface hence all messages will be resent to all peers<!-- -->
<ul>
<li>This could be later optimized either by providing a smarter interface with a <code>send :: Peer -&gt; msg -&gt; m ()</code> unicast function, or by adding a layer with filtering capabilities, or both</li>
</ul>
</li>
<li>We want to specify this protocol clearly in order to ease implementation in other languages, detailing the structure of messages and the semantics of retries and timeouts.</li>
<li>We may consider relying on the vector clock in the future to ensure perfect ordering of messages on each peer and make impossible for legit transactions to be temporarily seen as invalid. This can happen in the current version and is handled through wait and <em>TTL</em></li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/head-protocol/adr/tags/superseded">Superseded</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/head-protocol/adr/26"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">26. Stateless transaction observation &amp; construction
</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/head-protocol/adr/28"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">28. Offline mode
</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#status" class="table-of-contents__link toc-highlight">Status</a></li><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a><ul><li><a href="#discussion" class="table-of-contents__link toc-highlight">Discussion</a></li></ul></li><li><a href="#decision" class="table-of-contents__link toc-highlight">Decision</a></li><li><a href="#consequences" class="table-of-contents__link toc-highlight">Consequences</a></li></ul></div></div></div></div></div><footer class="laptop:footer bg-white py-[56px]"><div class="flex justify-between flex-col-reverse laptop:flex-row w-full px-6 tablet:px-12 laptop:justify-normal laptop:gap-20"><div class="basis-1/6"><div class="flex flex-col gap-4 border border-solid border-primary-light p-6 rounded-lg mb-14 laptop:mb-[70px] w-[250px]"><div class="inline-flex items-center text-primary-light"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 29 29" fill="none" class="shrink-0"><path d="M20.9294 16.3976C20.9294 16.3976 20.9358 15.3266 20.3616 14.1253C19.0297 11.3398 14.9511 6.74717 2.44965 8.86911L0 13.0703L2.54633 15.0556C4.06401 14.4519 14.2443 8.67912 20.9294 16.3974V16.3976ZM4.08846 10.8233L3.24446 12.1819L1.88586 11.3379L4.08846 10.8233Z" fill="currentColor"></path><path d="M20.5776 20.3707C20.4668 19.713 19.3421 17.1372 16.296 15.7499C13.2916 14.3817 8.6545 14.2215 2.01156 18.1487L1.30078 22.5083L4.03963 23.745C4.03963 23.745 12.8396 14.251 20.5778 20.3704L20.5776 20.3707ZM3.72907 20.8007L2.16445 20.4564L4.07336 19.2358L3.72935 20.8004L3.72907 20.8007Z" fill="currentColor"></path><path d="M24.8502 4.43443C23.7434 3.24952 22.3305 2.38107 20.8536 1.74477L22.5703 0H12.2523L5.80469 2.91929L7.20152 5.91558C16.105 5.48023 22.8094 9.08584 23.1751 15.9556C23.5638 23.2615 16.3385 27.8964 9.38191 26.5819C7.07645 26.1462 5.89041 25.6401 5.89041 25.6401C7.46317 27.0198 10.67 28.7297 14.5114 28.7789C22.2549 28.8775 28.6281 22.5603 28.7751 14.6779C28.8495 10.6999 27.3408 7.08194 24.8496 4.43472L24.8502 4.43443ZM12.2526 3.01822L10.9311 1.69671H13.5741L12.2526 3.01822Z" fill="currentColor"></path></svg><span class="border-l pl-4 ml-4 text-xl leading-[27px]">Join the family</span></div><a class="px-4 py-3 justify-center text-center border text-sm border-solid bg-primary-lightest border-primary font-bold text-primary rounded-lg no-underline hover:bg-white hover:no-underline hover:text-primary" href="/head-protocol/docs/get-involved">Get involved</a></div><div class="text-primary-light inline-flex gap-4 text-center"><svg xmlns="http://www.w3.org/2000/svg" width="29" height="29" viewBox="0 0 29 29" fill="none"><path d="M20.9294 16.3976C20.9294 16.3976 20.9358 15.3266 20.3616 14.1253C19.0297 11.3398 14.9511 6.74717 2.44965 8.86911L0 13.0703L2.54633 15.0556C4.06401 14.4519 14.2443 8.67912 20.9294 16.3974V16.3976ZM4.08846 10.8233L3.24446 12.1819L1.88586 11.3379L4.08846 10.8233Z" fill="currentColor"></path><path d="M20.5776 20.3707C20.4668 19.713 19.3421 17.1372 16.296 15.7499C13.2916 14.3817 8.6545 14.2215 2.01156 18.1487L1.30078 22.5083L4.03963 23.745C4.03963 23.745 12.8396 14.251 20.5778 20.3704L20.5776 20.3707ZM3.72907 20.8007L2.16445 20.4564L4.07336 19.2358L3.72935 20.8004L3.72907 20.8007Z" fill="currentColor"></path><path d="M24.8502 4.43443C23.7434 3.24952 22.3305 2.38107 20.8536 1.74477L22.5703 0H12.2523L5.80469 2.91929L7.20152 5.91558C16.105 5.48023 22.8094 9.08584 23.1751 15.9556C23.5638 23.2615 16.3385 27.8964 9.38191 26.5819C7.07645 26.1462 5.89041 25.6401 5.89041 25.6401C7.46317 27.0198 10.67 28.7297 14.5114 28.7789C22.2549 28.8775 28.6281 22.5603 28.7751 14.6779C28.8495 10.6999 27.3408 7.08194 24.8496 4.43472L24.8502 4.43443ZM12.2526 3.01822L10.9311 1.69671H13.5741L12.2526 3.01822Z" fill="currentColor"></path></svg><span class="mt-0.5">© 2025</span></div></div><div class="grid gap-10 pb-10 max-w-md tablet:flex tablet:max-w-full laptop:pb-0 laptop:gap-7 basis-5/6 laptop:max-w-full"><div class="tablet:col basis-1/4"><div class="footer__title text-sm pb-1 laptop:pb-5 text-black">Contributing</div><ul class="footer__items clean-list space-y-2"><li class="footer__item"><a href="https://github.com/cardano-scaling/hydra/wiki/Coding-Standards" target="_blank" rel="noopener noreferrer" class="footer__link-item inline-flex hover:text-primary-light text-black">Coding standards</a></li><li class="footer__item"><a class="footer__link-item inline-flex hover:text-primary-light text-black" href="/head-protocol/adr">Architecture Decision Records</a></li><li class="footer__item"><a href="https://github.com/cardano-scaling/hydra/wiki/Testing-Strategy" target="_blank" rel="noopener noreferrer" class="footer__link-item inline-flex hover:text-primary-light text-black">Testing strategy</a></li></ul></div><div class="tablet:col basis-1/4"><div class="footer__title text-sm pb-1 laptop:pb-5 text-black">Community</div><ul class="footer__items clean-list space-y-2"><li class="footer__item"><a href="https://discord.gg/Qq5vNTg9PT" target="_blank" rel="noopener noreferrer" class="footer__link-item inline-flex hover:text-primary-light text-black">Discord</a></li><li class="footer__item"><a href="https://github.com/cardano-scaling/hydra/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item inline-flex hover:text-primary-light text-black">GitHub discussions</a></li><li class="footer__item"><a href="https://cardano.stackexchange.com/questions/tagged/hydra" target="_blank" rel="noopener noreferrer" class="footer__link-item inline-flex hover:text-primary-light text-black">Stack Exchange</a></li></ul></div><div class="tablet:col basis-1/4"><div class="footer__title text-sm pb-1 laptop:pb-5 text-black">More</div><ul class="footer__items clean-list space-y-2"><li class="footer__item"><a class="footer__link-item inline-flex hover:text-primary-light text-black" href="/head-protocol/docs/dev/haskell-packages">Haskell packages</a></li><li class="footer__item"><a href="https://cardano-scaling.github.io/website/monthly" target="_blank" rel="noopener noreferrer" class="footer__link-item inline-flex hover:text-primary-light text-black">Monthly reports</a></li><li class="footer__item"><a href="https://github.com/cardano-scaling/hydra/wiki/Logbook" target="_blank" rel="noopener noreferrer" class="footer__link-item inline-flex hover:text-primary-light text-black">Logbook</a></li></ul></div><div class="tablet:col basis-1/4"><div class="footer__title text-sm pb-1 laptop:pb-5 text-black">Legal</div><ul class="footer__items clean-list space-y-2"><li class="footer__item"><a href="https://static.iohk.io/terms/iog-terms-and-conditions.pdf" target="_blank" rel="noopener noreferrer" class="footer__link-item inline-flex hover:text-primary-light text-black">Terms and conditions</a></li><li class="footer__item"><a href="https://static.iohk.io/terms/iog-privacy-policy.pdf" target="_blank" rel="noopener noreferrer" class="footer__link-item inline-flex hover:text-primary-light text-black">Privacy policy</a></li><li class="footer__item"><a href="https://github.com/cardano-scaling/hydra/graphs/contributors" target="_blank" rel="noopener noreferrer" class="footer__link-item inline-flex hover:text-primary-light text-black">Contributors</a></li></ul></div></div></div></footer></div>
</body>
</html>