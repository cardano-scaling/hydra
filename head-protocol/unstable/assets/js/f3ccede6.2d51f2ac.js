"use strict";(self.webpackChunkhydra_head_protocol_docs=self.webpackChunkhydra_head_protocol_docs||[]).push([[830],{22499:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>h,default:()=>m,frontMatter:()=>c,metadata:()=>o,toc:()=>p});const o=JSON.parse('{"id":"how-to/operating-hydra","title":"Operate a Hydra node","description":"This page guides Hydra users on troubleshooting issues when running their instances of hydra-node and participating in a Hydra head.","source":"@site/docs/how-to/operating-hydra.md","sourceDirName":"how-to","slug":"/how-to/operating-hydra","permalink":"/head-protocol/unstable/docs/how-to/operating-hydra","draft":false,"unlisted":false,"editUrl":"https://github.com/cardano-scaling/hydra/tree/master/docs/docs/how-to/operating-hydra.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"userDocumentation","previous":{"title":"Decommit funds","permalink":"/head-protocol/unstable/docs/how-to/incremental-decommit"},"next":{"title":"Sideload Snapshot","permalink":"/head-protocol/unstable/docs/how-to/sideload-snapshot"}}');var s=t(74848),i=t(28453),r=(t(96540),t(33745));const a={terminalWindow:"terminalWindow_wGrl",terminalWindowHeader:"terminalWindowHeader_o9Cs",terminalWindowBody:"terminalWindowBody_tzdS",row:"row_Rn7G",buttons:"buttons_IGLB",right:"right_fWp9",dot:"dot_fGZE"};function d(e){let{children:n,minHeight:t}=e;const o="string"==typeof n?(0,s.jsx)(r.A,{children:n}):n;return(0,s.jsxs)("div",{className:a.terminalWindow,style:{minHeight:t},children:[(0,s.jsx)("div",{className:a.terminalWindowHeader,children:(0,s.jsxs)("div",{className:a.buttons,children:[(0,s.jsx)("span",{className:a.dot,style:{background:"#f25f58"}}),(0,s.jsx)("span",{className:a.dot,style:{background:"#fbbe3c"}}),(0,s.jsx)("span",{className:a.dot,style:{background:"#58cb42"}})]})}),(0,s.jsx)("div",{className:a.terminalWindowBody,children:o})]})}const c={sidebar_position:6},h="Operate a Hydra node",l={},p=[{value:"Example setup",id:"example-setup",level:2},{value:"Google Cloud with Terraform",id:"google-cloud-with-terraform",level:3},{value:"Logs",id:"logs",level:2},{value:"Monitoring",id:"monitoring",level:2},{value:"Common issues",id:"common-issues",level:2},{value:"No head is observed from the chain",id:"no-head-is-observed-from-the-chain",level:3},{value:"Head does not make progress",id:"head-does-not-make-progress",level:3},{value:"Head Stuck: Peer Out of Sync",id:"head-stuck-peer-out-of-sync",level:3},{value:"Run the Node on High Availability Using Mirror Nodes",id:"run-the-node-on-high-availability-using-mirror-nodes",level:3}];function u(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"operate-a-hydra-node",children:"Operate a Hydra node"})}),"\n","\n",(0,s.jsxs)(n.p,{children:["This page guides Hydra users on troubleshooting issues when running their instances of ",(0,s.jsx)(n.code,{children:"hydra-node"})," and participating in a Hydra head."]}),"\n",(0,s.jsx)(n.h2,{id:"example-setup",children:"Example setup"}),"\n",(0,s.jsxs)(n.p,{children:["We offer sample node configurations that will help you get started with hosting a Hydra node on virtual machines in the cloud. These configurations are available in the ",(0,s.jsxs)(n.a,{href:"https://github.com/cardano-scaling/hydra/tree/master/sample-node-config/",children:[(0,s.jsx)(n.code,{children:"sample-node-config/"})," directory"]}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"google-cloud-with-terraform",children:"Google Cloud with Terraform"}),"\n",(0,s.jsxs)(n.p,{children:["This setup includes a ",(0,s.jsx)(n.a,{href:"https://github.com/cardano-scaling/hydra/blob/master/sample-node-config/gcp/docker-compose.yaml",children:"docker-compose.yaml"})," file, which serves as a robust template for configuring ",(0,s.jsx)(n.code,{children:"cardano-node"})," and ",(0,s.jsx)(n.code,{children:"hydra-node"})," services. Also, various scripts are provided to help you set up your cluster."]}),"\n",(0,s.jsx)(n.h2,{id:"logs",children:"Logs"}),"\n",(0,s.jsxs)(n.p,{children:["Following the principles outlined in ",(0,s.jsx)(n.a,{href:"/adr/9",children:"ADR-9"}),", the ",(0,s.jsx)(n.code,{children:"hydra-node"})," emits ",(0,s.jsx)(n.a,{href:"https://json.org",children:"JSON"})," formatted logs to the ",(0,s.jsx)(n.code,{children:"stdout"})," stream, with one log item per line."]}),"\n",(0,s.jsx)(n.h2,{id:"monitoring",children:"Monitoring"}),"\n",(0,s.jsxs)(n.p,{children:["When the ",(0,s.jsx)(n.code,{children:"--monitoring-port PORT"})," argument is provided, the ",(0,s.jsx)(n.code,{children:"hydra-node"})," executable will expose a ",(0,s.jsx)(n.a,{href:"https://prometheus.io",children:"Prometheus"})," compatible HTTP ",(0,s.jsx)(n.code,{children:"/metrics"})," endpoint on the specified port to enable metrics scraping."]}),"\n",(0,s.jsxs)(n.p,{children:["For instance, if a ",(0,s.jsx)(n.code,{children:"hydra-node"})," is initiated with ",(0,s.jsx)(n.code,{children:"--monitoring-port 6001"}),", the following command:"]}),"\n",(0,s.jsx)(d,{children:(0,s.jsxs)(n.p,{children:["curl ",(0,s.jsx)(n.a,{href:"http://localhost:6001/metrics",children:"http://localhost:6001/metrics"})]})}),"\n",(0,s.jsx)(n.p,{children:"will output:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'# TYPE hydra_head_confirmed_tx counter\nhydra_head_confirmed_tx  0\n# TYPE hydra_head_inputs counter\nhydra_head_inputs  50467\n# TYPE hydra_head_peers_connected gauge\nhydra_head_peers_connected  0.0\n# TYPE hydra_head_requested_tx counter\nhydra_head_requested_tx  0\n# TYPE hydra_head_tx_confirmation_time_ms histogram\nhydra_head_tx_confirmation_time_ms_bucket{le="5.0"} 0.0\nhydra_head_tx_confirmation_time_ms_bucket{le="10.0"} 0.0\nhydra_head_tx_confirmation_time_ms_bucket{le="50.0"} 0.0\nhydra_head_tx_confirmation_time_ms_bucket{le="100.0"} 0.0\nhydra_head_tx_confirmation_time_ms_bucket{le="1000.0"} 0.0\nhydra_head_tx_confirmation_time_ms_bucket{le="+Inf"} 0.0\nhydra_head_tx_confirmation_time_ms_sum  0.0\nhydra_head_tx_confirmation_time_ms_count  0\n'})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["[!NOTE]\nNote that ",(0,s.jsx)(n.code,{children:"hydra_head_peers_connected"})," will count down if the number of\nonline peers is greater than ",(0,s.jsx)(n.code,{children:"total_peers/2"}),". After that, if another peer\ngoes offline, it will drop to ",(0,s.jsx)(n.code,{children:"0"}),", to indicate that etcd consensus is\nbroken."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"common-issues",children:"Common issues"}),"\n",(0,s.jsx)(n.h3,{id:"no-head-is-observed-from-the-chain",children:"No head is observed from the chain"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Ensure the ",(0,s.jsx)(n.code,{children:"hydra-node"})," is connected to a ",(0,s.jsx)(n.code,{children:"cardano-node"})," operating on the correct network. Verify the ",(0,s.jsx)(n.code,{children:"--network"})," command-line argument and the ",(0,s.jsx)(n.code,{children:"cardano-node"})," configuration."]}),"\n",(0,s.jsxs)(n.li,{children:["Remember, the ",(0,s.jsx)(n.code,{children:"hydra-node"})," cannot start if it cannot connect to the ",(0,s.jsx)(n.code,{children:"cardano-node"}),", which might require time as the ",(0,s.jsx)(n.code,{children:"cardano-node"})," must revalidate its database and potentially reconstruct its ledger state upon startup. Its connections are not open until it is fully prepared. If running as a service or a container, ensure that the orchestrator restarts the process when it crashes."]}),"\n",(0,s.jsxs)(n.li,{children:["Check that the ",(0,s.jsx)(n.em,{children:"Scripts"})," transaction identifier is valid. This identifier is provided on the ",(0,s.jsx)(n.a,{href:"https://github.com/cardano-scaling/hydra/releases/tag/0.10.0",children:"release"})," page for the three major networks (",(0,s.jsx)(n.code,{children:"preview"}),", ",(0,s.jsx)(n.code,{children:"pre-production"}),", ",(0,s.jsx)(n.code,{children:"mainnet"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["Verify that the ",(0,s.jsx)(n.code,{children:"hydra-node"}),"'s ",(0,s.jsx)(n.em,{children:"Cardano signing key"})," is consistent with the ",(0,s.jsx)(n.em,{children:"Verification key"})," from the ",(0,s.jsx)(n.code,{children:"Init"})," transaction. Ensure the ",(0,s.jsx)(n.code,{children:"--cardano-signing-key"})," parameter points to the correct key, and that peers have the accurate ",(0,s.jsx)(n.code,{children:"--cardano-verification-key"})," for your node."]}),"\n",(0,s.jsxs)(n.li,{children:["Confirm that peers' ",(0,s.jsx)(n.em,{children:"Cardano verification keys"})," are accurate. This mirrors the above issue; check parameters on all peers."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"head-does-not-make-progress",children:"Head does not make progress"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Confirm peers are properly connected to each other. Verify the ",(0,s.jsx)(n.code,{children:"--peer"})," arguments point to the correct ",(0,s.jsx)(n.code,{children:"host:port"})," for each peer. The ",(0,s.jsx)(n.code,{children:"PeerConnected"})," message should be observed by the client or appear in the logs and be consistent across all peers involved in a head."]}),"\n",(0,s.jsxs)(n.li,{children:["Ensure the ",(0,s.jsx)(n.em,{children:"Hydra signing key"})," for your node or the ",(0,s.jsx)(n.em,{children:"Hydra verification keys"})," for peers match each node's expectations. Verify that ",(0,s.jsx)(n.code,{children:"AckSn"})," messages are received by all parties and that the ",(0,s.jsx)(n.code,{children:"LogicOutcome"})," log contains no errors."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"head-stuck-peer-out-of-sync",children:"Head Stuck: Peer Out of Sync"}),"\n",(0,s.jsx)(n.p,{children:"Processing transactions in a Hydra head requires each node to agree on transactions, which occurs when they sign a snapshot during the AckSn phase. The protocol validates transactions (on the NewTx command) against its local view of the ledger state, using the provided --ledger-protocol-parameters. Since transaction validity depends on configuration (and, to some extent, the exact build versions of hydra-node), one node may accept a transaction while its peers reject it."}),"\n",(0,s.jsx)(n.p,{children:"When this happens, the accepting node's local state diverges from the rest, potentially leading to attempts to spend outputs that other nodes do not recognize as available."}),"\n",(0,s.jsxs)(n.p,{children:["This issue can also arise if a peer goes offline while a transaction is submitted, potentially causing the Hydra head to become stuck and preventing further snapshots from being signed (",(0,s.jsx)(n.a,{href:"https://github.com/cardano-scaling/hydra/pull/1780",children:"see test case"}),")."]}),"\n",(0,s.jsx)(n.p,{children:"As a result of this divergence, the local ledger state of each Hydra node essentially becomes forked, resulting in inconsistent states across the network. While it is technically still possible to submit transactions to the Hydra nodes, doing so is ineffective because snapshots do not update unless all nodes sign them. Each node starts accepting transactions based on entirely different states, leading to disagreement on which UTxOs have been spent."}),"\n",(0,s.jsx)(n.p,{children:"To recover from this issue, we introduced side-loading of snapshots to synchronize the local ledger state of the Hydra nodes. With this mechanism, every peer reverts to the latest confirmed snapshot. This can be done by using latest snapshot confirmed from GET /snapshot to call the POST /snapshot endpoint, which clears the peer\u2019s local pending transactions and restores its state to match the last agreed snapshot, allowing the node to rejoin the consensus with the rest of the network."}),"\n",(0,s.jsx)(n.p,{children:"Newer confirmed snapshots can also be adopted if all party members use the POST /snapshot endpoint with the same ConfirmedSnapshot as the JSON body."}),"\n",(0,s.jsx)(n.p,{children:"It is important to note that this recovery process is a coordinated effort among peers to ensure the consistency and availability of the Hydra head."}),"\n",(0,s.jsx)(n.h3,{id:"run-the-node-on-high-availability-using-mirror-nodes",children:"Run the Node on High Availability Using Mirror Nodes"}),"\n",(0,s.jsxs)(n.p,{children:['If you are concerned about one of the nodes disappearing entirely; i.e. complete computer failure with no backup, then you might be interested in running "mirror nodes". While it is recommend that you would maintain backups of the ',(0,s.jsx)(n.code,{children:"persistence"})," folder (along with your keys!), you can choose to follow the mirror-node technique in any case as yet another measure to ensure operation in the disastrous loss of a peer. Note further that this technique increases availability, but has a cost in that it requires storing your key material in two places."]}),"\n",(0,s.jsx)(n.p,{children:"Ensuring high availability in a Hydra Head can be achieved by using mirror nodes, allowing the same party to participate from multiple machines."}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"This setup enhances redundancy and fault tolerance, ensuring protocol continuity even if a node fails, as another node can take over signing snapshots if one becomes unavailable."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["A mirror node operates with the same party credentials (Cardano and Hydra keys) as the original node, enabling it to sign L2 snapshots and perform L1 operations like ",(0,s.jsx)(n.code,{children:"Init"}),", ",(0,s.jsx)(n.code,{children:"Commit"}),", ",(0,s.jsx)(n.code,{children:"Close"}),", ",(0,s.jsx)(n.code,{children:"Contest"}),", ",(0,s.jsx)(n.code,{children:"FanOut"}),", and ",(0,s.jsx)(n.code,{children:"Increment/Decrement"})," funds from the head."]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Note, each node must be configured as follows:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["with a unique ",(0,s.jsx)(n.code,{children:"--node-id"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["with a unique ",(0,s.jsx)(n.code,{children:"--advertise"})," IP address, as they run on separate machines."]}),"\n",(0,s.jsxs)(n.li,{children:["specify each original and mirror node with its unique ",(0,s.jsx)(n.code,{children:"--peer"})," IP address being advertised."]}),"\n",(0,s.jsxs)(n.li,{children:["must not duplicate ",(0,s.jsx)(n.code,{children:"--cardano-verification-key"})," and ",(0,s.jsx)(n.code,{children:"--hydra-verification-key"}),", as these identify unique parties independently of their peer setup."]}),"\n",(0,s.jsxs)(n.li,{children:["mirror nodes must use the same ",(0,s.jsx)(n.code,{children:"--hydra-signing-key"})," and ",(0,s.jsx)(n.code,{children:"--cardano-signing-key"})," as their original counterpart."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Mirror nodes coexist alongside their original counterpart without conflict, although some duplication of Hydra network messages sent and received from the mirror is expected.\nOccasionally, operators might observe a ",(0,s.jsx)(n.code,{children:"SnapshotAlreadySigned"})," log, which is raised when both the mirror and the original party attempt to sign the same snapshot. This log is transient, harmless, and can be safely ignored."]}),"\n",(0,s.jsx)(n.p,{children:"Beyond the Hydra Head protocol, mirror nodes impact the underlying etcd cluster, which follows the Raft consensus protocol."}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["The cluster remains healthy only if a majority of nodes (",(0,s.jsx)(n.code,{children:"\u230an/2\u230b + 1"}),") are online."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"If too many nodes (including mirrors) go offline, the etcd cluster may become unresponsive, even if the Hydra protocol itself remains operational."}),"\n",(0,s.jsx)(n.p,{children:"For instance, in a cluster with 3 Alice nodes (2 mirrors) and 1 Bob node:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The Hydra Head protocol remains functional as long as all unique party keys are active."}),"\n",(0,s.jsx)(n.li,{children:"However, if 2 Alice nodes go down, the etcd cluster becomes unhealthy due to an insufficient active quorum."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["To maintain both Hydra network stability and a functional etcd quorum, the number of mirrors (",(0,s.jsx)(n.code,{children:"k"}),") should always be ",(0,s.jsxs)(n.strong,{children:["fewer than half of the total nodes (",(0,s.jsx)(n.code,{children:"n"}),")"]}),": ",(0,s.jsx)(n.code,{children:"k < \u230an/2\u230b"}),"."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"optimal-nbr-mirrors",src:t(59135).A+"",width:"1355",height:"947"})}),"\n",(0,s.jsx)(n.p,{children:"As you can see, the optimal number of mirrors in the cluster should be less than half of the total number of peers. This ensures the etcd cluster remains responsive and functional while still benefiting from high availability."})]})}function m(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},59135:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/optimal-nbr-mirrors-4e24931e52905e22a8110f92990accd6.png"}}]);