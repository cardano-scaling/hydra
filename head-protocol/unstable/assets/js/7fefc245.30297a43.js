"use strict";(self.webpackChunkhydra_head_protocol_docs=self.webpackChunkhydra_head_protocol_docs||[]).push([[3955],{63752:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>c,metadata:()=>o,toc:()=>r});const o=JSON.parse('{"id":"how-to/incremental-commit","title":"Commit funds to an open Head","description":"Assuming we already have an open Head and some funds on the L1 we would like to commit.","source":"@site/docs/how-to/incremental-commit.md","sourceDirName":"how-to","slug":"/how-to/incremental-commit","permalink":"/head-protocol/unstable/docs/how-to/incremental-commit","draft":false,"unlisted":false,"editUrl":"https://github.com/cardano-scaling/hydra/tree/master/docs/docs/how-to/incremental-commit.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"userDocumentation","previous":{"title":"Use withdraw zero trick","permalink":"/head-protocol/unstable/docs/how-to/withdraw-zero"},"next":{"title":"Decommit funds","permalink":"/head-protocol/unstable/docs/how-to/incremental-decommit"}}');var s=t(74848),i=t(28453);const c={sidebar_position:4},d="Commit funds to an open Head",a={},r=[{value:"Deposit UTxO to commit",id:"deposit-utxo-to-commit",level:3},{value:"Recover a deposit",id:"recover-a-deposit",level:3}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"commit-funds-to-an-open-head",children:"Commit funds to an open Head"})}),"\n",(0,s.jsx)(n.p,{children:"Assuming we already have an open Head and some funds on the L1 we would like to commit."}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["You could run a local ",(0,s.jsx)(n.a,{href:"./../getting-started",children:"demo"})]})}),"\n",(0,s.jsxs)(n.p,{children:["The following commands are expected to be run from the ",(0,s.jsx)(n.code,{children:"demo"})," folder and using these environment variables:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"export CARDANO_NODE_SOCKET_PATH=${PWD}/devnet/node.socket\nexport CARDANO_NODE_NETWORK_ID=42\n"})}),"\n",(0,s.jsx)(n.p,{children:"We can inspect the L1 utxo with:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"cardano-cli query utxo --whole-utxo\n"})}),"\n",(0,s.jsx)(n.p,{children:"and the state of the faucet public key"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"cardano-cli query utxo \\\n  --address $(cardano-cli address build --payment-verification-key-file ${PWD}/../hydra-cluster/config/credentials/faucet.vk)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In this setup, we would be using the ",(0,s.jsx)(n.code,{children:"faucet"})," keys to commit everything into the head."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"export WALLET_SK=${PWD}/../hydra-cluster/config/credentials/faucet.sk\nexport WALLET_VK=${PWD}/../hydra-cluster/config/credentials/faucet.vk\n"})}),"\n",(0,s.jsx)(n.h3,{id:"deposit-utxo-to-commit",children:"Deposit UTxO to commit"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"/commit"})," endpoint supports two ways of specifying what to commit, one is just by showing the UTxO (which is assumed to be owned by public keys), while the more advanced way would be using ",(0,s.jsx)(n.a,{href:"./commit-blueprint",children:"blueprint transactions"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["We are using the simple request here and want to commit everything owned by ",(0,s.jsx)(n.code,{children:"${WALLET_SK}"}),". So we can just query the L1 for all UTxO owned by it:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"cardano-cli query utxo \\\n  --address $(cardano-cli address build --payment-verification-key-file ${WALLET_VK}) \\\n  --out-file commit-utxo.json\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Then a request to the ",(0,s.jsx)(n.code,{children:"/commit"})," endpoint provides us with a transaction:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"curl -X POST localhost:4001/commit \\\n  --data @commit-utxo.json \\\n  > deposit-tx.json\n"})}),"\n",(0,s.jsx)(n.p,{children:"Which we can submit to the cardano network:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"cardano-cli conway transaction sign \\\n  --tx-file deposit-tx.json \\\n  --signing-key-file ${WALLET_SK} \\\n  --out-file deposit-tx.signed.json\n\ncardano-cli conway transaction submit \\\n  --tx-file deposit-tx.signed.json\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This will result in a deposit being detected by the ",(0,s.jsx)(n.code,{children:"hydra-node"})," and consequently the funds to be committed to the head."]}),"\n",(0,s.jsx)(n.h3,{id:"recover-a-deposit",children:"Recover a deposit"}),"\n",(0,s.jsxs)(n.p,{children:["Do the same thing as above, ",(0,s.jsx)(n.strong,{children:"but"})," with one node stopped, so the deposit is not going to be picked up."]}),"\n",(0,s.jsx)(n.p,{children:"Once we deposited funds we should not see the corresponding UTxO belonging to faucet public key on L1:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"\ncardano-cli query utxo \\\n  --address $(cardano-cli address build --payment-verification-key-file ${PWD}/../hydra-cluster/config/credentials/faucet.vk)\n"})}),"\n",(0,s.jsx)(n.p,{children:"Inspect the pending deposits:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"curl -X GET localhost:4001/commits\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:["and you should see the tx-id of the deposit transaction ",(0,s.jsx)(n.code,{children:'["6b51f3787f5482004b258c60fe0c94775164f547d9284b6233bbb4f6f8b9dfa6"]'})]}),"\n",(0,s.jsxs)(n.p,{children:["To recover, we can use the ",(0,s.jsx)(n.code,{children:"/commits"})," endpoint again using the transaction id of the deposit:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:'curl -X DELETE localhost:4001/commits/$(printf "\\"6b51f3787f5482004b258c60fe0c94775164f547d9284b6233bbb4f6f8b9dfa6"\\" | jq -sRr \'@uri\')\n'})}),"\n",(0,s.jsx)(n.p,{children:"If we inspect the faucet funds again we will see that the locked deposit is now recovered"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"cardano-cli query utxo \\\n  --address $(cardano-cli address build --payment-verification-key-file ${PWD}/../hydra-cluster/config/credentials/faucet.vk)\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>d});var o=t(96540);const s={},i=o.createContext(s);function c(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);