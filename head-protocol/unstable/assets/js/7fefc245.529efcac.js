"use strict";(self.webpackChunkhydra_head_protocol_docs=self.webpackChunkhydra_head_protocol_docs||[]).push([[3955],{63752:(e,d,n)=>{n.r(d),n.d(d,{assets:()=>o,contentTitle:()=>s,default:()=>r,frontMatter:()=>t,metadata:()=>c,toc:()=>i});const c=JSON.parse('{"id":"how-to/incremental-commit","title":"Deposit funds to an open Head","description":"Assuming we already have an open Head and some funds on the L1 we would like to deposit.","source":"@site/docs/how-to/incremental-commit.md","sourceDirName":"how-to","slug":"/how-to/incremental-commit","permalink":"/head-protocol/unstable/docs/how-to/incremental-commit","draft":false,"unlisted":false,"editUrl":"https://github.com/cardano-scaling/hydra/tree/master/docs/docs/how-to/incremental-commit.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"userDocumentation","previous":{"title":"Use withdraw zero trick","permalink":"/head-protocol/unstable/docs/how-to/withdraw-zero"},"next":{"title":"Decommit funds","permalink":"/head-protocol/unstable/docs/how-to/incremental-decommit"}}');var a=n(74848),b=n(28453);const t={sidebar_position:5},s="Deposit funds to an open Head",o={},i=[{value:"Recover a deposit",id:"recover-a-deposit",level:3}];function f(e){const d={admonition:"admonition",code:"code",em:"em",h1:"h1",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,b.R)(),...e.components},{Details:n}=d;return n||function(e,d){throw new Error("Expected "+(d?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(d.header,{children:(0,a.jsx)(d.h1,{id:"deposit-funds-to-an-open-head",children:"Deposit funds to an open Head"})}),"\n",(0,a.jsx)(d.p,{children:"Assuming we already have an open Head and some funds on the L1 we would like to deposit."}),"\n",(0,a.jsxs)(d.p,{children:["The ",(0,a.jsx)(d.code,{children:"/commit"})," endpoint supports two ways of specifying what to deposit, one is just by showing the UTxO (which is assumed to be owned by public keys), while the more advanced way would be using ",(0,a.jsx)(d.em,{children:"blueprint"})," transaction as a recipe on what to deposit."]}),"\n",(0,a.jsx)(d.p,{children:"Blueprint transactions work differently in deposits (incremental commits) compared to commits (committing before the Head is in the open state)."}),"\n",(0,a.jsxs)(d.p,{children:["When it comes to ",(0,a.jsx)(d.strong,{children:"depositing"})," our users have four ways of using the blueprint transaction so it should work for even more involved scenarios:"]}),"\n",(0,a.jsxs)(d.ol,{children:["\n",(0,a.jsx)(d.li,{children:"Only provide the UTxO to deposit - simple deposit where whole of the UTxO is deposited to the Head."}),"\n",(0,a.jsxs)(d.li,{children:["Provide UTxO and a bluerprint transaction ",(0,a.jsx)(d.strong,{children:"without"})," any outputs - whole of the UTxO will be deposited but users get to specify additional transaction context\nneeded for dApps."]}),"\n",(0,a.jsxs)(d.li,{children:["Provide UTxO, blueprint transaction ",(0,a.jsx)(d.strong,{children:"with"})," specified outputs but ",(0,a.jsx)(d.strong,{children:"NO"})," change address is provided - In this case we expect to see fully balanced blueprint transaction where it's outputs will be deposited completely."]}),"\n",(0,a.jsxs)(d.li,{children:["Provide UTxO, blueprint transaction ",(0,a.jsx)(d.strong,{children:"with"})," specified outputs ",(0,a.jsx)(d.strong,{children:"AND"})," a ",(0,a.jsx)(d.strong,{children:"change address"})," - hydra-node will ",(0,a.jsx)(d.strong,{children:"balance"})," the deposit transaction and give back any change to the provided change address. Provided outputs will be deposited."]}),"\n"]}),"\n",(0,a.jsx)(d.admonition,{type:"info",children:(0,a.jsx)(d.p,{children:"Hydra node assumes that the blueprint transaction does not contain any stake pool or DRep registration or delegation certificates since these don't make too much sense on L2 network."})}),"\n",(0,a.jsx)(d.p,{children:"The last option is most flexible one for dApp builders since they can just specify which UTxO assets they want to deposit (providing the appropriate outputs in the blueprint tx) while the hydra-node will make sure to return any change to the specified address. Using script UTxO as a reference inputs is also possible for optimising the dApp workflow."}),"\n",(0,a.jsxs)(n,{children:[(0,a.jsx)("summary",{children:"Partial deposit example: "}),(0,a.jsx)(d.p,{children:"If there exists a user UTxO that looks like this"}),(0,a.jsx)(d.pre,{children:(0,a.jsx)(d.code,{className:"language-json",children:'\n   {\n      "98ce7d553c87837735ce99d0452d6c78c14499a35a2ebe78a61653da422ba06b#0":\n         { "address":"addr_test1vznxtg0ljhlqghzr9sdw3stfffna97l6xuaradgdk8jnhegyza948",\n           "datum":null,\n           "datumhash":null,\n           "inlineDatum":null,\n           "inlineDatumRaw":null,\n           "referenceScript":null,\n           "value":\n               { "dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75":\n                    { "32":6459586778467727683,\n                      "38":4726846541838542289,\n                      "58cfd525f109":2,\n                      "60c477033b55e1":6560058562233977644,\n                      "768b8dfd46f4d5b14873b4c3851f2c82d0301f61661347":4661096764720222855,\n                      "ab5f4e6486d24ad6744e54f95dd1bc4dbbe721":3250906605877226653,\n                      "d47f9b":1,\n                      "d6cc1ed8ac3cda":2,\n                      "f26fe54468b98902751e8d54553c1878b5f952d486":1\n                    },\n                  "lovelace":30000000\n               }\n         }\n   }\n\n'})}),(0,a.jsxs)(d.p,{children:["Then the user can decide to commit some amount of lovelace and assets while the ",(0,a.jsx)(d.em,{children:"change"})," would be given back to the origin address.\nIn order to do that they can send a http POST request to the ",(0,a.jsx)(d.code,{children:"/commit"})," endpoint\nproviding the blueprint transaction with specified outputs, UTxO and a change address:"]}),(0,a.jsx)(d.pre,{children:(0,a.jsx)(d.code,{className:"language-json",children:'\n   {\n     "blueprintTx": {\n       "cborHex": "84a300d901028182582098ce7d553c87837735ce99d0452d6c78c14499a35a2ebe78a61653da422ba06b00018182581d60a665a1ff95fe045c432c1ae8c1694a67d2fbfa373a3eb50db1e53be5821a00e4e1c0a1581cdcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75a44658cfd525f109024760c477033b55e11b5b0a028173b74b2c53ab5f4e6486d24ad6744e54f95dd1bc4dbbe7211b2d1d8a5581486c9d55f26fe54468b98902751e8d54553c1878b5f952d486010200a0f5f6",\n       "description": "",\n       "txId": "8451c42d1a1b48fdb1b1d2b014dc700cbba15b3c20addb2076feeceeeb3d22a4",\n       "type": "Tx ConwayEra"\n     },\n     "changeAddress": "addr_test1vznxtg0ljhlqghzr9sdw3stfffna97l6xuaradgdk8jnhegyza948",\n     "utxo": {\n       "98ce7d553c87837735ce99d0452d6c78c14499a35a2ebe78a61653da422ba06b#0": {\n         "address": "addr_test1vznxtg0ljhlqghzr9sdw3stfffna97l6xuaradgdk8jnhegyza948",\n         "datum": null,\n         "datumhash": null,\n         "inlineDatum": null,\n         "inlineDatumRaw": null,\n         "referenceScript": null,\n         "value": {\n           "dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75": {\n             "32": 6459586778467727000,\n             "38": 4726846541838542000,\n             "58cfd525f109": 2,\n             "60c477033b55e1": 6560058562233978000,\n             "768b8dfd46f4d5b14873b4c3851f2c82d0301f61661347": 4661096764720223000,\n             "ab5f4e6486d24ad6744e54f95dd1bc4dbbe721": 3250906605877226500,\n             "d47f9b": 1,\n             "d6cc1ed8ac3cda": 2,\n             "f26fe54468b98902751e8d54553c1878b5f952d486": 1\n           },\n           "lovelace": 30000000\n         }\n       }\n     }\n   }\n\n'})}),(0,a.jsx)(d.p,{children:"In the provided blueprint tx we specified the outputs we want to deposit. Rendered blueprint tx looks like this:"}),(0,a.jsx)(d.pre,{children:(0,a.jsx)(d.code,{children:'"8451c42d1a1b48fdb1b1d2b014dc700cbba15b3c20addb2076feeceeeb3d22a4"\n\n  == INPUTS (1)\n  - 98ce7d553c87837735ce99d0452d6c78c14499a35a2ebe78a61653da422ba06b#0\n        ShelleyAddress Testnet (KeyHashObj (KeyHash {unKeyHash = "a665a1ff95fe045c432c1ae8c1694a67d2fbfa373a3eb50db1e53be5"})) StakeRefNull\n        30000000 lovelace\n        6459586778467727683 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.32\n        4726846541838542289 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.38\n        2 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.58cfd525f109\n        6560058562233977644 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.60c477033b55e1\n        4661096764720222855 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.768b8dfd46f4d5b14873b4c3851f2c82d0301f61661347\n        3250906605877226653 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.ab5f4e6486d24ad6744e54f95dd1bc4dbbe721\n        1 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.d47f9b\n        2 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.d6cc1ed8ac3cda\n        1 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.f26fe54468b98902751e8d54553c1878b5f952d486\n        TxOutDatumNone\n        ReferenceScriptNone\n\n  == COLLATERAL INPUTS (0)\n\n  == REFERENCE INPUTS (0)\n\n  == OUTPUTS (1)\n  Total number of assets: 5\n  - ShelleyAddress Testnet (KeyHashObj (KeyHash {unKeyHash = "a665a1ff95fe045c432c1ae8c1694a67d2fbfa373a3eb50db1e53be5"})) StakeRefNull\n        15000000 lovelace\n        2 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.58cfd525f109\n        6560058562233977644 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.60c477033b55e1\n        3250906605877226653 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.ab5f4e6486d24ad6744e54f95dd1bc4dbbe721\n        1 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.f26fe54468b98902751e8d54553c1878b5f952d486\n        TxOutDatumNone\n\n  == TOTAL COLLATERAL\n  TxTotalCollateralNone\n\n  == RETURN COLLATERAL\n  TxReturnCollateralNone\n\n  == FEE\n  TxFeeExplicit ShelleyBasedEraConway (Coin 0)\n\n  == VALIDITY\n  TxValidityNoLowerBound\n  TxValidityUpperBound ShelleyBasedEraConway Nothing\n\n  == MINT/BURN\n  0 lovelace\n\n  == SCRIPTS (0)\n  Total size (bytes):  0\n\n  == DATUMS (0)\n\n  == REDEEMERS (0)\n\n  == REQUIRED SIGNERS\n  []\n\n  == METADATA\n  TxMetadataNone\n\n'})}),(0,a.jsx)(d.p,{children:"You can see that the UTxO contains the following assets present in the blueprint input:"}),(0,a.jsx)(d.pre,{children:(0,a.jsx)(d.code,{children:"        30000000 lovelace\n        6459586778467727683 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.32\n        4726846541838542289 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.38\n        2 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.58cfd525f109\n        6560058562233977644 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.60c477033b55e1\n        4661096764720222855 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.768b8dfd46f4d5b14873b4c3851f2c82d0301f61661347\n        3250906605877226653 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.ab5f4e6486d24ad6744e54f95dd1bc4dbbe721\n        1 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.d47f9b\n        2 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.d6cc1ed8ac3cda\n        1 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.f26fe54468b98902751e8d54553c1878b5f952d486\n\n"})}),(0,a.jsx)(d.p,{children:"But we decided to deposit some of them which we specified in the single blueprint output:"}),(0,a.jsx)(d.pre,{children:(0,a.jsx)(d.code,{children:"\n        15000000 lovelace\n        2 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.58cfd525f109\n        6560058562233977644 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.60c477033b55e1\n        3250906605877226653 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.ab5f4e6486d24ad6744e54f95dd1bc4dbbe721\n        1 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.f26fe54468b98902751e8d54553c1878b5f952d486\n"})}),(0,a.jsx)(d.p,{children:"Hydra node returns a deposit transaction which then needs to be signed and submitted to the network. Deposit looks like this:"}),(0,a.jsx)(d.pre,{children:(0,a.jsx)(d.code,{children:'\n "ab4adce53699015ca8fd112689906338278f435d436516290c68c679921de8a4"\n\n == INPUTS (2)\n - 04e36b0eeb5d97be19e543583e3b736640b45ceaf5ece1d37f5db9ac88143f20#1\n - 98ce7d553c87837735ce99d0452d6c78c14499a35a2ebe78a61653da422ba06b#0\n       ShelleyAddress Testnet (KeyHashObj (KeyHash {unKeyHash = "a665a1ff95fe045c432c1ae8c1694a67d2fbfa373a3eb50db1e53be5"})) StakeRefNull\n       30000000 lovelace\n       6459586778467727683 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.32\n       4726846541838542289 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.38\n       2 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.58cfd525f109\n       6560058562233977644 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.60c477033b55e1\n       4661096764720222855 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.768b8dfd46f4d5b14873b4c3851f2c82d0301f61661347\n       3250906605877226653 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.ab5f4e6486d24ad6744e54f95dd1bc4dbbe721\n       1 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.d47f9b\n       2 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.d6cc1ed8ac3cda\n       1 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.f26fe54468b98902751e8d54553c1878b5f952d486\n       TxOutDatumNone\n       ReferenceScriptNone\n\n == COLLATERAL INPUTS (1)\n - 04e36b0eeb5d97be19e543583e3b736640b45ceaf5ece1d37f5db9ac88143f20#1\n\n == REFERENCE INPUTS (0)\n\n == OUTPUTS (3)\n Total number of assets: 10\n - ShelleyAddress Testnet (ScriptHashObj (ScriptHash "ae01dade3a9c346d5c93ae3ce339412b90a0b8f83f94ec6baa24e30c")) StakeRefNull\n       15000000 lovelace\n       2 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.58cfd525f109\n       6560058562233977644 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.60c477033b55e1\n       3250906605877226653 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.ab5f4e6486d24ad6744e54f95dd1bc4dbbe721\n       1 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.f26fe54468b98902751e8d54553c1878b5f952d486\n       TxOutDatumInline [0,["0xe9e21b6e4f59b3c62721c99109e76abb46e018e4fc184b16e58d650a",1759768581709,[[0,[[0,["0x8451c42d1a1b48fdb1b1d2b014dc700cbba15b3c20addb2076feeceeeb3d22a4",0]],"0xd8799fd8799fd8799f581ca665a1ff95fe045c432c1ae8c1694a67d2fbfa373a3eb50db1e53be5ffd87a80ffa240a1401a00e4e1c0581cdcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75a44658cfd525f109024760c477033b55e11b5b0a028173b74b2c53ab5f4e6486d24ad6744e54f95dd1bc4dbbe7211b2d1d8a5581486c9d55f26fe54468b98902751e8d54553c1878b5f9\n 52d48601d87980d87a80ff"]]]]]\n - ShelleyAddress Testnet (KeyHashObj (KeyHash {unKeyHash = "a665a1ff95fe045c432c1ae8c1694a67d2fbfa373a3eb50db1e53be5"})) StakeRefNull\n       15000000 lovelace\n       6459586778467727683 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.32\n       4726846541838542289 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.38\n       4661096764720222855 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.768b8dfd46f4d5b14873b4c3851f2c82d0301f61661347\n       1 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.d47f9b\n       2 dcf5fdd1d01c04b0e6262bba173a89c4b81b6570211f08bc059c8a75.d6cc1ed8ac3cda\n       TxOutDatumNone\n - ShelleyAddress Testnet (KeyHashObj (KeyHash {unKeyHash = "f8a68cd18e59a6ace848155a0e967af64f4d00cf8acee8adc95a6b0d"})) StakeRefNull\n       21583379 lovelace\n       TxOutDatumNone\n\n == TOTAL COLLATERAL\n TxTotalCollateralNone\n\n == RETURN COLLATERAL\n TxReturnCollateralNone\n\n == FEE\n TxFeeExplicit ShelleyBasedEraConway (Coin 203737)\n\n == VALIDITY\n TxValidityNoLowerBound\n TxValidityUpperBound ShelleyBasedEraConway (Just (SlotNo 37))\n\n == MINT/BURN\n 0 lovelace\n\n == SCRIPTS (0)\n Total size (bytes):  0\n\n == DATUMS (0)\n\n == REDEEMERS (0)\n\n == REQUIRED SIGNERS\n []\n\n == METADATA\n TxMetadataInEra ShelleyBasedEraConway (TxMetadata {unTxMetadata = fromList [(55555,TxMetaText "HydraV1/DepositTx")]})\n\n'})}),(0,a.jsx)(d.p,{children:"If you take a look at the outputs of this deposit tx you will see that we only locked specified ADA amount + tokens at the deposit address and gave back leftover ADA and assets the provided change address."})]}),"\n",(0,a.jsxs)(d.p,{children:["This will result in a deposit being detected by the ",(0,a.jsx)(d.code,{children:"hydra-node"})," and consequently the funds to be deposited to the Head."]}),"\n",(0,a.jsx)(d.h3,{id:"recover-a-deposit",children:"Recover a deposit"}),"\n",(0,a.jsx)(d.p,{children:"Once we deposited funds we should not see the corresponding UTxO on L1."}),"\n",(0,a.jsxs)(d.p,{children:["To inspect the pending deposits you can use ",(0,a.jsx)(d.code,{children:"curl"}),":"]}),"\n",(0,a.jsx)(d.pre,{children:(0,a.jsx)(d.code,{children:"curl -X GET localhost:4001/commits\n\n"})}),"\n",(0,a.jsxs)(d.p,{children:["You should see the tx-id of the deposit transaction in case it wasn't picked up by the hydra-node already. (e.g.",(0,a.jsx)(d.code,{children:'["ab4adce53699015ca8fd112689906338278f435d436516290c68c679921de8a4"]'})]}),"\n",(0,a.jsxs)(d.p,{children:["To recover, we can use the ",(0,a.jsx)(d.code,{children:"/commits"})," endpoint again using the transaction id of the deposit:"]}),"\n",(0,a.jsx)(d.pre,{children:(0,a.jsx)(d.code,{className:"language-shell",children:'curl -X DELETE localhost:4001/commits/$(printf "\\"ab4adce53699015ca8fd112689906338278f435d436516290c68c679921de8a4"\\" | jq -sRr \'@uri\')\n'})}),"\n",(0,a.jsx)(d.p,{children:"If we inspect the address funds again we will see that the locked deposit is now recovered. It is important to mention that recovering works even if the Head is closed already."})]})}function r(e={}){const{wrapper:d}={...(0,b.R)(),...e.components};return d?(0,a.jsx)(d,{...e,children:(0,a.jsx)(f,{...e})}):f(e)}},28453:(e,d,n)=>{n.d(d,{R:()=>t,x:()=>s});var c=n(96540);const a={},b=c.createContext(a);function t(e){const d=c.useContext(b);return c.useMemo((function(){return"function"==typeof e?e(d):{...d,...e}}),[d,e])}function s(e){let d;return d=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:t(e.components),c.createElement(b.Provider,{value:d},e.children)}}}]);