<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedLabels #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-deferred-out-of-scope-variables #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">-- | Implements a Hydra network component using [etcd](https://etcd.io/).</span><span>
</span><span id="line-6"></span><span class="hs-comment">--</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- While implementing a basic broadcast protocol over a distributed key-value</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- store is quite an overkill, the [Raft](https://raft.github.io/) consensus of</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- etcd provides our application with a crash-recovery fault-tolerant &quot;atomic</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- broadcast&quot; out-of-the-box. As a nice side-effect, the network layer becomes</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- very introspectable, while it would also support features like TLS or service</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- discovery.</span><span>
</span><span id="line-13"></span><span class="hs-comment">--</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- The component starts and configures an `etcd` instance and connects to it</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- using a GRPC client. We can only write and read from the cluster while</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- connected to the majority cluster.</span><span>
</span><span id="line-17"></span><span class="hs-comment">--</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- Broadcasting is implemented using @put@ to some well-known key, while message</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- delivery is done by using @watch@ on the same 'msg' prefix. We keep a last known</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- revision, also stored on disk, to start 'watch' with that revision (+1) and</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- only deliver messages that were not seen before. In case we are not connected</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- to our 'etcd' instance or not enough peers (= on a minority cluster), we</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- retry sending, but also store messages to broadcast in a 'PersistentQueue',</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- which makes the node resilient against crashes while sending. TODO: Is this</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- needed? performance limitation?</span><span>
</span><span id="line-26"></span><span class="hs-comment">--</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- Connectivity and compatibility with other nodes on the cluster is tracked</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- using the key-value service as well:</span><span>
</span><span id="line-29"></span><span class="hs-comment">--</span><span>
</span><span id="line-30"></span><span class="hs-comment">--   * network connectivity is determined by being able to fetch the member list</span><span>
</span><span id="line-31"></span><span class="hs-comment">--   * peer connectivity is tracked (best effort, not authorized) using an entry</span><span>
</span><span id="line-32"></span><span class="hs-comment">--     at 'alive-\&lt;advertise\&gt;' keys with individual leases and repeated keep-alives</span><span>
</span><span id="line-33"></span><span class="hs-comment">--   * each node compare-and-swaps its `version` into a key of the same name to</span><span>
</span><span id="line-34"></span><span class="hs-comment">--     check compatibility (not updatable)</span><span>
</span><span id="line-35"></span><span class="hs-comment">--</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- Note that the etcd cluster is configured to compact revisions down to 1000</span><span>
</span><span id="line-37"></span><span class="hs-comment">-- every 5 minutes. This prevents infinite growth of the key-value store, but</span><span>
</span><span id="line-38"></span><span class="hs-comment">-- also limits how long a node can be disconnected without missing out. 1000</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- should be more than enough for our use-case as the Hydra protocol will not</span><span>
</span><span id="line-40"></span><span class="hs-comment">-- advance unless all participants are present.</span><span>
</span><span id="line-41"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hydra.Network.Etcd</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Hydra.Prelude</span></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Binary</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">decodeFull'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">serialize'</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Class.MonadSTM</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-47"></span><span>  </span><span class="annot"><span class="hs-identifier">modifyTVar'</span></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><span class="hs-identifier">newTBQueueIO</span></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>  </span><span class="annot"><span class="hs-identifier">newTVarIO</span></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>  </span><span class="annot"><span class="hs-identifier">peekTBQueue</span></span><span class="hs-special">,</span><span>
</span><span id="line-51"></span><span>  </span><span class="annot"><span class="hs-identifier">readTBQueue</span></span><span class="hs-special">,</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><span class="hs-identifier">swapTVar</span></span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>  </span><span class="annot"><span class="hs-identifier">writeTBQueue</span></span><span class="hs-special">,</span><span>
</span><span id="line-54"></span><span>  </span><span class="annot"><span class="hs-identifier">writeTVar</span></span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.Exception.html#IOException"><span class="hs-identifier">IOException</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(^.)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(^..)</span></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">decodeFileStrict'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">encodeFile</span></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Aeson</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson.Types</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Value</span></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/bytestring-0.11.5.3/src/Data.ByteString.html"><span class="hs-identifier">Data.ByteString</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.OldList.html#%5C%5C"><span class="hs-operator">(\\)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">List</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Map.html"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Logging.html"><span class="hs-identifier">Hydra.Logging</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Network.html"><span class="hs-identifier">Hydra.Network</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-67"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#Connectivity"><span class="hs-identifier">Connectivity</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#Host"><span class="hs-identifier">Host</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#Network"><span class="hs-identifier">Network</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#NetworkCallback"><span class="hs-identifier">NetworkCallback</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#NetworkComponent"><span class="hs-identifier">NetworkComponent</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-72"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#NetworkConfiguration"><span class="hs-identifier">NetworkConfiguration</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-73"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#ProtocolVersion"><span class="hs-identifier">ProtocolVersion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.GRPC.Client</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-76"></span><span>  </span><span class="annot"><span class="hs-identifier">Address</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-77"></span><span>  </span><span class="annot"><span class="hs-identifier">ConnParams</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-78"></span><span>  </span><span class="annot"><span class="hs-identifier">Connection</span></span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>  </span><span class="annot"><span class="hs-identifier">ReconnectPolicy</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>  </span><span class="annot"><span class="hs-identifier">ReconnectTo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ReconnectToOriginal</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-81"></span><span>  </span><span class="annot"><span class="hs-identifier">Server</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-82"></span><span>  </span><span class="annot"><span class="hs-identifier">rpc</span></span><span class="hs-special">,</span><span>
</span><span id="line-83"></span><span>  </span><span class="annot"><span class="hs-identifier">withConnection</span></span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.GRPC.Client.StreamType.IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">biDiStreaming</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">nonStreaming</span></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.GRPC.Common</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">GrpcError</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">GrpcException</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">HTTP2Settings</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">NextElem</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">def</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">defaultHTTP2Settings</span></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.GRPC.Common.NextElem</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">whileNext_</span></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.GRPC.Common.Protobuf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Proto</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Protobuf</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">defMessage</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(.~)</span></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.GRPC.Etcd</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-90"></span><span>  </span><span class="annot"><span class="hs-identifier">Compare'CompareResult</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><span class="hs-identifier">Compare'CompareTarget</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><span class="hs-identifier">KV</span></span><span class="hs-special">,</span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><span class="hs-identifier">Lease</span></span><span class="hs-special">,</span><span>
</span><span id="line-94"></span><span>  </span><span class="annot"><span class="hs-identifier">Watch</span></span><span class="hs-special">,</span><span>
</span><span id="line-95"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/directory-1.3.8.5/src/System.Directory.html"><span class="hs-identifier">System.Directory</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/directory-1.3.8.5/src/System.Directory.html#createDirectoryIfMissing"><span class="hs-identifier">createDirectoryIfMissing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/directory-1.3.8.5/src/System.Directory.html#listDirectory"><span class="hs-identifier">listDirectory</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/directory-1.3.8.5/src/System.Directory.html#removeFile"><span class="hs-identifier">removeFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/System.Environment.Blank.html"><span class="hs-identifier">System.Environment.Blank</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/System.Environment.html#getEnvironment"><span class="hs-identifier">getEnvironment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/template-haskell-2.20.0.0/src/System.FilePath.html"><span class="hs-identifier">System.FilePath</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/filepath-1.4.300.1/src/System.FilePath.Posix.html#%3C%2F%3E"><span class="hs-operator">(&lt;/&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/System.IO.Error.html"><span class="hs-identifier">System.IO.Error</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/System.IO.Error.html#isDoesNotExistError"><span class="hs-identifier">isDoesNotExistError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/process-1.6.19.0/src/System.Process.html"><span class="hs-identifier">System.Process</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/process-1.6.19.0/src/System.Process.Internals.html#interruptProcessGroupOf"><span class="hs-identifier">interruptProcessGroupOf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Process.Typed</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-102"></span><span>  </span><span class="annot"><span class="hs-identifier">Process</span></span><span class="hs-special">,</span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><span class="hs-identifier">ProcessConfig</span></span><span class="hs-special">,</span><span>
</span><span id="line-104"></span><span>  </span><span class="annot"><span class="hs-identifier">createPipe</span></span><span class="hs-special">,</span><span>
</span><span id="line-105"></span><span>  </span><span class="annot"><span class="hs-identifier">getStderr</span></span><span class="hs-special">,</span><span>
</span><span id="line-106"></span><span>  </span><span class="annot"><span class="hs-identifier">proc</span></span><span class="hs-special">,</span><span>
</span><span id="line-107"></span><span>  </span><span class="annot"><span class="hs-identifier">setCreateGroup</span></span><span class="hs-special">,</span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><span class="hs-identifier">setEnv</span></span><span class="hs-special">,</span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><span class="hs-identifier">setStderr</span></span><span class="hs-special">,</span><span>
</span><span id="line-110"></span><span>  </span><span class="annot"><span class="hs-identifier">startProcess</span></span><span class="hs-special">,</span><span>
</span><span id="line-111"></span><span>  </span><span class="annot"><span class="hs-identifier">stopProcess</span></span><span class="hs-special">,</span><span>
</span><span id="line-112"></span><span>  </span><span class="annot"><span class="hs-identifier">unsafeProcessHandle</span></span><span class="hs-special">,</span><span>
</span><span id="line-113"></span><span>  </span><span class="annot"><span class="hs-identifier">waitExitCode</span></span><span class="hs-special">,</span><span>
</span><span id="line-114"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">UnliftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">readTVarIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span class="hs-comment">-- | Concrete network component that broadcasts messages to an etcd cluster and</span><span>
</span><span id="line-118"></span><span class="hs-comment">-- listens for incoming messages.</span><span>
</span><span id="line-119"></span><span id="local-6989586621680480704"><span class="annot"><a href="Hydra.Network.Etcd.html#withEtcdNetwork"><span class="hs-identifier hs-type">withEtcdNetwork</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ToCBOR</span></span><span> </span><span class="annot"><a href="#local-6989586621680480704"><span class="hs-identifier hs-type">msg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromCBOR</span></span><span> </span><span class="annot"><a href="#local-6989586621680480704"><span class="hs-identifier hs-type">msg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480704"><span class="hs-identifier hs-type">msg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-121"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#EtcdLog"><span class="hs-identifier hs-type">EtcdLog</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-122"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#ProtocolVersion"><span class="hs-identifier hs-type">ProtocolVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-comment">-- TODO: check if all of these needed?</span><span>
</span><span id="line-124"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#NetworkConfiguration"><span class="hs-identifier hs-type">NetworkConfiguration</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-125"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#NetworkComponent"><span class="hs-identifier hs-type">NetworkComponent</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480704"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480704"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-126"></span><span id="withEtcdNetwork"><span class="annot"><span class="annottext">withEtcdNetwork :: forall msg.
(ToCBOR msg, FromCBOR msg, Eq msg) =&gt;
Tracer IO EtcdLog
-&gt; ProtocolVersion
-&gt; NetworkConfiguration
-&gt; NetworkComponent IO msg msg ()
</span><a href="Hydra.Network.Etcd.html#withEtcdNetwork"><span class="hs-identifier hs-var hs-var">withEtcdNetwork</span></a></span></span><span> </span><span id="local-6989586621680481521"><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680481521"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680481522"><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621680481522"><span class="hs-identifier hs-var">protocolVersion</span></a></span></span><span> </span><span id="local-6989586621680481523"><span class="annot"><span class="annottext">NetworkConfiguration
</span><a href="#local-6989586621680481523"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span id="local-6989586621680481524"><span class="annot"><span class="annottext">NetworkCallback msg IO
</span><a href="#local-6989586621680481524"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span id="local-6989586621680481525"><span class="annot"><span class="annottext">Network IO msg -&gt; IO ()
</span><a href="#local-6989586621680481525"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-comment">-- TODO: fail if cluster config / members do not match --peer</span><span>
</span><span id="line-128"></span><span>  </span><span class="hs-comment">-- configuration? That would be similar to the 'acks' persistence</span><span>
</span><span id="line-129"></span><span>  </span><span class="hs-comment">-- bailing out on loading.</span><span>
</span><span id="line-130"></span><span>  </span><span id="local-6989586621680481526"><span class="annot"><span class="annottext">Map [Char] [Char]
</span><a href="#local-6989586621680481526"><span class="hs-identifier hs-var">envVars</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[([Char], [Char])] -&gt; Map [Char] [Char]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#fromList"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([([Char], [Char])] -&gt; Map [Char] [Char])
-&gt; IO [([Char], [Char])] -&gt; IO (Map [Char] [Char])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IO [([Char], [Char])]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/System.Environment.html#getEnvironment"><span class="hs-identifier hs-var">getEnvironment</span></a></span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><span class="annottext">ProcessConfig () () Handle
-&gt; (Process () () Handle -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) stdin stdout stderr a.
(MonadIO m, MonadThrow m) =&gt;
ProcessConfig stdin stdout stderr
-&gt; (Process stdin stdout stderr -&gt; m a) -&gt; m a
</span><a href="Hydra.Network.Etcd.html#withProcessInterrupt"><span class="hs-identifier hs-var">withProcessInterrupt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map [Char] [Char] -&gt; ProcessConfig () () Handle
</span><a href="#local-6989586621680481530"><span class="hs-identifier hs-var">etcdCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Map [Char] [Char]
</span><a href="#local-6989586621680481526"><span class="hs-identifier hs-var">envVars</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Process () () Handle -&gt; IO ()) -&gt; IO ())
-&gt; (Process () () Handle -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680481531"><span class="annot"><span class="annottext">Process () () Handle
</span><a href="#local-6989586621680481531"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-132"></span><span>    </span><span class="annot"><span class="annottext">IO Any -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO ()
forall (m :: * -&gt; *) a b. MonadAsync m =&gt; m a -&gt; m b -&gt; m ()
</span><span class="hs-identifier hs-var">race_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Process () () Handle -&gt; IO ExitCode
forall (m :: * -&gt; *) stdin stdout stderr.
MonadIO m =&gt;
Process stdin stdout stderr -&gt; m ExitCode
</span><span class="hs-identifier hs-var">waitExitCode</span></span><span> </span><span class="annot"><span class="annottext">Process () () Handle
</span><a href="#local-6989586621680481531"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">IO ExitCode -&gt; (ExitCode -&gt; IO Any) -&gt; IO Any
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680481533"><span class="annot"><span class="annottext">ExitCode
</span><a href="#local-6989586621680481533"><span class="hs-identifier hs-var">ec</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; IO Any
forall a. [Char] -&gt; IO a
forall (m :: * -&gt; *) a. MonadFail m =&gt; [Char] -&gt; m a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.Fail.html#fail"><span class="hs-identifier hs-var">fail</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; IO Any) -&gt; [Char] -&gt; IO Any
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Sub-process etcd exited with: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode -&gt; [Char]
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="#local-6989586621680481533"><span class="hs-identifier hs-var">ec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>      </span><span class="annot"><span class="annottext">IO Any -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO ()
forall (m :: * -&gt; *) a b. MonadAsync m =&gt; m a -&gt; m b -&gt; m ()
</span><span class="hs-identifier hs-var">race_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Process () () Handle -&gt; IO Any
</span><a href="#local-6989586621680481535"><span class="hs-identifier hs-var">traceStderr</span></a></span><span> </span><span class="annot"><span class="annottext">Process () () Handle
</span><a href="#local-6989586621680481531"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-134"></span><span>        </span><span class="hs-comment">-- XXX: cleanup reconnecting through policy if other threads fail</span><span>
</span><span id="line-135"></span><span>        </span><span id="local-6989586621680481536"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621680481536"><span class="hs-identifier hs-var">doneVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (TVar IO Bool)
forall a. a -&gt; IO (TVar IO a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (TVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-136"></span><span>        </span><span class="hs-comment">-- NOTE: The connection to the server is set up asynchronously; the</span><span>
</span><span id="line-137"></span><span>        </span><span class="hs-comment">-- first rpc call will block until the connection has been established.</span><span>
</span><span id="line-138"></span><span>        </span><span class="annot"><span class="annottext">ConnParams -&gt; Server -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a. ConnParams -&gt; Server -&gt; (Connection -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">withConnection</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar Bool -&gt; ConnParams
</span><a href="#local-6989586621680481537"><span class="hs-identifier hs-var">connParams</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621680481536"><span class="hs-identifier hs-var">doneVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621680481538"><span class="hs-identifier hs-var">grpcServer</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680481539"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680481539"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-139"></span><span>          </span><span class="hs-comment">-- REVIEW: checkVersion blocks if used on main thread - why?</span><span>
</span><span id="line-140"></span><span>          </span><span class="annot"><span class="annottext">IO () -&gt; (Async IO () -&gt; IO ()) -&gt; IO ()
forall a b. IO a -&gt; (Async IO a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b.
MonadAsync m =&gt;
m a -&gt; (Async m a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">withAsync</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer IO EtcdLog
-&gt; Connection -&gt; ProtocolVersion -&gt; NetworkCallback msg IO -&gt; IO ()
forall msg.
Tracer IO EtcdLog
-&gt; Connection -&gt; ProtocolVersion -&gt; NetworkCallback msg IO -&gt; IO ()
</span><a href="Hydra.Network.Etcd.html#checkVersion"><span class="hs-identifier hs-var">checkVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680481521"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680481539"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621680481522"><span class="hs-identifier hs-var">protocolVersion</span></a></span><span> </span><span class="annot"><span class="annottext">NetworkCallback msg IO
</span><a href="#local-6989586621680481524"><span class="hs-identifier hs-var">callback</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Async IO () -&gt; IO ()) -&gt; IO ())
-&gt; (Async IO () -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Async IO ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-141"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO ()
forall (m :: * -&gt; *) a b. MonadAsync m =&gt; m a -&gt; m b -&gt; m ()
</span><span class="hs-identifier hs-var">race_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer IO EtcdLog
-&gt; Connection -&gt; Host -&gt; NetworkCallback msg IO -&gt; IO ()
forall msg.
Tracer IO EtcdLog
-&gt; Connection -&gt; Host -&gt; NetworkCallback msg IO -&gt; IO ()
</span><a href="Hydra.Network.Etcd.html#pollConnectivity"><span class="hs-identifier hs-var">pollConnectivity</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680481521"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680481539"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481543"><span class="hs-identifier hs-var">advertise</span></a></span><span> </span><span class="annot"><span class="annottext">NetworkCallback msg IO
</span><a href="#local-6989586621680481524"><span class="hs-identifier hs-var">callback</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-142"></span><span>              </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO ()
forall (m :: * -&gt; *) a b. MonadAsync m =&gt; m a -&gt; m b -&gt; m ()
</span><span class="hs-identifier hs-var">race_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer IO EtcdLog
-&gt; Connection -&gt; [Char] -&gt; NetworkCallback msg IO -&gt; IO ()
forall msg.
FromCBOR msg =&gt;
Tracer IO EtcdLog
-&gt; Connection -&gt; [Char] -&gt; NetworkCallback msg IO -&gt; IO ()
</span><a href="Hydra.Network.Etcd.html#waitMessages"><span class="hs-identifier hs-var">waitMessages</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680481521"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680481539"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680481545"><span class="hs-identifier hs-var">persistenceDir</span></a></span><span> </span><span class="annot"><span class="annottext">NetworkCallback msg IO
</span><a href="#local-6989586621680481524"><span class="hs-identifier hs-var">callback</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-143"></span><span>                </span><span id="local-6989586621680481546"><span class="annot"><span class="annottext">PersistentQueue IO msg
</span><a href="#local-6989586621680481546"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Natural -&gt; IO (PersistentQueue IO msg)
forall (m :: * -&gt; *) a.
(MonadSTM m, MonadIO m, FromCBOR a, MonadCatch m, MonadFail m) =&gt;
[Char] -&gt; Natural -&gt; m (PersistentQueue m a)
</span><a href="Hydra.Network.Etcd.html#newPersistentQueue"><span class="hs-identifier hs-var">newPersistentQueue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680481545"><span class="hs-identifier hs-var">persistenceDir</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/filepath-1.4.300.1/src/System.FilePath.Posix.html#%3C%2F%3E"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;pending-broadcast&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">100</span></span><span>
</span><span id="line-144"></span><span>                </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO ()
forall (m :: * -&gt; *) a b. MonadAsync m =&gt; m a -&gt; m b -&gt; m ()
</span><span class="hs-identifier hs-var">race_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer IO EtcdLog
-&gt; Connection -&gt; Host -&gt; PersistentQueue IO msg -&gt; IO ()
forall msg.
(ToCBOR msg, Eq msg) =&gt;
Tracer IO EtcdLog
-&gt; Connection -&gt; Host -&gt; PersistentQueue IO msg -&gt; IO ()
</span><a href="Hydra.Network.Etcd.html#broadcastMessages"><span class="hs-identifier hs-var">broadcastMessages</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680481521"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680481539"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481543"><span class="hs-identifier hs-var">advertise</span></a></span><span> </span><span class="annot"><span class="annottext">PersistentQueue IO msg
</span><a href="#local-6989586621680481546"><span class="hs-identifier hs-var">queue</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-145"></span><span>                  </span><span class="annot"><span class="annottext">Network IO msg -&gt; IO ()
</span><a href="#local-6989586621680481525"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-146"></span><span>                    </span><span class="annot"><a href="Hydra.Network.html#Network"><span class="hs-identifier hs-type">Network</span></a></span><span>
</span><span id="line-147"></span><span>                      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:broadcast:Network :: msg -&gt; IO ()
</span><a href="Hydra.Network.html#%24sel%3Abroadcast%3ANetwork"><span class="hs-identifier hs-var">broadcast</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PersistentQueue IO msg -&gt; msg -&gt; IO ()
forall a (m :: * -&gt; *).
(ToCBOR a, MonadSTM m, MonadIO m) =&gt;
PersistentQueue m a -&gt; a -&gt; m ()
</span><a href="Hydra.Network.Etcd.html#writePersistentQueue"><span class="hs-identifier hs-var">writePersistentQueue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistentQueue IO msg
</span><a href="#local-6989586621680481546"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-148"></span><span>                      </span><span class="hs-special">}</span><span>
</span><span id="line-149"></span><span>                  </span><span class="annot"><span class="annottext">STM IO () -&gt; IO ()
forall a. HasCallStack =&gt; STM IO a -&gt; IO a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar IO Bool -&gt; Bool -&gt; STM IO ()
forall a. TVar IO a -&gt; a -&gt; STM IO ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
TVar IO Bool
</span><a href="#local-6989586621680481536"><span class="hs-identifier hs-var">doneVar</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-151"></span><span>  </span><span id="local-6989586621680481537"><span class="annot"><span class="annottext">connParams :: TVar Bool -&gt; ConnParams
</span><a href="#local-6989586621680481537"><span class="hs-identifier hs-var hs-var">connParams</span></a></span></span><span> </span><span id="local-6989586621680481553"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621680481553"><span class="hs-identifier hs-var">doneVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><span class="annottext">ConnParams
forall a. Default a =&gt; a
</span><span class="hs-identifier hs-var">def</span></span><span>
</span><span id="line-153"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-var">connReconnectPolicy</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680481555"><span class="hs-identifier hs-type">reconnectPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680481553"><span class="hs-identifier hs-type">doneVar</span></a></span><span>
</span><span id="line-154"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- NOTE: Not rate limit pings to our trusted, local etcd node. See</span><span>
</span><span id="line-155"></span><span>        </span><span class="hs-comment">-- comment on 'http2OverridePingRateLimit'.</span><span>
</span><span id="line-156"></span><span>        </span><span class="annot"><span class="hs-identifier hs-var">connHTTP2Settings</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">defaultHTTP2Settings</span></span><span class="hs-special">{</span><span class="annot"><span class="hs-identifier hs-var">http2OverridePingRateLimit</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Enum.html#maxBound"><span class="hs-identifier hs-type">maxBound</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-157"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span>  </span><span id="local-6989586621680481555"><span class="annot"><span class="annottext">reconnectPolicy :: TVar Bool -&gt; ReconnectPolicy
</span><a href="#local-6989586621680481555"><span class="hs-identifier hs-var hs-var">reconnectPolicy</span></a></span></span><span> </span><span id="local-6989586621680481559"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621680481559"><span class="hs-identifier hs-var">doneVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReconnectTo -&gt; IO ReconnectPolicy -&gt; ReconnectPolicy
</span><span class="hs-identifier hs-var">ReconnectAfter</span></span><span> </span><span class="annot"><span class="annottext">ReconnectTo
</span><span class="hs-identifier hs-var">ReconnectToOriginal</span></span><span> </span><span class="annot"><span class="annottext">(IO ReconnectPolicy -&gt; ReconnectPolicy)
-&gt; IO ReconnectPolicy -&gt; ReconnectPolicy
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-160"></span><span>    </span><span id="local-6989586621680481561"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680481561"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. MonadIO m =&gt; TVar a -&gt; m a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621680481559"><span class="hs-identifier hs-var">doneVar</span></a></span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680481561"><span class="hs-identifier hs-var">done</span></a></span><span>
</span><span id="line-162"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ReconnectPolicy -&gt; IO ReconnectPolicy
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ReconnectPolicy
</span><span class="hs-identifier hs-var">DontReconnect</span></span><span>
</span><span id="line-163"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>        </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
forall (m :: * -&gt; *). MonadDelay m =&gt; DiffTime -&gt; m ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">1</span></span><span>
</span><span id="line-165"></span><span>        </span><span class="annot"><span class="annottext">Tracer IO EtcdLog -&gt; EtcdLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680481521"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">EtcdLog
</span><a href="Hydra.Network.Etcd.html#Reconnecting"><span class="hs-identifier hs-var">Reconnecting</span></a></span><span>
</span><span id="line-166"></span><span>        </span><span class="annot"><span class="annottext">ReconnectPolicy -&gt; IO ReconnectPolicy
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ReconnectPolicy -&gt; IO ReconnectPolicy)
-&gt; ReconnectPolicy -&gt; IO ReconnectPolicy
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Bool -&gt; ReconnectPolicy
</span><a href="#local-6989586621680481555"><span class="hs-identifier hs-var">reconnectPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621680481559"><span class="hs-identifier hs-var">doneVar</span></a></span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span>  </span><span id="local-6989586621680481565"><span class="annot"><span class="annottext">clientHost :: Host
</span><a href="#local-6989586621680481565"><span class="hs-identifier hs-var hs-var">clientHost</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hydra.Network.html#Host"><span class="hs-identifier hs-type">Host</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:hostname:Host :: Text
</span><a href="Hydra.Network.html#%24sel%3Ahostname%3AHost"><span class="hs-identifier hs-var">hostname</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;127.0.0.1&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:port:Host :: PortNumber
</span><a href="Hydra.Network.html#%24sel%3Aport%3AHost"><span class="hs-identifier hs-var">port</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621680481569"><span class="hs-identifier hs-var">clientPort</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span>  </span><span id="local-6989586621680481538"><span class="annot"><span class="annottext">grpcServer :: Server
</span><a href="#local-6989586621680481538"><span class="hs-identifier hs-var hs-var">grpcServer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><span class="annottext">Address -&gt; Server
</span><span class="hs-identifier hs-var">ServerInsecure</span></span><span> </span><span class="annot"><span class="annottext">(Address -&gt; Server) -&gt; Address -&gt; Server
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-172"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Address</span></span><span>
</span><span id="line-173"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">addressHost :: [Char]
</span><span class="hs-identifier hs-var">addressHost</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Char]
forall a. ToString a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">toString</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; [Char]) -&gt; Text -&gt; [Char]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Host -&gt; Text
</span><a href="Hydra.Network.html#%24sel%3Ahostname%3AHost"><span class="hs-identifier hs-var">hostname</span></a></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481565"><span class="hs-identifier hs-var">clientHost</span></a></span><span>
</span><span id="line-174"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">addressPort :: PortNumber
</span><span class="hs-identifier hs-var">addressPort</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Host -&gt; PortNumber
</span><a href="Hydra.Network.html#%24sel%3Aport%3AHost"><span class="hs-identifier hs-var">port</span></a></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481565"><span class="hs-identifier hs-var">clientHost</span></a></span><span>
</span><span id="line-175"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">addressAuthority :: Maybe [Char]
</span><span class="hs-identifier hs-var">addressAuthority</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe [Char]
forall a. Maybe a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-176"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-comment">-- NOTE: Offset client port by the same amount as configured 'port' is offset</span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-comment">-- from the default '5001'. This will result in the default client port 2379</span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-comment">-- be used by default still.</span><span>
</span><span id="line-181"></span><span>  </span><span id="local-6989586621680481569"><span class="annot"><span class="annottext">clientPort :: PortNumber
</span><a href="#local-6989586621680481569"><span class="hs-identifier hs-var hs-var">clientPort</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><span class="hs-number">2379</span></span><span> </span><span class="annot"><span class="annottext">PortNumber -&gt; PortNumber -&gt; PortNumber
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Host -&gt; PortNumber
</span><a href="Hydra.Network.html#%24sel%3Aport%3AHost"><span class="hs-identifier hs-var">port</span></a></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481577"><span class="hs-identifier hs-var">listen</span></a></span><span> </span><span class="annot"><span class="annottext">PortNumber -&gt; PortNumber -&gt; PortNumber
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><span class="hs-number">5001</span></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span>  </span><span id="local-6989586621680481535"><span class="annot"><span class="annottext">traceStderr :: Process () () Handle -&gt; IO Any
</span><a href="#local-6989586621680481535"><span class="hs-identifier hs-var hs-var">traceStderr</span></a></span></span><span> </span><span id="local-6989586621680481578"><span class="annot"><span class="annottext">Process () () Handle
</span><a href="#local-6989586621680481578"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; IO Any
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.html#forever"><span class="hs-identifier hs-var">forever</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO Any) -&gt; IO () -&gt; IO Any
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>      </span><span id="local-6989586621680481580"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680481580"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; IO ByteString
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/bytestring-0.11.5.3/src/Data.ByteString.html#hGetLine"><span class="hs-identifier hs-var">BS.hGetLine</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Process () () Handle -&gt; Handle
forall stdin stdout stderr. Process stdin stdout stderr -&gt; stderr
</span><span class="hs-identifier hs-var">getStderr</span></span><span> </span><span class="annot"><span class="annottext">Process () () Handle
</span><a href="#local-6989586621680481578"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Either [Char] Value
forall a. FromJSON a =&gt; ByteString -&gt; Either [Char] a
</span><span class="hs-identifier hs-var">Aeson.eitherDecodeStrict</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680481580"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-187"></span><span>        </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680481583"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680481583"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog -&gt; EtcdLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680481521"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#FailedToDecodeLog"><span class="hs-identifier hs-type">FailedToDecodeLog</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:log:EtcdLog :: Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Alog%3AEtcdLog"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
forall a b. ConvertUtf8 a b =&gt; b -&gt; a
</span><span class="hs-identifier hs-var">decodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680481580"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:reason:EtcdLog :: Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Areason%3AEtcdLog"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Text
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680481583"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-188"></span><span>        </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680481588"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680481588"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog -&gt; EtcdLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680481521"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(EtcdLog -&gt; IO ()) -&gt; EtcdLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#EtcdLog"><span class="hs-identifier hs-type">EtcdLog</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">etcd :: Value
</span><a href="Hydra.Network.Etcd.html#etcd"><span class="hs-identifier hs-var">etcd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680481588"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-comment">-- XXX: Could use TLS to secure peer connections</span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-comment">-- XXX: Could use discovery to simplify configuration</span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-comment">-- NOTE: Configured using guides: https://etcd.io/docs/v3.5/op-guide</span><span>
</span><span id="line-193"></span><span>  </span><span id="local-6989586621680481530"><span class="annot"><span class="annottext">etcdCmd :: Map [Char] [Char] -&gt; ProcessConfig () () Handle
</span><a href="#local-6989586621680481530"><span class="hs-identifier hs-var hs-var">etcdCmd</span></a></span></span><span> </span><span id="local-6989586621680481590"><span class="annot"><span class="annottext">Map [Char] [Char]
</span><a href="#local-6989586621680481590"><span class="hs-identifier hs-var">envVars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-comment">-- NOTE: We map prefers the left; so we need to mappend default at the end.</span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><span class="annottext">[([Char], [Char])]
-&gt; ProcessConfig () () Handle -&gt; ProcessConfig () () Handle
forall stdin stdout stderr.
[([Char], [Char])]
-&gt; ProcessConfig stdin stdout stderr
-&gt; ProcessConfig stdin stdout stderr
</span><span class="hs-identifier hs-var">setEnv</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map [Char] [Char] -&gt; [([Char], [Char])]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">Map.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(Map [Char] [Char] -&gt; [([Char], [Char])])
-&gt; Map [Char] [Char] -&gt; [([Char], [Char])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map [Char] [Char]
</span><a href="#local-6989586621680481590"><span class="hs-identifier hs-var">envVars</span></a></span><span> </span><span class="annot"><span class="annottext">Map [Char] [Char] -&gt; Map [Char] [Char] -&gt; Map [Char] [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map [Char] [Char]
</span><a href="#local-6989586621680481592"><span class="hs-identifier hs-var">defaultEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>      </span><span class="annot"><span class="annottext">(ProcessConfig () () Handle -&gt; ProcessConfig () () Handle)
-&gt; ([[Char]] -&gt; ProcessConfig () () Handle)
-&gt; [[Char]]
-&gt; ProcessConfig () () Handle
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ProcessConfig () () Handle -&gt; ProcessConfig () () Handle
forall stdin stdout stderr.
Bool
-&gt; ProcessConfig stdin stdout stderr
-&gt; ProcessConfig stdin stdout stderr
</span><span class="hs-identifier hs-var">setCreateGroup</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="hs-comment">-- Prevents interrupt of main process when we send SIGINT to etcd</span><span>
</span><span id="line-197"></span><span>      </span><span class="annot"><span class="annottext">(ProcessConfig () () Handle -&gt; ProcessConfig () () Handle)
-&gt; ([[Char]] -&gt; ProcessConfig () () Handle)
-&gt; [[Char]]
-&gt; ProcessConfig () () Handle
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">StreamSpec 'STOutput Handle
-&gt; ProcessConfig () () () -&gt; ProcessConfig () () Handle
forall stderr stdin stdout stderr0.
StreamSpec 'STOutput stderr
-&gt; ProcessConfig stdin stdout stderr0
-&gt; ProcessConfig stdin stdout stderr
</span><span class="hs-identifier hs-var">setStderr</span></span><span> </span><span class="annot"><span class="annottext">StreamSpec 'STOutput Handle
forall (anyStreamType :: StreamType).
StreamSpec anyStreamType Handle
</span><span class="hs-identifier hs-var">createPipe</span></span><span>
</span><span id="line-198"></span><span>      </span><span class="annot"><span class="annottext">(ProcessConfig () () () -&gt; ProcessConfig () () Handle)
-&gt; ([[Char]] -&gt; ProcessConfig () () ())
-&gt; [[Char]]
-&gt; ProcessConfig () () Handle
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [[Char]] -&gt; ProcessConfig () () ()
</span><span class="hs-identifier hs-var">proc</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;etcd&quot;</span></span><span>
</span><span id="line-199"></span><span>      </span><span class="annot"><span class="annottext">([[Char]] -&gt; ProcessConfig () () Handle)
-&gt; [[Char]] -&gt; ProcessConfig () () Handle
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[[[Char]]] -&gt; [[Char]]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a></span><span>
</span><span id="line-200"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-comment">-- NOTE: Must be used in clusterPeers</span><span>
</span><span id="line-201"></span><span>          </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;--name&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Host -&gt; [Char]
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481543"><span class="hs-identifier hs-var">advertise</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-202"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;--data-dir&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680481545"><span class="hs-identifier hs-var">persistenceDir</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/filepath-1.4.300.1/src/System.FilePath.Posix.html#%3C%2F%3E"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;etcd&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-203"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;--listen-peer-urls&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Host -&gt; [Char]
</span><a href="#local-6989586621680481595"><span class="hs-identifier hs-var">httpUrl</span></a></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481577"><span class="hs-identifier hs-var">listen</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-204"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;--initial-advertise-peer-urls&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Host -&gt; [Char]
</span><a href="#local-6989586621680481595"><span class="hs-identifier hs-var">httpUrl</span></a></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481543"><span class="hs-identifier hs-var">advertise</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-205"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;--listen-client-urls&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Host -&gt; [Char]
</span><a href="#local-6989586621680481595"><span class="hs-identifier hs-var">httpUrl</span></a></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481565"><span class="hs-identifier hs-var">clientHost</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-206"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Pick a random port for http api (and use above only for grpc)</span><span>
</span><span id="line-207"></span><span>          </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;--listen-client-http-urls&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;http://localhost:0&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-208"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Client access only on configured 'host' interface.</span><span>
</span><span id="line-209"></span><span>          </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;--advertise-client-urls&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Host -&gt; [Char]
</span><a href="#local-6989586621680481595"><span class="hs-identifier hs-var">httpUrl</span></a></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481565"><span class="hs-identifier hs-var">clientHost</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-210"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- XXX: Could use unique initial-cluster-tokens to isolate clusters</span><span>
</span><span id="line-211"></span><span>          </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;--initial-cluster-token&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;hydra-network-1&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-212"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;--initial-cluster&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680481596"><span class="hs-identifier hs-var">clusterPeers</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-213"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><a href="#local-6989586621680481592"><span class="hs-identifier hs-type">defaultEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map.Map</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span>
</span><span id="line-216"></span><span>  </span><span id="local-6989586621680481592"><span class="annot"><span class="annottext">defaultEnv :: Map [Char] [Char]
</span><a href="#local-6989586621680481592"><span class="hs-identifier hs-var hs-var">defaultEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-217"></span><span>    </span><span class="hs-comment">-- Keep up to 1000 revisions. See also:</span><span>
</span><span id="line-218"></span><span>    </span><span class="hs-comment">-- https://etcd.io/docs/v3.5/op-guide/maintenance/#auto-compaction</span><span>
</span><span id="line-219"></span><span>    </span><span class="annot"><span class="annottext">[([Char], [Char])] -&gt; Map [Char] [Char]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#fromList"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span>
</span><span id="line-220"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;ETCD_AUTO_COMPACTION_MODE&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;revision&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;ETCD_AUTO_COMPACTION_RETENTION&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;1000&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-comment">-- NOTE: Building a canonical list of labels from the advertised addresses</span><span>
</span><span id="line-225"></span><span>  </span><span id="local-6989586621680481596"><span class="annot"><span class="annottext">clusterPeers :: [Char]
</span><a href="#local-6989586621680481596"><span class="hs-identifier hs-var hs-var">clusterPeers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-226"></span><span>    </span><span class="annot"><span class="annottext">[Char] -&gt; [[Char]] -&gt; [Char]
forall a. [a] -&gt; [[a]] -&gt; [a]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.OldList.html#intercalate"><span class="hs-identifier hs-var">intercalate</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;,&quot;</span></span><span>
</span><span id="line-227"></span><span>      </span><span class="annot"><span class="annottext">([[Char]] -&gt; [Char]) -&gt; ([Host] -&gt; [[Char]]) -&gt; [Host] -&gt; [Char]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Host -&gt; [Char]) -&gt; [Host] -&gt; [[Char]]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680481598"><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481598"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Host -&gt; [Char]
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481598"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;=&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Host -&gt; [Char]
</span><a href="#local-6989586621680481595"><span class="hs-identifier hs-var">httpUrl</span></a></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481598"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span>      </span><span class="annot"><span class="annottext">([Host] -&gt; [Char]) -&gt; [Host] -&gt; [Char]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481543"><span class="hs-identifier hs-var">advertise</span></a></span><span> </span><span class="annot"><span class="annottext">Host -&gt; [Host] -&gt; [Host]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[Host]
</span><a href="#local-6989586621680481599"><span class="hs-identifier hs-var">peers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span>  </span><span id="local-6989586621680481595"><span class="annot"><span class="annottext">httpUrl :: Host -&gt; [Char]
</span><a href="#local-6989586621680481595"><span class="hs-identifier hs-var hs-var">httpUrl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.Network.html#Host"><span class="hs-identifier hs-type">Host</span></a></span><span> </span><span id="local-6989586621680481610"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680481610"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680481611"><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621680481611"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;http://&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Char]
forall a. ToString a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">toString</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680481610"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;:&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PortNumber -&gt; [Char]
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621680481611"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#NetworkConfiguration"><span class="hs-identifier hs-type">NetworkConfiguration</span></a></span><span class="hs-special">{</span><span id="local-6989586621680481545"><span class="annot"><span class="annottext">[Char]
persistenceDir :: [Char]
$sel:persistenceDir:NetworkConfiguration :: NetworkConfiguration -&gt; [Char]
</span><a href="#local-6989586621680481545"><span class="hs-identifier hs-var hs-var">persistenceDir</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680481577"><span class="annot"><span class="annottext">Host
listen :: Host
$sel:listen:NetworkConfiguration :: NetworkConfiguration -&gt; Host
</span><a href="#local-6989586621680481577"><span class="hs-identifier hs-var hs-var">listen</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680481543"><span class="annot"><span class="annottext">Host
advertise :: Host
$sel:advertise:NetworkConfiguration :: NetworkConfiguration -&gt; Host
</span><a href="#local-6989586621680481543"><span class="hs-identifier hs-var hs-var">advertise</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680481599"><span class="annot"><span class="annottext">[Host]
peers :: [Host]
$sel:peers:NetworkConfiguration :: NetworkConfiguration -&gt; [Host]
</span><a href="#local-6989586621680481599"><span class="hs-identifier hs-var hs-var">peers</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NetworkConfiguration
</span><a href="#local-6989586621680481523"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="hs-comment">-- | Check and write version on etcd cluster. This will retry until we are on a</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- majority cluster and succeed. If the version does not match a corresponding</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- 'Connectivity' message is sent via 'NetworkCallback'.</span><span>
</span><span id="line-237"></span><span id="local-6989586621680480785"><span class="annot"><a href="Hydra.Network.Etcd.html#checkVersion"><span class="hs-identifier hs-type">checkVersion</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#EtcdLog"><span class="hs-identifier hs-type">EtcdLog</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Connection</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-240"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#ProtocolVersion"><span class="hs-identifier hs-type">ProtocolVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#NetworkCallback"><span class="hs-identifier hs-type">NetworkCallback</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480785"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-242"></span><span>  </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-243"></span><span id="checkVersion"><span class="annot"><span class="annottext">checkVersion :: forall msg.
Tracer IO EtcdLog
-&gt; Connection -&gt; ProtocolVersion -&gt; NetworkCallback msg IO -&gt; IO ()
</span><a href="Hydra.Network.Etcd.html#checkVersion"><span class="hs-identifier hs-var hs-var">checkVersion</span></a></span></span><span> </span><span id="local-6989586621680481890"><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680481890"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680481891"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680481891"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span id="local-6989586621680481892"><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621680481892"><span class="hs-identifier hs-var">ourVersion</span></a></span></span><span> </span><span class="annot"><a href="Hydra.Network.html#NetworkCallback"><span class="hs-identifier hs-type">NetworkCallback</span></a></span><span class="hs-special">{</span><span id="local-6989586621680481893"><span class="annot"><span class="annottext">Connectivity -&gt; IO ()
onConnectivity :: Connectivity -&gt; IO ()
$sel:onConnectivity:NetworkCallback :: forall msg (m :: * -&gt; *).
NetworkCallback msg m -&gt; Connectivity -&gt; m ()
</span><a href="#local-6989586621680481893"><span class="hs-identifier hs-var hs-var">onConnectivity</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-comment">-- Get or write our version into kv store</span><span>
</span><span id="line-245"></span><span>  </span><span id="local-6989586621680481895"><span class="annot"><span class="annottext">Proto TxnResponse
</span><a href="#local-6989586621680481895"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><span class="annottext">Connection
-&gt; ClientHandler'
     'NonStreaming (ReaderT Connection IO) (Protobuf KV &quot;txn&quot;)
-&gt; Input (Protobuf KV &quot;txn&quot;)
-&gt; IO (Output (Protobuf KV &quot;txn&quot;))
forall {k} (rpc :: k) (m :: * -&gt; *).
Connection
-&gt; ClientHandler' 'NonStreaming (ReaderT Connection m) rpc
-&gt; Input rpc
-&gt; m (Output rpc)
</span><span class="hs-identifier hs-var">nonStreaming</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680481891"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {k} (rpc :: k) (styp :: StreamingType) (m :: * -&gt; *).
(CanCallRPC m, SupportsClientRpc rpc,
 SupportsStreamingType rpc styp, Default (RequestMetadata rpc)) =&gt;
ClientHandler' styp m rpc
forall rpc (styp :: StreamingType) (m :: * -&gt; *).
(CanCallRPC m, SupportsClientRpc rpc,
 SupportsStreamingType rpc styp, Default (RequestMetadata rpc)) =&gt;
ClientHandler' styp m rpc
</span><span class="hs-identifier hs-var">rpc</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Protobuf</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">KV</span></span><span> </span><span class="annot"><span class="hs-string">&quot;txn&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Input (Protobuf KV &quot;txn&quot;) -&gt; IO (Output (Protobuf KV &quot;txn&quot;)))
-&gt; Input (Protobuf KV &quot;txn&quot;) -&gt; IO (Output (Protobuf KV &quot;txn&quot;))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-247"></span><span>      </span><span class="annot"><span class="annottext">Proto TxnRequest
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-248"></span><span>        </span><span class="annot"><span class="annottext">Proto TxnRequest
-&gt; (Proto TxnRequest -&gt; Proto TxnRequest) -&gt; Proto TxnRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto TxnRequest)
  (Proto TxnRequest)
  [Proto Compare]
  [Proto Compare]
</span><span class="">#compare</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto TxnRequest)
  (Proto TxnRequest)
  [Proto Compare]
  [Proto Compare]
-&gt; [Proto Compare] -&gt; Proto TxnRequest -&gt; Proto TxnRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Proto Compare
</span><a href="#local-6989586621680481897"><span class="hs-identifier hs-var">versionExists</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-249"></span><span>        </span><span class="annot"><span class="annottext">Proto TxnRequest
-&gt; (Proto TxnRequest -&gt; Proto TxnRequest) -&gt; Proto TxnRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto TxnRequest)
  (Proto TxnRequest)
  [Proto RequestOp]
  [Proto RequestOp]
</span><span class="">#success</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto TxnRequest)
  (Proto TxnRequest)
  [Proto RequestOp]
  [Proto RequestOp]
-&gt; [Proto RequestOp] -&gt; Proto TxnRequest -&gt; Proto TxnRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Proto RequestOp
</span><a href="#local-6989586621680481898"><span class="hs-identifier hs-var">getVersion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-250"></span><span>        </span><span class="annot"><span class="annottext">Proto TxnRequest
-&gt; (Proto TxnRequest -&gt; Proto TxnRequest) -&gt; Proto TxnRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto TxnRequest)
  (Proto TxnRequest)
  [Proto RequestOp]
  [Proto RequestOp]
</span><span class="">#failure</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto TxnRequest)
  (Proto TxnRequest)
  [Proto RequestOp]
  [Proto RequestOp]
-&gt; [Proto RequestOp] -&gt; Proto TxnRequest -&gt; Proto TxnRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Proto RequestOp
</span><a href="#local-6989586621680481899"><span class="hs-identifier hs-var">putVersion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-comment">-- Check version if version was already present</span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Proto TxnResponse
</span><a href="#local-6989586621680481895"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Proto TxnResponse -&gt; Getting Bool (Proto TxnResponse) Bool -&gt; Bool
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Bool (Proto TxnResponse) Bool
</span><span class="">#succeeded</span></span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[Proto KeyValue] -&gt; (Proto KeyValue -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proto TxnResponse
</span><a href="#local-6989586621680481895"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Proto TxnResponse
-&gt; Getting
     (Endo [Proto KeyValue]) (Proto TxnResponse) (Proto KeyValue)
-&gt; [Proto KeyValue]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">([Proto ResponseOp]
 -&gt; Const (Endo [Proto KeyValue]) [Proto ResponseOp])
-&gt; Proto TxnResponse
-&gt; Const (Endo [Proto KeyValue]) (Proto TxnResponse)
</span><span class="">#responses</span></span><span> </span><span class="annot"><span class="annottext">(([Proto ResponseOp]
  -&gt; Const (Endo [Proto KeyValue]) [Proto ResponseOp])
 -&gt; Proto TxnResponse
 -&gt; Const (Endo [Proto KeyValue]) (Proto TxnResponse))
-&gt; ((Proto KeyValue
     -&gt; Const (Endo [Proto KeyValue]) (Proto KeyValue))
    -&gt; [Proto ResponseOp]
    -&gt; Const (Endo [Proto KeyValue]) [Proto ResponseOp])
-&gt; Getting
     (Endo [Proto KeyValue]) (Proto TxnResponse) (Proto KeyValue)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Proto ResponseOp
 -&gt; Const (Endo [Proto KeyValue]) (Proto ResponseOp))
-&gt; [Proto ResponseOp]
-&gt; Const (Endo [Proto KeyValue]) [Proto ResponseOp]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Traversable.html#traverse"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">((Proto ResponseOp
  -&gt; Const (Endo [Proto KeyValue]) (Proto ResponseOp))
 -&gt; [Proto ResponseOp]
 -&gt; Const (Endo [Proto KeyValue]) [Proto ResponseOp])
-&gt; ((Proto KeyValue
     -&gt; Const (Endo [Proto KeyValue]) (Proto KeyValue))
    -&gt; Proto ResponseOp
    -&gt; Const (Endo [Proto KeyValue]) (Proto ResponseOp))
-&gt; (Proto KeyValue
    -&gt; Const (Endo [Proto KeyValue]) (Proto KeyValue))
-&gt; [Proto ResponseOp]
-&gt; Const (Endo [Proto KeyValue]) [Proto ResponseOp]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Proto RangeResponse
 -&gt; Const (Endo [Proto KeyValue]) (Proto RangeResponse))
-&gt; Proto ResponseOp
-&gt; Const (Endo [Proto KeyValue]) (Proto ResponseOp)
</span><span class="">#responseRange</span></span><span> </span><span class="annot"><span class="annottext">((Proto RangeResponse
  -&gt; Const (Endo [Proto KeyValue]) (Proto RangeResponse))
 -&gt; Proto ResponseOp
 -&gt; Const (Endo [Proto KeyValue]) (Proto ResponseOp))
-&gt; ((Proto KeyValue
     -&gt; Const (Endo [Proto KeyValue]) (Proto KeyValue))
    -&gt; Proto RangeResponse
    -&gt; Const (Endo [Proto KeyValue]) (Proto RangeResponse))
-&gt; (Proto KeyValue
    -&gt; Const (Endo [Proto KeyValue]) (Proto KeyValue))
-&gt; Proto ResponseOp
-&gt; Const (Endo [Proto KeyValue]) (Proto ResponseOp)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">([Proto KeyValue]
 -&gt; Const (Endo [Proto KeyValue]) [Proto KeyValue])
-&gt; Proto RangeResponse
-&gt; Const (Endo [Proto KeyValue]) (Proto RangeResponse)
</span><span class="">#kvs</span></span><span> </span><span class="annot"><span class="annottext">(([Proto KeyValue]
  -&gt; Const (Endo [Proto KeyValue]) [Proto KeyValue])
 -&gt; Proto RangeResponse
 -&gt; Const (Endo [Proto KeyValue]) (Proto RangeResponse))
-&gt; ((Proto KeyValue
     -&gt; Const (Endo [Proto KeyValue]) (Proto KeyValue))
    -&gt; [Proto KeyValue]
    -&gt; Const (Endo [Proto KeyValue]) [Proto KeyValue])
-&gt; (Proto KeyValue
    -&gt; Const (Endo [Proto KeyValue]) (Proto KeyValue))
-&gt; Proto RangeResponse
-&gt; Const (Endo [Proto KeyValue]) (Proto RangeResponse)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Proto KeyValue -&gt; Const (Endo [Proto KeyValue]) (Proto KeyValue))
-&gt; [Proto KeyValue]
-&gt; Const (Endo [Proto KeyValue]) [Proto KeyValue]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Traversable.html#traverse"><span class="hs-identifier hs-var">traverse</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Proto KeyValue -&gt; IO ()) -&gt; IO ())
-&gt; (Proto KeyValue -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680481902"><span class="annot"><span class="annottext">Proto KeyValue
</span><a href="#local-6989586621680481902"><span class="hs-identifier hs-var">kv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-255"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Either DecoderError ProtocolVersion
forall a. FromCBOR a =&gt; ByteString -&gt; Either DecoderError a
</span><span class="hs-identifier hs-var">decodeFull'</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Either DecoderError ProtocolVersion)
-&gt; ByteString -&gt; Either DecoderError ProtocolVersion
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proto KeyValue
</span><a href="#local-6989586621680481902"><span class="hs-identifier hs-var">kv</span></a></span><span> </span><span class="annot"><span class="annottext">Proto KeyValue
-&gt; Getting ByteString (Proto KeyValue) ByteString -&gt; ByteString
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting ByteString (Proto KeyValue) ByteString
</span><span class="">#value</span></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-256"></span><span>        </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680481903"><span class="annot"><span class="annottext">DecoderError
</span><a href="#local-6989586621680481903"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-257"></span><span>          </span><span class="annot"><span class="annottext">Tracer IO EtcdLog -&gt; EtcdLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680481890"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(EtcdLog -&gt; IO ()) -&gt; EtcdLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-258"></span><span>            </span><span class="annot"><a href="Hydra.Network.Etcd.html#FailedToDecodeValue"><span class="hs-identifier hs-type">FailedToDecodeValue</span></a></span><span>
</span><span id="line-259"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:key:EtcdLog :: Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Akey%3AEtcdLog"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
forall a b. ConvertUtf8 a b =&gt; b -&gt; a
</span><span class="hs-identifier hs-var">decodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Text) -&gt; ByteString -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proto KeyValue
</span><a href="#local-6989586621680481902"><span class="hs-identifier hs-var">kv</span></a></span><span> </span><span class="annot"><span class="annottext">Proto KeyValue
-&gt; Getting ByteString (Proto KeyValue) ByteString -&gt; ByteString
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting ByteString (Proto KeyValue) ByteString
</span><span class="">#key</span></span><span>
</span><span id="line-260"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:value:EtcdLog :: Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Avalue%3AEtcdLog"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><span class="hs-identifier hs-var">encodeBase16</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Text) -&gt; ByteString -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proto KeyValue
</span><a href="#local-6989586621680481902"><span class="hs-identifier hs-var">kv</span></a></span><span> </span><span class="annot"><span class="annottext">Proto KeyValue
-&gt; Getting ByteString (Proto KeyValue) ByteString -&gt; ByteString
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting ByteString (Proto KeyValue) ByteString
</span><span class="">#value</span></span><span>
</span><span id="line-261"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:reason:EtcdLog :: Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Areason%3AEtcdLog"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DecoderError -&gt; Text
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">DecoderError
</span><a href="#local-6989586621680481903"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-262"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-263"></span><span>          </span><span class="annot"><span class="annottext">Connectivity -&gt; IO ()
</span><a href="#local-6989586621680481893"><span class="hs-identifier hs-var">onConnectivity</span></a></span><span> </span><span class="annot"><a href="Hydra.Network.html#VersionMismatch"><span class="hs-identifier hs-type">VersionMismatch</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ProtocolVersion
ourVersion :: ProtocolVersion
$sel:ourVersion:PeerConnected :: ProtocolVersion
</span><a href="#local-6989586621680481892"><span class="hs-identifier hs-var hs-var">ourVersion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:theirVersion:PeerConnected :: Maybe ProtocolVersion
</span><a href="Hydra.Network.html#%24sel%3AtheirVersion%3APeerConnected"><span class="hs-identifier hs-var">theirVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ProtocolVersion
forall a. Maybe a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-264"></span><span>        </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680481911"><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621680481911"><span class="hs-identifier hs-var">theirVersion</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-265"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621680481911"><span class="hs-identifier hs-var">theirVersion</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolVersion -&gt; ProtocolVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621680481892"><span class="hs-identifier hs-var">ourVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-266"></span><span>            </span><span class="annot"><span class="annottext">Connectivity -&gt; IO ()
</span><a href="#local-6989586621680481893"><span class="hs-identifier hs-var">onConnectivity</span></a></span><span> </span><span class="annot"><a href="Hydra.Network.html#VersionMismatch"><span class="hs-identifier hs-type">VersionMismatch</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ProtocolVersion
ourVersion :: ProtocolVersion
$sel:ourVersion:PeerConnected :: ProtocolVersion
</span><a href="#local-6989586621680481892"><span class="hs-identifier hs-var hs-var">ourVersion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:theirVersion:PeerConnected :: Maybe ProtocolVersion
</span><a href="Hydra.Network.html#%24sel%3AtheirVersion%3APeerConnected"><span class="hs-identifier hs-var">theirVersion</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolVersion -&gt; Maybe ProtocolVersion
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621680481911"><span class="hs-identifier hs-var">theirVersion</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-keyword">else</span><span>
</span><span id="line-268"></span><span>      </span><span class="annot"><span class="annottext">Tracer IO EtcdLog -&gt; EtcdLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680481890"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(EtcdLog -&gt; IO ()) -&gt; EtcdLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#MatchingProtocolVersion"><span class="hs-identifier hs-type">MatchingProtocolVersion</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">version :: ProtocolVersion
</span><a href="Hydra.Network.Etcd.html#version"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621680481892"><span class="hs-identifier hs-var">ourVersion</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-269"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-270"></span><span>  </span><span id="local-6989586621680481916"><span class="annot"><span class="annottext">versionKey :: ByteString
</span><a href="#local-6989586621680481916"><span class="hs-identifier hs-var hs-var">versionKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;version&quot;</span></span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-comment">-- exists = create_revision of key 'version' &gt; 0</span><span>
</span><span id="line-273"></span><span>  </span><span id="local-6989586621680481897"><span class="annot"><span class="annottext">versionExists :: Proto Compare
</span><a href="#local-6989586621680481897"><span class="hs-identifier hs-var hs-var">versionExists</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-274"></span><span>    </span><span class="annot"><span class="annottext">Proto Compare
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-275"></span><span>      </span><span class="annot"><span class="annottext">Proto Compare -&gt; (Proto Compare -&gt; Proto Compare) -&gt; Proto Compare
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto Compare)
  (Proto Compare)
  (Proto Compare'CompareResult)
  (Proto Compare'CompareResult)
</span><span class="">#result</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto Compare)
  (Proto Compare)
  (Proto Compare'CompareResult)
  (Proto Compare'CompareResult)
-&gt; Proto Compare'CompareResult -&gt; Proto Compare -&gt; Proto Compare
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Compare'CompareResult -&gt; Proto Compare'CompareResult
forall msg. msg -&gt; Proto msg
</span><span class="hs-identifier hs-var">Proto</span></span><span> </span><span class="annot"><span class="annottext">Compare'CompareResult
</span><span class="hs-identifier hs-var">Compare'GREATER</span></span><span>
</span><span id="line-276"></span><span>      </span><span class="annot"><span class="annottext">Proto Compare -&gt; (Proto Compare -&gt; Proto Compare) -&gt; Proto Compare
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto Compare)
  (Proto Compare)
  (Proto Compare'CompareTarget)
  (Proto Compare'CompareTarget)
</span><span class="">#target</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto Compare)
  (Proto Compare)
  (Proto Compare'CompareTarget)
  (Proto Compare'CompareTarget)
-&gt; Proto Compare'CompareTarget -&gt; Proto Compare -&gt; Proto Compare
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Compare'CompareTarget -&gt; Proto Compare'CompareTarget
forall msg. msg -&gt; Proto msg
</span><span class="hs-identifier hs-var">Proto</span></span><span> </span><span class="annot"><span class="annottext">Compare'CompareTarget
</span><span class="hs-identifier hs-var">Compare'VERSION</span></span><span>
</span><span id="line-277"></span><span>      </span><span class="annot"><span class="annottext">Proto Compare -&gt; (Proto Compare -&gt; Proto Compare) -&gt; Proto Compare
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto Compare) (Proto Compare) ByteString ByteString
</span><span class="">#key</span></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto Compare) (Proto Compare) ByteString ByteString
-&gt; ByteString -&gt; Proto Compare -&gt; Proto Compare
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680481916"><span class="hs-identifier hs-var">versionKey</span></a></span><span>
</span><span id="line-278"></span><span>      </span><span class="annot"><span class="annottext">Proto Compare -&gt; (Proto Compare -&gt; Proto Compare) -&gt; Proto Compare
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto Compare) (Proto Compare) Int64 Int64
</span><span class="">#version</span></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto Compare) (Proto Compare) Int64 Int64
-&gt; Int64 -&gt; Proto Compare -&gt; Proto Compare
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span>  </span><span id="local-6989586621680481898"><span class="annot"><span class="annottext">getVersion :: Proto RequestOp
</span><a href="#local-6989586621680481898"><span class="hs-identifier hs-var hs-var">getVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-281"></span><span>    </span><span class="annot"><span class="annottext">Proto RequestOp
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span> </span><span class="annot"><span class="annottext">Proto RequestOp
-&gt; (Proto RequestOp -&gt; Proto RequestOp) -&gt; Proto RequestOp
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto RequestOp)
  (Proto RequestOp)
  (Proto RangeRequest)
  (Proto RangeRequest)
</span><span class="">#requestRange</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto RequestOp)
  (Proto RequestOp)
  (Proto RangeRequest)
  (Proto RangeRequest)
-&gt; Proto RangeRequest -&gt; Proto RequestOp -&gt; Proto RequestOp
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proto RangeRequest
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span> </span><span class="annot"><span class="annottext">Proto RangeRequest
-&gt; (Proto RangeRequest -&gt; Proto RangeRequest) -&gt; Proto RangeRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto RangeRequest) (Proto RangeRequest) ByteString ByteString
</span><span class="">#key</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto RangeRequest) (Proto RangeRequest) ByteString ByteString
-&gt; ByteString -&gt; Proto RangeRequest -&gt; Proto RangeRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680481916"><span class="hs-identifier hs-var">versionKey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span>  </span><span id="local-6989586621680481899"><span class="annot"><span class="annottext">putVersion :: Proto RequestOp
</span><a href="#local-6989586621680481899"><span class="hs-identifier hs-var hs-var">putVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-284"></span><span>    </span><span class="annot"><span class="annottext">Proto RequestOp
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-285"></span><span>      </span><span class="annot"><span class="annottext">Proto RequestOp
-&gt; (Proto RequestOp -&gt; Proto RequestOp) -&gt; Proto RequestOp
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto RequestOp)
  (Proto RequestOp)
  (Proto PutRequest)
  (Proto PutRequest)
</span><span class="">#requestPut</span></span><span>
</span><span id="line-286"></span><span>        </span><span class="annot"><span class="annottext">ASetter
  (Proto RequestOp)
  (Proto RequestOp)
  (Proto PutRequest)
  (Proto PutRequest)
-&gt; Proto PutRequest -&gt; Proto RequestOp -&gt; Proto RequestOp
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Proto PutRequest
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-287"></span><span>               </span><span class="annot"><span class="annottext">Proto PutRequest
-&gt; (Proto PutRequest -&gt; Proto PutRequest) -&gt; Proto PutRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto PutRequest) (Proto PutRequest) ByteString ByteString
</span><span class="">#key</span></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto PutRequest) (Proto PutRequest) ByteString ByteString
-&gt; ByteString -&gt; Proto PutRequest -&gt; Proto PutRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680481916"><span class="hs-identifier hs-var">versionKey</span></a></span><span>
</span><span id="line-288"></span><span>               </span><span class="annot"><span class="annottext">Proto PutRequest
-&gt; (Proto PutRequest -&gt; Proto PutRequest) -&gt; Proto PutRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto PutRequest) (Proto PutRequest) ByteString ByteString
</span><span class="">#value</span></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto PutRequest) (Proto PutRequest) ByteString ByteString
-&gt; ByteString -&gt; Proto PutRequest -&gt; Proto PutRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ProtocolVersion -&gt; ByteString
forall a. ToCBOR a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">serialize'</span></span><span> </span><span class="annot"><span class="annottext">ProtocolVersion
</span><a href="#local-6989586621680481892"><span class="hs-identifier hs-var">ourVersion</span></a></span><span>
</span><span id="line-289"></span><span>           </span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="hs-comment">-- | Broadcast messages from a queue to the etcd cluster.</span><span>
</span><span id="line-292"></span><span class="hs-comment">--</span><span>
</span><span id="line-293"></span><span class="hs-comment">-- TODO: retrying on failure even needed?</span><span>
</span><span id="line-294"></span><span class="hs-comment">-- Retries on failure to 'putMessage' in case we are on a minority cluster.</span><span>
</span><span id="line-295"></span><span id="local-6989586621680480791"><span class="annot"><a href="Hydra.Network.Etcd.html#broadcastMessages"><span class="hs-identifier hs-type">broadcastMessages</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ToCBOR</span></span><span> </span><span class="annot"><a href="#local-6989586621680480791"><span class="hs-identifier hs-type">msg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480791"><span class="hs-identifier hs-type">msg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-297"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#EtcdLog"><span class="hs-identifier hs-type">EtcdLog</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-298"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Connection</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-299"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Used to identify sender.</span></span><span>
</span><span id="line-300"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#Host"><span class="hs-identifier hs-type">Host</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-301"></span><span>  </span><span class="annot"><a href="Hydra.Network.Etcd.html#PersistentQueue"><span class="hs-identifier hs-type">PersistentQueue</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480791"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-302"></span><span>  </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-303"></span><span id="broadcastMessages"><span class="annot"><span class="annottext">broadcastMessages :: forall msg.
(ToCBOR msg, Eq msg) =&gt;
Tracer IO EtcdLog
-&gt; Connection -&gt; Host -&gt; PersistentQueue IO msg -&gt; IO ()
</span><a href="Hydra.Network.Etcd.html#broadcastMessages"><span class="hs-identifier hs-var hs-var">broadcastMessages</span></a></span></span><span> </span><span id="local-6989586621680481945"><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680481945"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680481946"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680481946"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span id="local-6989586621680481947"><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481947"><span class="hs-identifier hs-var">ourHost</span></a></span></span><span> </span><span id="local-6989586621680481948"><span class="annot"><span class="annottext">PersistentQueue IO msg
</span><a href="#local-6989586621680481948"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-304"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadCatch m =&gt; Text -&gt; m a -&gt; m a
</span><a href="Hydra.Network.Etcd.html#withGrpcContext"><span class="hs-identifier hs-var">withGrpcContext</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;broadcastMessages&quot;</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; (IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.html#forever"><span class="hs-identifier hs-var">forever</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-305"></span><span>    </span><span id="local-6989586621680481950"><span class="annot"><span class="annottext">msg
</span><a href="#local-6989586621680481950"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PersistentQueue IO msg -&gt; IO msg
forall (m :: * -&gt; *) a. MonadSTM m =&gt; PersistentQueue m a -&gt; m a
</span><a href="Hydra.Network.Etcd.html#peekPersistentQueue"><span class="hs-identifier hs-var">peekPersistentQueue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistentQueue IO msg
</span><a href="#local-6989586621680481948"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Connection -&gt; Host -&gt; msg -&gt; IO ()
forall msg. ToCBOR msg =&gt; Connection -&gt; Host -&gt; msg -&gt; IO ()
</span><a href="Hydra.Network.Etcd.html#putMessage"><span class="hs-identifier hs-var">putMessage</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680481946"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680481947"><span class="hs-identifier hs-var">ourHost</span></a></span><span> </span><span class="annot"><span class="annottext">msg
</span><a href="#local-6989586621680481950"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PersistentQueue IO msg -&gt; msg -&gt; IO ()
forall (m :: * -&gt; *) a.
(MonadSTM m, MonadIO m, Eq a) =&gt;
PersistentQueue m a -&gt; a -&gt; m ()
</span><a href="Hydra.Network.Etcd.html#popPersistentQueue"><span class="hs-identifier hs-var">popPersistentQueue</span></a></span><span> </span><span class="annot"><span class="annottext">PersistentQueue IO msg
</span><a href="#local-6989586621680481948"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">msg
</span><a href="#local-6989586621680481950"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; (GrpcException -&gt; IO ()) -&gt; IO ()
forall e a. Exception e =&gt; IO a -&gt; (e -&gt; IO a) -&gt; IO a
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catch`</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-308"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">GrpcException</span></span><span class="hs-special">{</span><span id="local-6989586621680481955"><span class="annot"><span class="annottext">GrpcError
grpcError :: GrpcError
grpcError :: GrpcException -&gt; GrpcError
</span><a href="#local-6989586621680481955"><span class="hs-identifier hs-var hs-var">grpcError</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680481957"><span class="annot"><span class="annottext">Maybe Text
grpcErrorMessage :: Maybe Text
grpcErrorMessage :: GrpcException -&gt; Maybe Text
</span><a href="#local-6989586621680481957"><span class="hs-identifier hs-var hs-var">grpcErrorMessage</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-309"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">GrpcError
</span><a href="#local-6989586621680481955"><span class="hs-identifier hs-var">grpcError</span></a></span><span> </span><span class="annot"><span class="annottext">GrpcError -&gt; GrpcError -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">GrpcError
</span><span class="hs-identifier hs-var">GrpcUnavailable</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">GrpcError
</span><a href="#local-6989586621680481955"><span class="hs-identifier hs-var">grpcError</span></a></span><span> </span><span class="annot"><span class="annottext">GrpcError -&gt; GrpcError -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">GrpcError
</span><span class="hs-identifier hs-var">GrpcDeadlineExceeded</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-310"></span><span>              </span><span class="annot"><span class="annottext">Tracer IO EtcdLog -&gt; EtcdLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680481945"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(EtcdLog -&gt; IO ()) -&gt; EtcdLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#BroadcastFailed"><span class="hs-identifier hs-type">BroadcastFailed</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:reason:EtcdLog :: Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Areason%3AEtcdLog"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Text -&gt; Text
forall a. a -&gt; Maybe a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unknown&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680481957"><span class="hs-identifier hs-var">grpcErrorMessage</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-311"></span><span>              </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
forall (m :: * -&gt; *). MonadDelay m =&gt; DiffTime -&gt; m ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">1</span></span><span>
</span><span id="line-312"></span><span>        </span><span id="local-6989586621680481964"><span class="annot"><span class="annottext">GrpcException
</span><a href="#local-6989586621680481964"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">GrpcException -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">GrpcException
</span><a href="#local-6989586621680481964"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span class="annot"><span class="hs-comment">-- | Broadcast a message to the etcd cluster.</span></span><span>
</span><span id="line-315"></span><span id="local-6989586621680480969"><span class="annot"><a href="Hydra.Network.Etcd.html#putMessage"><span class="hs-identifier hs-type">putMessage</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-316"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ToCBOR</span></span><span> </span><span class="annot"><a href="#local-6989586621680480969"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-317"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Connection</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-318"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Used to identify sender.</span></span><span>
</span><span id="line-319"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#Host"><span class="hs-identifier hs-type">Host</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-320"></span><span>  </span><span class="annot"><a href="#local-6989586621680480969"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-321"></span><span>  </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-322"></span><span id="putMessage"><span class="annot"><span class="annottext">putMessage :: forall msg. ToCBOR msg =&gt; Connection -&gt; Host -&gt; msg -&gt; IO ()
</span><a href="Hydra.Network.Etcd.html#putMessage"><span class="hs-identifier hs-var hs-var">putMessage</span></a></span></span><span> </span><span id="local-6989586621680482029"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680482029"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span id="local-6989586621680482030"><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680482030"><span class="hs-identifier hs-var">ourHost</span></a></span></span><span> </span><span id="local-6989586621680482031"><span class="annot"><span class="annottext">msg
</span><a href="#local-6989586621680482031"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-323"></span><span>  </span><span class="annot"><span class="annottext">IO (Proto PutResponse) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Proto PutResponse) -&gt; IO ())
-&gt; IO (Proto PutResponse) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
-&gt; ClientHandler'
     'NonStreaming (ReaderT Connection IO) (Protobuf KV &quot;put&quot;)
-&gt; Input (Protobuf KV &quot;put&quot;)
-&gt; IO (Output (Protobuf KV &quot;put&quot;))
forall {k} (rpc :: k) (m :: * -&gt; *).
Connection
-&gt; ClientHandler' 'NonStreaming (ReaderT Connection m) rpc
-&gt; Input rpc
-&gt; m (Output rpc)
</span><span class="hs-identifier hs-var">nonStreaming</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680482029"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {k} (rpc :: k) (styp :: StreamingType) (m :: * -&gt; *).
(CanCallRPC m, SupportsClientRpc rpc,
 SupportsStreamingType rpc styp, Default (RequestMetadata rpc)) =&gt;
ClientHandler' styp m rpc
forall rpc (styp :: StreamingType) (m :: * -&gt; *).
(CanCallRPC m, SupportsClientRpc rpc,
 SupportsStreamingType rpc styp, Default (RequestMetadata rpc)) =&gt;
ClientHandler' styp m rpc
</span><span class="hs-identifier hs-var">rpc</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Protobuf</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">KV</span></span><span> </span><span class="annot"><span class="hs-string">&quot;put&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Input (Protobuf KV &quot;put&quot;)
Proto PutRequest
</span><a href="#local-6989586621680482033"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-324"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-325"></span><span>  </span><span id="local-6989586621680482033"><span class="annot"><span class="annottext">req :: Proto PutRequest
</span><a href="#local-6989586621680482033"><span class="hs-identifier hs-var hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><span class="annottext">Proto PutRequest
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-327"></span><span>      </span><span class="annot"><span class="annottext">Proto PutRequest
-&gt; (Proto PutRequest -&gt; Proto PutRequest) -&gt; Proto PutRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto PutRequest) (Proto PutRequest) ByteString ByteString
</span><span class="">#key</span></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto PutRequest) (Proto PutRequest) ByteString ByteString
-&gt; ByteString -&gt; Proto PutRequest -&gt; Proto PutRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680482034"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-328"></span><span>      </span><span class="annot"><span class="annottext">Proto PutRequest
-&gt; (Proto PutRequest -&gt; Proto PutRequest) -&gt; Proto PutRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto PutRequest) (Proto PutRequest) ByteString ByteString
</span><span class="">#value</span></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto PutRequest) (Proto PutRequest) ByteString ByteString
-&gt; ByteString -&gt; Proto PutRequest -&gt; Proto PutRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">msg -&gt; ByteString
forall a. ToCBOR a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">serialize'</span></span><span> </span><span class="annot"><span class="annottext">msg
</span><a href="#local-6989586621680482031"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span>  </span><span id="local-6989586621680482034"><span class="annot"><span class="annottext">key :: ByteString
</span><a href="#local-6989586621680482034"><span class="hs-identifier hs-var hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. ConvertUtf8 a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">encodeUtf8</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/text-2.0.2/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ByteString) -&gt; Text -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;msg-&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Host -&gt; Text
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680482030"><span class="hs-identifier hs-var">ourHost</span></a></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span class="annot"><span class="hs-comment">-- | Fetch and wait for messages from the etcd cluster.</span></span><span>
</span><span id="line-333"></span><span id="local-6989586621680480787"><span class="annot"><a href="Hydra.Network.Etcd.html#waitMessages"><span class="hs-identifier hs-type">waitMessages</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-334"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">FromCBOR</span></span><span> </span><span class="annot"><a href="#local-6989586621680480787"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-335"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#EtcdLog"><span class="hs-identifier hs-type">EtcdLog</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-336"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Connection</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-337"></span><span>  </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-338"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#NetworkCallback"><span class="hs-identifier hs-type">NetworkCallback</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480787"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-339"></span><span>  </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-340"></span><span id="waitMessages"><span class="annot"><span class="annottext">waitMessages :: forall msg.
FromCBOR msg =&gt;
Tracer IO EtcdLog
-&gt; Connection -&gt; [Char] -&gt; NetworkCallback msg IO -&gt; IO ()
</span><a href="Hydra.Network.Etcd.html#waitMessages"><span class="hs-identifier hs-var hs-var">waitMessages</span></a></span></span><span> </span><span id="local-6989586621680482215"><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680482215"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680482216"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680482216"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span id="local-6989586621680482217"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680482217"><span class="hs-identifier hs-var">directory</span></a></span></span><span> </span><span class="annot"><a href="Hydra.Network.html#NetworkCallback"><span class="hs-identifier hs-type">NetworkCallback</span></a></span><span class="hs-special">{</span><span id="local-6989586621680482218"><span class="annot"><span class="annottext">msg -&gt; IO ()
deliver :: msg -&gt; IO ()
$sel:deliver:NetworkCallback :: forall msg (m :: * -&gt; *). NetworkCallback msg m -&gt; msg -&gt; m ()
</span><a href="#local-6989586621680482218"><span class="hs-identifier hs-var hs-var">deliver</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-341"></span><span>  </span><span id="local-6989586621680482220"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482220"><span class="hs-identifier hs-var">revision</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; IO Natural
forall (m :: * -&gt; *). MonadIO m =&gt; [Char] -&gt; m Natural
</span><a href="Hydra.Network.Etcd.html#getLastKnownRevision"><span class="hs-identifier hs-var">getLastKnownRevision</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680482217"><span class="hs-identifier hs-var">directory</span></a></span><span>
</span><span id="line-342"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadCatch m =&gt; Text -&gt; m a -&gt; m a
</span><a href="Hydra.Network.Etcd.html#withGrpcContext"><span class="hs-identifier hs-var">withGrpcContext</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;waitMessages&quot;</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; (IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.html#forever"><span class="hs-identifier hs-var">forever</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-343"></span><span>    </span><span class="hs-comment">-- NOTE: We have not observed the watch (subscription) fail even when peers</span><span>
</span><span id="line-344"></span><span>    </span><span class="hs-comment">-- leave and we end up on a minority cluster.</span><span>
</span><span id="line-345"></span><span>    </span><span class="annot"><span class="annottext">Connection
-&gt; ClientHandler'
     'BiDiStreaming (ReaderT Connection IO) (Protobuf Watch &quot;watch&quot;)
-&gt; ((NextElem (Input (Protobuf Watch &quot;watch&quot;)) -&gt; IO ())
    -&gt; IO (NextElem (Output (Protobuf Watch &quot;watch&quot;))) -&gt; IO ())
-&gt; IO ()
forall {k} (rpc :: k) (m :: * -&gt; *) r.
MonadIO m =&gt;
Connection
-&gt; ClientHandler' 'BiDiStreaming (ReaderT Connection m) rpc
-&gt; ((NextElem (Input rpc) -&gt; m ())
    -&gt; m (NextElem (Output rpc)) -&gt; m r)
-&gt; m r
</span><span class="hs-identifier hs-var">biDiStreaming</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680482216"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {k} (rpc :: k) (styp :: StreamingType) (m :: * -&gt; *).
(CanCallRPC m, SupportsClientRpc rpc,
 SupportsStreamingType rpc styp, Default (RequestMetadata rpc)) =&gt;
ClientHandler' styp m rpc
forall rpc (styp :: StreamingType) (m :: * -&gt; *).
(CanCallRPC m, SupportsClientRpc rpc,
 SupportsStreamingType rpc styp, Default (RequestMetadata rpc)) =&gt;
ClientHandler' styp m rpc
</span><span class="hs-identifier hs-var">rpc</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Protobuf</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Watch</span></span><span> </span><span class="annot"><span class="hs-string">&quot;watch&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((NextElem (Input (Protobuf Watch &quot;watch&quot;)) -&gt; IO ())
  -&gt; IO (NextElem (Output (Protobuf Watch &quot;watch&quot;))) -&gt; IO ())
 -&gt; IO ())
-&gt; ((NextElem (Input (Protobuf Watch &quot;watch&quot;)) -&gt; IO ())
    -&gt; IO (NextElem (Output (Protobuf Watch &quot;watch&quot;))) -&gt; IO ())
-&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680482222"><span class="annot"><span class="annottext">NextElem (Input (Protobuf Watch &quot;watch&quot;)) -&gt; IO ()
</span><a href="#local-6989586621680482222"><span class="hs-identifier hs-var">send</span></a></span></span><span> </span><span id="local-6989586621680482223"><span class="annot"><span class="annottext">IO (NextElem (Output (Protobuf Watch &quot;watch&quot;)))
</span><a href="#local-6989586621680482223"><span class="hs-identifier hs-var">recv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-346"></span><span>      </span><span class="hs-comment">-- NOTE: Request all keys starting with 'msg'. See also section KeyRanges</span><span>
</span><span id="line-347"></span><span>      </span><span class="hs-comment">-- in https://etcd.io/docs/v3.5/learning/api/#key-value-api</span><span>
</span><span id="line-348"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680482224"><span class="annot"><span class="annottext">watchRequest :: Proto WatchCreateRequest
</span><a href="#local-6989586621680482224"><span class="hs-identifier hs-var hs-var">watchRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-349"></span><span>            </span><span class="annot"><span class="annottext">Proto WatchCreateRequest
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-350"></span><span>              </span><span class="annot"><span class="annottext">Proto WatchCreateRequest
-&gt; (Proto WatchCreateRequest -&gt; Proto WatchCreateRequest)
-&gt; Proto WatchCreateRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto WatchCreateRequest)
  (Proto WatchCreateRequest)
  ByteString
  ByteString
</span><span class="">#key</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto WatchCreateRequest)
  (Proto WatchCreateRequest)
  ByteString
  ByteString
-&gt; ByteString
-&gt; Proto WatchCreateRequest
-&gt; Proto WatchCreateRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;msg&quot;</span></span><span>
</span><span id="line-351"></span><span>              </span><span class="annot"><span class="annottext">Proto WatchCreateRequest
-&gt; (Proto WatchCreateRequest -&gt; Proto WatchCreateRequest)
-&gt; Proto WatchCreateRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto WatchCreateRequest)
  (Proto WatchCreateRequest)
  ByteString
  ByteString
</span><span class="">#rangeEnd</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto WatchCreateRequest)
  (Proto WatchCreateRequest)
  ByteString
  ByteString
-&gt; ByteString
-&gt; Proto WatchCreateRequest
-&gt; Proto WatchCreateRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;msh&quot;</span></span><span> </span><span class="hs-comment">-- NOTE: g+1 to query prefixes</span><span>
</span><span id="line-352"></span><span>              </span><span class="annot"><span class="annottext">Proto WatchCreateRequest
-&gt; (Proto WatchCreateRequest -&gt; Proto WatchCreateRequest)
-&gt; Proto WatchCreateRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto WatchCreateRequest) (Proto WatchCreateRequest) Int64 Int64
</span><span class="">#startRevision</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto WatchCreateRequest) (Proto WatchCreateRequest) Int64 Int64
-&gt; Int64 -&gt; Proto WatchCreateRequest -&gt; Proto WatchCreateRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482220"><span class="hs-identifier hs-var">revision</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>      </span><span class="annot"><span class="annottext">NextElem (Input (Protobuf Watch &quot;watch&quot;)) -&gt; IO ()
NextElem (Proto WatchRequest) -&gt; IO ()
</span><a href="#local-6989586621680482222"><span class="hs-identifier hs-var">send</span></a></span><span> </span><span class="annot"><span class="annottext">(NextElem (Proto WatchRequest) -&gt; IO ())
-&gt; (Proto WatchRequest -&gt; NextElem (Proto WatchRequest))
-&gt; Proto WatchRequest
-&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Proto WatchRequest -&gt; NextElem (Proto WatchRequest)
forall a. a -&gt; NextElem a
</span><span class="hs-identifier hs-var">NextElem</span></span><span> </span><span class="annot"><span class="annottext">(Proto WatchRequest -&gt; IO ()) -&gt; Proto WatchRequest -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proto WatchRequest
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span> </span><span class="annot"><span class="annottext">Proto WatchRequest
-&gt; (Proto WatchRequest -&gt; Proto WatchRequest) -&gt; Proto WatchRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto WatchRequest)
  (Proto WatchRequest)
  (Proto WatchCreateRequest)
  (Proto WatchCreateRequest)
</span><span class="">#createRequest</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto WatchRequest)
  (Proto WatchRequest)
  (Proto WatchCreateRequest)
  (Proto WatchCreateRequest)
-&gt; Proto WatchCreateRequest
-&gt; Proto WatchRequest
-&gt; Proto WatchRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Proto WatchCreateRequest
</span><a href="#local-6989586621680482224"><span class="hs-identifier hs-var">watchRequest</span></a></span><span>
</span><span id="line-354"></span><span>      </span><span class="annot"><span class="annottext">IO (NextElem (Proto WatchResponse))
-&gt; (Proto WatchResponse -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m (NextElem a) -&gt; (a -&gt; m ()) -&gt; m ()
</span><span class="hs-identifier hs-var">whileNext_</span></span><span> </span><span class="annot"><span class="annottext">IO (NextElem (Output (Protobuf Watch &quot;watch&quot;)))
IO (NextElem (Proto WatchResponse))
</span><a href="#local-6989586621680482223"><span class="hs-identifier hs-var">recv</span></a></span><span> </span><span class="annot"><span class="annottext">Proto WatchResponse -&gt; IO ()
</span><a href="#local-6989586621680482226"><span class="hs-identifier hs-var">process</span></a></span><span>
</span><span id="line-355"></span><span>    </span><span class="hs-comment">-- Wait before re-trying</span><span>
</span><span id="line-356"></span><span>    </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
forall (m :: * -&gt; *). MonadDelay m =&gt; DiffTime -&gt; m ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">1</span></span><span>
</span><span id="line-357"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-358"></span><span>  </span><span id="local-6989586621680482226"><span class="annot"><span class="annottext">process :: Proto WatchResponse -&gt; IO ()
</span><a href="#local-6989586621680482226"><span class="hs-identifier hs-var hs-var">process</span></a></span></span><span> </span><span id="local-6989586621680482227"><span class="annot"><span class="annottext">Proto WatchResponse
</span><a href="#local-6989586621680482227"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-359"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680482228"><span class="annot"><span class="annottext">revision :: Natural
</span><a href="#local-6989586621680482228"><span class="hs-identifier hs-var hs-var">revision</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; Natural
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Int64 -&gt; Natural) -&gt; Int64 -&gt; Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proto WatchResponse
</span><a href="#local-6989586621680482227"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Proto WatchResponse
-&gt; Getting Int64 (Proto WatchResponse) Int64 -&gt; Int64
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(Proto ResponseHeader -&gt; Const Int64 (Proto ResponseHeader))
-&gt; Proto WatchResponse -&gt; Const Int64 (Proto WatchResponse)
</span><span class="">#header</span></span><span> </span><span class="annot"><span class="annottext">((Proto ResponseHeader -&gt; Const Int64 (Proto ResponseHeader))
 -&gt; Proto WatchResponse -&gt; Const Int64 (Proto WatchResponse))
-&gt; ((Int64 -&gt; Const Int64 Int64)
    -&gt; Proto ResponseHeader -&gt; Const Int64 (Proto ResponseHeader))
-&gt; Getting Int64 (Proto WatchResponse) Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Int64 -&gt; Const Int64 Int64)
-&gt; Proto ResponseHeader -&gt; Const Int64 (Proto ResponseHeader)
</span><span class="">#revision</span></span><span>
</span><span id="line-360"></span><span>    </span><span class="annot"><span class="annottext">[Char] -&gt; Natural -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; [Char] -&gt; Natural -&gt; m ()
</span><a href="Hydra.Network.Etcd.html#putLastKnownRevision"><span class="hs-identifier hs-var">putLastKnownRevision</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680482217"><span class="hs-identifier hs-var">directory</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482228"><span class="hs-identifier hs-var">revision</span></a></span><span>
</span><span id="line-361"></span><span>    </span><span class="annot"><span class="annottext">[Proto Event] -&gt; (Proto Event -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proto WatchResponse
</span><a href="#local-6989586621680482227"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Proto WatchResponse
-&gt; Getting [Proto Event] (Proto WatchResponse) [Proto Event]
-&gt; [Proto Event]
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting [Proto Event] (Proto WatchResponse) [Proto Event]
</span><span class="">#events</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Proto Event -&gt; IO ()) -&gt; IO ())
-&gt; (Proto Event -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680482230"><span class="annot"><span class="annottext">Proto Event
</span><a href="#local-6989586621680482230"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-362"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680482231"><span class="annot"><span class="annottext">value :: ByteString
</span><a href="#local-6989586621680482231"><span class="hs-identifier hs-var hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proto Event
</span><a href="#local-6989586621680482230"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">Proto Event
-&gt; Getting ByteString (Proto Event) ByteString -&gt; ByteString
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(Proto KeyValue -&gt; Const ByteString (Proto KeyValue))
-&gt; Proto Event -&gt; Const ByteString (Proto Event)
</span><span class="">#kv</span></span><span> </span><span class="annot"><span class="annottext">((Proto KeyValue -&gt; Const ByteString (Proto KeyValue))
 -&gt; Proto Event -&gt; Const ByteString (Proto Event))
-&gt; Getting ByteString (Proto KeyValue) ByteString
-&gt; Getting ByteString (Proto Event) ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting ByteString (Proto KeyValue) ByteString
</span><span class="">#value</span></span><span>
</span><span id="line-363"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Either DecoderError msg
forall a. FromCBOR a =&gt; ByteString -&gt; Either DecoderError a
</span><span class="hs-identifier hs-var">decodeFull'</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680482231"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-364"></span><span>        </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680482232"><span class="annot"><span class="annottext">DecoderError
</span><a href="#local-6989586621680482232"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-365"></span><span>          </span><span class="annot"><span class="annottext">Tracer IO EtcdLog -&gt; EtcdLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span>
</span><span id="line-366"></span><span>            </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680482215"><span class="hs-identifier hs-var">tracer</span></a></span><span>
</span><span id="line-367"></span><span>            </span><span class="annot"><a href="Hydra.Network.Etcd.html#FailedToDecodeValue"><span class="hs-identifier hs-type">FailedToDecodeValue</span></a></span><span>
</span><span id="line-368"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:key:EtcdLog :: Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Akey%3AEtcdLog"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
forall a b. ConvertUtf8 a b =&gt; b -&gt; a
</span><span class="hs-identifier hs-var">decodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Text) -&gt; ByteString -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proto Event
</span><a href="#local-6989586621680482230"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="annot"><span class="annottext">Proto Event
-&gt; Getting ByteString (Proto Event) ByteString -&gt; ByteString
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(Proto KeyValue -&gt; Const ByteString (Proto KeyValue))
-&gt; Proto Event -&gt; Const ByteString (Proto Event)
</span><span class="">#kv</span></span><span> </span><span class="annot"><span class="annottext">((Proto KeyValue -&gt; Const ByteString (Proto KeyValue))
 -&gt; Proto Event -&gt; Const ByteString (Proto Event))
-&gt; Getting ByteString (Proto KeyValue) ByteString
-&gt; Getting ByteString (Proto Event) ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting ByteString (Proto KeyValue) ByteString
</span><span class="">#key</span></span><span>
</span><span id="line-369"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:value:EtcdLog :: Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Avalue%3AEtcdLog"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><span class="hs-identifier hs-var">encodeBase16</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680482231"><span class="hs-identifier hs-var">value</span></a></span><span>
</span><span id="line-370"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:reason:EtcdLog :: Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Areason%3AEtcdLog"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DecoderError -&gt; Text
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">DecoderError
</span><a href="#local-6989586621680482232"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-371"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-372"></span><span>        </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680482233"><span class="annot"><span class="annottext">msg
</span><a href="#local-6989586621680482233"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">msg -&gt; IO ()
</span><a href="#local-6989586621680482218"><span class="hs-identifier hs-var">deliver</span></a></span><span> </span><span class="annot"><span class="annottext">msg
</span><a href="#local-6989586621680482233"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span id="local-6989586621680480995"><span class="annot"><a href="Hydra.Network.Etcd.html#getLastKnownRevision"><span class="hs-identifier hs-type">getLastKnownRevision</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.IO.Class.html#MonadIO"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480995"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680480995"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-bignum-1.3/src/GHC.Num.Natural.html#Natural"><span class="hs-identifier hs-type">Natural</span></a></span></span><span>
</span><span id="line-375"></span><span id="getLastKnownRevision"><span class="annot"><span class="annottext">getLastKnownRevision :: forall (m :: * -&gt; *). MonadIO m =&gt; [Char] -&gt; m Natural
</span><a href="Hydra.Network.Etcd.html#getLastKnownRevision"><span class="hs-identifier hs-var hs-var">getLastKnownRevision</span></a></span></span><span> </span><span id="local-6989586621680482253"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680482253"><span class="hs-identifier hs-var">directory</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-376"></span><span>  </span><span class="annot"><span class="annottext">IO Natural -&gt; m Natural
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Natural -&gt; m Natural) -&gt; IO Natural -&gt; m Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-377"></span><span>    </span><span class="annot"><span class="annottext">IO (Maybe Natural) -&gt; IO (Either IOException (Maybe Natural))
forall e a. Exception e =&gt; IO a -&gt; IO (Either e a)
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; IO (Maybe Natural)
forall a. FromJSON a =&gt; [Char] -&gt; IO (Maybe a)
</span><span class="hs-identifier hs-var">decodeFileStrict'</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; IO (Maybe Natural)) -&gt; [Char] -&gt; IO (Maybe Natural)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680482253"><span class="hs-identifier hs-var">directory</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/filepath-1.4.300.1/src/System.FilePath.Posix.html#%3C%2F%3E"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;last-known-revision&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO (Either IOException (Maybe Natural))
-&gt; (Either IOException (Maybe Natural) -&gt; IO Natural) -&gt; IO Natural
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-378"></span><span>      </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680482256"><span class="annot"><span class="annottext">Maybe Natural
</span><a href="#local-6989586621680482256"><span class="hs-identifier hs-var">rev</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-379"></span><span>        </span><span class="annot"><span class="annottext">Natural -&gt; IO Natural
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; IO Natural) -&gt; Natural -&gt; IO Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Maybe Natural -&gt; Natural
forall a. a -&gt; Maybe a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Maybe Natural
</span><a href="#local-6989586621680482256"><span class="hs-identifier hs-var">rev</span></a></span><span>
</span><span id="line-380"></span><span>      </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680482257"><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621680482257"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.Exception.html#IOException"><span class="hs-identifier hs-type">IOException</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-381"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IOException -&gt; Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/System.IO.Error.html#isDoesNotExistError"><span class="hs-identifier hs-var">isDoesNotExistError</span></a></span><span> </span><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621680482257"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; IO Natural
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span>
</span><span id="line-382"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-383"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; IO Natural
forall a. [Char] -&gt; IO a
forall (m :: * -&gt; *) a. MonadFail m =&gt; [Char] -&gt; m a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.Fail.html#fail"><span class="hs-identifier hs-var">fail</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; IO Natural) -&gt; [Char] -&gt; IO Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Failed to load last known revision: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IOException -&gt; [Char]
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621680482257"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span id="local-6989586621680481006"><span class="annot"><a href="Hydra.Network.Etcd.html#putLastKnownRevision"><span class="hs-identifier hs-type">putLastKnownRevision</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.IO.Class.html#MonadIO"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680481006"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-bignum-1.3/src/GHC.Num.Natural.html#Natural"><span class="hs-identifier hs-type">Natural</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680481006"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-386"></span><span id="putLastKnownRevision"><span class="annot"><span class="annottext">putLastKnownRevision :: forall (m :: * -&gt; *). MonadIO m =&gt; [Char] -&gt; Natural -&gt; m ()
</span><a href="Hydra.Network.Etcd.html#putLastKnownRevision"><span class="hs-identifier hs-var hs-var">putLastKnownRevision</span></a></span></span><span> </span><span id="local-6989586621680482262"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680482262"><span class="hs-identifier hs-var">directory</span></a></span></span><span> </span><span id="local-6989586621680482263"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482263"><span class="hs-identifier hs-var">rev</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-387"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Natural -&gt; IO ()
forall a. ToJSON a =&gt; [Char] -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">encodeFile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680482262"><span class="hs-identifier hs-var">directory</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/filepath-1.4.300.1/src/System.FilePath.Posix.html#%3C%2F%3E"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;last-known-revision&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482263"><span class="hs-identifier hs-var">rev</span></a></span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span class="hs-comment">-- | Write a well-known key to indicate being alive, keep it alive using a lease</span><span>
</span><span id="line-390"></span><span class="hs-comment">-- and poll other peers entries to yield connectivity events. While doing so,</span><span>
</span><span id="line-391"></span><span class="hs-comment">-- overall network connectivity is determined from the ability to read/write to</span><span>
</span><span id="line-392"></span><span class="hs-comment">-- the cluster.</span><span>
</span><span id="line-393"></span><span id="local-6989586621680480786"><span class="annot"><a href="Hydra.Network.Etcd.html#pollConnectivity"><span class="hs-identifier hs-type">pollConnectivity</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-394"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#EtcdLog"><span class="hs-identifier hs-type">EtcdLog</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-395"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Connection</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-396"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Local host</span></span><span>
</span><span id="line-397"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#Host"><span class="hs-identifier hs-type">Host</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-398"></span><span>  </span><span class="annot"><a href="Hydra.Network.html#NetworkCallback"><span class="hs-identifier hs-type">NetworkCallback</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480786"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-399"></span><span>  </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-400"></span><span id="pollConnectivity"><span class="annot"><span class="annottext">pollConnectivity :: forall msg.
Tracer IO EtcdLog
-&gt; Connection -&gt; Host -&gt; NetworkCallback msg IO -&gt; IO ()
</span><a href="Hydra.Network.Etcd.html#pollConnectivity"><span class="hs-identifier hs-var hs-var">pollConnectivity</span></a></span></span><span> </span><span id="local-6989586621680482591"><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680482591"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680482592"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680482592"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span id="local-6989586621680482593"><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680482593"><span class="hs-identifier hs-var">advertise</span></a></span></span><span> </span><span class="annot"><a href="Hydra.Network.html#NetworkCallback"><span class="hs-identifier hs-type">NetworkCallback</span></a></span><span class="hs-special">{</span><span id="local-6989586621680482594"><span class="annot"><span class="annottext">Connectivity -&gt; IO ()
$sel:onConnectivity:NetworkCallback :: forall msg (m :: * -&gt; *).
NetworkCallback msg m -&gt; Connectivity -&gt; m ()
onConnectivity :: Connectivity -&gt; IO ()
</span><a href="Hydra.Network.html#%24sel%3AonConnectivity%3ANetworkCallback"><span class="hs-identifier hs-var hs-var">onConnectivity</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-401"></span><span>  </span><span id="local-6989586621680482595"><span class="annot"><span class="annottext">TVar [Host]
</span><a href="#local-6989586621680482595"><span class="hs-identifier hs-var">seenAliveVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Host] -&gt; IO (TVar IO [Host])
forall a. a -&gt; IO (TVar IO a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (TVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-402"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadCatch m =&gt; Text -&gt; m a -&gt; m a
</span><a href="Hydra.Network.Etcd.html#withGrpcContext"><span class="hs-identifier hs-var">withGrpcContext</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;pollConnectivity&quot;</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-403"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.html#forever"><span class="hs-identifier hs-var">forever</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; (IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(GrpcException -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall e a. Exception e =&gt; (e -&gt; IO a) -&gt; IO a -&gt; IO a
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; m a) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">handle</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar [Host] -&gt; GrpcException -&gt; IO ()
</span><a href="#local-6989586621680482597"><span class="hs-identifier hs-var">onGrpcException</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [Host]
</span><a href="#local-6989586621680482595"><span class="hs-identifier hs-var">seenAliveVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-404"></span><span>      </span><span id="local-6989586621680482598"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621680482598"><span class="hs-identifier hs-var">leaseId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Int64
</span><a href="#local-6989586621680482599"><span class="hs-identifier hs-var">createLease</span></a></span><span>
</span><span id="line-405"></span><span>      </span><span class="hs-comment">-- If we can create a lease, we are connected</span><span>
</span><span id="line-406"></span><span>      </span><span class="annot"><span class="annottext">Connectivity -&gt; IO ()
</span><a href="#local-6989586621680482594"><span class="hs-identifier hs-var">onConnectivity</span></a></span><span> </span><span class="annot"><span class="annottext">Connectivity
</span><a href="Hydra.Network.html#NetworkConnected"><span class="hs-identifier hs-var">NetworkConnected</span></a></span><span>
</span><span id="line-407"></span><span>      </span><span class="hs-comment">-- Write our alive key using lease</span><span>
</span><span id="line-408"></span><span>      </span><span class="annot"><span class="annottext">Int64 -&gt; IO ()
</span><a href="#local-6989586621680482601"><span class="hs-identifier hs-var">writeAlive</span></a></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621680482598"><span class="hs-identifier hs-var">leaseId</span></a></span><span>
</span><span id="line-409"></span><span>      </span><span class="annot"><span class="annottext">Tracer IO EtcdLog -&gt; EtcdLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680482591"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#CreatedLease"><span class="hs-identifier hs-type">CreatedLease</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">Int64
leaseId :: Int64
$sel:leaseId:EtcdLog :: Int64
</span><a href="#local-6989586621680482598"><span class="hs-identifier hs-var hs-var">leaseId</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-410"></span><span>      </span><span class="annot"><span class="annottext">Int64 -&gt; (IO DiffTime -&gt; IO Any) -&gt; IO ()
</span><a href="#local-6989586621680482604"><span class="hs-identifier hs-var">withKeepAlive</span></a></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621680482598"><span class="hs-identifier hs-var">leaseId</span></a></span><span> </span><span class="annot"><span class="annottext">((IO DiffTime -&gt; IO Any) -&gt; IO ())
-&gt; (IO DiffTime -&gt; IO Any) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680482605"><span class="annot"><span class="annottext">IO DiffTime
</span><a href="#local-6989586621680482605"><span class="hs-identifier hs-var">keepAlive</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-411"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; IO Any
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.html#forever"><span class="hs-identifier hs-var">forever</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO Any) -&gt; IO () -&gt; IO Any
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-412"></span><span>          </span><span class="hs-comment">-- Keep our lease alive</span><span>
</span><span id="line-413"></span><span>          </span><span id="local-6989586621680482606"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621680482606"><span class="hs-identifier hs-var">ttlRemaining</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO DiffTime
</span><a href="#local-6989586621680482605"><span class="hs-identifier hs-var">keepAlive</span></a></span><span>
</span><span id="line-414"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621680482606"><span class="hs-identifier hs-var">ttlRemaining</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-415"></span><span>            </span><span class="annot"><span class="annottext">Tracer IO EtcdLog -&gt; EtcdLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680482591"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#LowLeaseTTL"><span class="hs-identifier hs-type">LowLeaseTTL</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">DiffTime
ttlRemaining :: DiffTime
$sel:ttlRemaining:EtcdLog :: DiffTime
</span><a href="#local-6989586621680482606"><span class="hs-identifier hs-var hs-var">ttlRemaining</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-416"></span><span>          </span><span class="hs-comment">-- Determine alive peers</span><span>
</span><span id="line-417"></span><span>          </span><span id="local-6989586621680482611"><span class="annot"><span class="annottext">[Host]
</span><a href="#local-6989586621680482611"><span class="hs-identifier hs-var">alive</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [Host]
</span><a href="#local-6989586621680482612"><span class="hs-identifier hs-var">getAlive</span></a></span><span>
</span><span id="line-418"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680482613"><span class="annot"><span class="annottext">othersAlive :: [Host]
</span><a href="#local-6989586621680482613"><span class="hs-identifier hs-var hs-var">othersAlive</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Host]
</span><a href="#local-6989586621680482611"><span class="hs-identifier hs-var">alive</span></a></span><span> </span><span class="annot"><span class="annottext">[Host] -&gt; [Host] -&gt; [Host]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.OldList.html#%5C%5C"><span class="hs-operator hs-var">\\</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680482593"><span class="hs-identifier hs-var">advertise</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-419"></span><span>          </span><span id="local-6989586621680482614"><span class="annot"><span class="annottext">[Host]
</span><a href="#local-6989586621680482614"><span class="hs-identifier hs-var">seenAlive</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM IO [Host] -&gt; IO [Host]
forall a. HasCallStack =&gt; STM IO a -&gt; IO a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM IO [Host] -&gt; IO [Host]) -&gt; STM IO [Host] -&gt; IO [Host]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TVar IO [Host] -&gt; [Host] -&gt; STM IO [Host]
forall a. TVar IO a -&gt; a -&gt; STM IO a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m a
</span><span class="hs-identifier hs-var">swapTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar [Host]
TVar IO [Host]
</span><a href="#local-6989586621680482595"><span class="hs-identifier hs-var">seenAliveVar</span></a></span><span> </span><span class="annot"><span class="annottext">[Host]
</span><a href="#local-6989586621680482613"><span class="hs-identifier hs-var">othersAlive</span></a></span><span>
</span><span id="line-420"></span><span>          </span><span class="annot"><span class="annottext">[Host] -&gt; (Host -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Host]
</span><a href="#local-6989586621680482613"><span class="hs-identifier hs-var">othersAlive</span></a></span><span> </span><span class="annot"><span class="annottext">[Host] -&gt; [Host] -&gt; [Host]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.OldList.html#%5C%5C"><span class="hs-operator hs-var">\\</span></a></span><span> </span><span class="annot"><span class="annottext">[Host]
</span><a href="#local-6989586621680482614"><span class="hs-identifier hs-var">seenAlive</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Host -&gt; IO ()) -&gt; IO ()) -&gt; (Host -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Connectivity -&gt; IO ()
</span><a href="#local-6989586621680482594"><span class="hs-identifier hs-var">onConnectivity</span></a></span><span> </span><span class="annot"><span class="annottext">(Connectivity -&gt; IO ()) -&gt; (Host -&gt; Connectivity) -&gt; Host -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Host -&gt; Connectivity
</span><a href="Hydra.Network.html#PeerConnected"><span class="hs-identifier hs-var">PeerConnected</span></a></span><span>
</span><span id="line-421"></span><span>          </span><span class="annot"><span class="annottext">[Host] -&gt; (Host -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Host]
</span><a href="#local-6989586621680482614"><span class="hs-identifier hs-var">seenAlive</span></a></span><span> </span><span class="annot"><span class="annottext">[Host] -&gt; [Host] -&gt; [Host]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.OldList.html#%5C%5C"><span class="hs-operator hs-var">\\</span></a></span><span> </span><span class="annot"><span class="annottext">[Host]
</span><a href="#local-6989586621680482613"><span class="hs-identifier hs-var">othersAlive</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Host -&gt; IO ()) -&gt; IO ()) -&gt; (Host -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Connectivity -&gt; IO ()
</span><a href="#local-6989586621680482594"><span class="hs-identifier hs-var">onConnectivity</span></a></span><span> </span><span class="annot"><span class="annottext">(Connectivity -&gt; IO ()) -&gt; (Host -&gt; Connectivity) -&gt; Host -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Host -&gt; Connectivity
</span><a href="Hydra.Network.html#PeerDisconnected"><span class="hs-identifier hs-var">PeerDisconnected</span></a></span><span>
</span><span id="line-422"></span><span>          </span><span class="hs-comment">-- Wait roughly ttl / 2</span><span>
</span><span id="line-423"></span><span>          </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
forall (m :: * -&gt; *). MonadDelay m =&gt; DiffTime -&gt; m ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621680482606"><span class="hs-identifier hs-var">ttlRemaining</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime -&gt; DiffTime
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Real.html#%2F"><span class="hs-operator hs-var">/</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-425"></span><span>  </span><span id="local-6989586621680482597"><span class="annot"><span class="annottext">onGrpcException :: TVar [Host] -&gt; GrpcException -&gt; IO ()
</span><a href="#local-6989586621680482597"><span class="hs-identifier hs-var hs-var">onGrpcException</span></a></span></span><span> </span><span id="local-6989586621680482618"><span class="annot"><span class="annottext">TVar [Host]
</span><a href="#local-6989586621680482618"><span class="hs-identifier hs-var">seenAliveVar</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">GrpcException</span></span><span class="hs-special">{</span><span id="local-6989586621680482619"><span class="annot"><span class="annottext">GrpcError
grpcError :: GrpcException -&gt; GrpcError
grpcError :: GrpcError
</span><span class="hs-identifier hs-var hs-var">grpcError</span></span></span><span class="hs-special">}</span><span>
</span><span id="line-426"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">GrpcError
</span><a href="#local-6989586621680482619"><span class="hs-identifier hs-var">grpcError</span></a></span><span> </span><span class="annot"><span class="annottext">GrpcError -&gt; GrpcError -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">GrpcError
</span><span class="hs-identifier hs-var">GrpcUnavailable</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">GrpcError
</span><a href="#local-6989586621680482619"><span class="hs-identifier hs-var">grpcError</span></a></span><span> </span><span class="annot"><span class="annottext">GrpcError -&gt; GrpcError -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">GrpcError
</span><span class="hs-identifier hs-var">GrpcDeadlineExceeded</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-427"></span><span>        </span><span class="annot"><span class="annottext">Connectivity -&gt; IO ()
</span><a href="#local-6989586621680482594"><span class="hs-identifier hs-var">onConnectivity</span></a></span><span> </span><span class="annot"><span class="annottext">Connectivity
</span><a href="Hydra.Network.html#NetworkDisconnected"><span class="hs-identifier hs-var">NetworkDisconnected</span></a></span><span>
</span><span id="line-428"></span><span>        </span><span class="annot"><span class="annottext">STM IO () -&gt; IO ()
forall a. HasCallStack =&gt; STM IO a -&gt; IO a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM IO () -&gt; IO ()) -&gt; STM IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TVar IO [Host] -&gt; [Host] -&gt; STM IO ()
forall a. TVar IO a -&gt; a -&gt; STM IO ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar [Host]
TVar IO [Host]
</span><a href="#local-6989586621680482618"><span class="hs-identifier hs-var">seenAliveVar</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-429"></span><span>        </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
forall (m :: * -&gt; *). MonadDelay m =&gt; DiffTime -&gt; m ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">1</span></span><span>
</span><span id="line-430"></span><span>  </span><span class="annot"><a href="#local-6989586621680482597"><span class="hs-identifier hs-var">onGrpcException</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [Host]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680482621"><span class="annot"><span class="annottext">GrpcException
</span><a href="#local-6989586621680482621"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GrpcException -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">GrpcException
</span><a href="#local-6989586621680482621"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span>  </span><span id="local-6989586621680482599"><span class="annot"><span class="annottext">createLease :: IO Int64
</span><a href="#local-6989586621680482599"><span class="hs-identifier hs-var hs-var">createLease</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO Int64 -&gt; IO Int64
forall (m :: * -&gt; *) a. MonadCatch m =&gt; Text -&gt; m a -&gt; m a
</span><a href="Hydra.Network.Etcd.html#withGrpcContext"><span class="hs-identifier hs-var">withGrpcContext</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;createLease&quot;</span></span><span> </span><span class="annot"><span class="annottext">(IO Int64 -&gt; IO Int64) -&gt; IO Int64 -&gt; IO Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-433"></span><span>    </span><span id="local-6989586621680482622"><span class="annot"><span class="annottext">Proto LeaseGrantResponse
</span><a href="#local-6989586621680482622"><span class="hs-identifier hs-var">leaseResponse</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-434"></span><span>      </span><span class="annot"><span class="annottext">Connection
-&gt; ClientHandler'
     'NonStreaming (ReaderT Connection IO) (Protobuf Lease &quot;leaseGrant&quot;)
-&gt; Input (Protobuf Lease &quot;leaseGrant&quot;)
-&gt; IO (Output (Protobuf Lease &quot;leaseGrant&quot;))
forall {k} (rpc :: k) (m :: * -&gt; *).
Connection
-&gt; ClientHandler' 'NonStreaming (ReaderT Connection m) rpc
-&gt; Input rpc
-&gt; m (Output rpc)
</span><span class="hs-identifier hs-var">nonStreaming</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680482592"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {k} (rpc :: k) (styp :: StreamingType) (m :: * -&gt; *).
(CanCallRPC m, SupportsClientRpc rpc,
 SupportsStreamingType rpc styp, Default (RequestMetadata rpc)) =&gt;
ClientHandler' styp m rpc
forall rpc (styp :: StreamingType) (m :: * -&gt; *).
(CanCallRPC m, SupportsClientRpc rpc,
 SupportsStreamingType rpc styp, Default (RequestMetadata rpc)) =&gt;
ClientHandler' styp m rpc
</span><span class="hs-identifier hs-var">rpc</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Protobuf</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Lease</span></span><span> </span><span class="annot"><span class="hs-string">&quot;leaseGrant&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Input (Protobuf Lease &quot;leaseGrant&quot;)
 -&gt; IO (Output (Protobuf Lease &quot;leaseGrant&quot;)))
-&gt; Input (Protobuf Lease &quot;leaseGrant&quot;)
-&gt; IO (Output (Protobuf Lease &quot;leaseGrant&quot;))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-435"></span><span>        </span><span class="annot"><span class="annottext">Proto LeaseGrantRequest
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span> </span><span class="annot"><span class="annottext">Proto LeaseGrantRequest
-&gt; (Proto LeaseGrantRequest -&gt; Proto LeaseGrantRequest)
-&gt; Proto LeaseGrantRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto LeaseGrantRequest) (Proto LeaseGrantRequest) Int64 Int64
</span><span class="">#ttl</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto LeaseGrantRequest) (Proto LeaseGrantRequest) Int64 Int64
-&gt; Int64 -&gt; Proto LeaseGrantRequest -&gt; Proto LeaseGrantRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">3</span></span><span>
</span><span id="line-436"></span><span>    </span><span class="annot"><span class="annottext">Int64 -&gt; IO Int64
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Int64 -&gt; IO Int64) -&gt; Int64 -&gt; IO Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proto LeaseGrantResponse
</span><a href="#local-6989586621680482622"><span class="hs-identifier hs-var">leaseResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Proto LeaseGrantResponse
-&gt; Getting Int64 (Proto LeaseGrantResponse) Int64 -&gt; Int64
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Int64 (Proto LeaseGrantResponse) Int64
</span><span class="">#id</span></span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span>  </span><span id="local-6989586621680482604"><span class="annot"><span class="annottext">withKeepAlive :: Int64 -&gt; (IO DiffTime -&gt; IO Any) -&gt; IO ()
</span><a href="#local-6989586621680482604"><span class="hs-identifier hs-var hs-var">withKeepAlive</span></a></span></span><span> </span><span id="local-6989586621680482623"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621680482623"><span class="hs-identifier hs-var">leaseId</span></a></span></span><span> </span><span id="local-6989586621680482624"><span class="annot"><span class="annottext">IO DiffTime -&gt; IO Any
</span><a href="#local-6989586621680482624"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-439"></span><span>    </span><span class="annot"><span class="annottext">Connection
-&gt; ClientHandler'
     'BiDiStreaming
     (ReaderT Connection IO)
     (Protobuf Lease &quot;leaseKeepAlive&quot;)
-&gt; ((NextElem (Input (Protobuf Lease &quot;leaseKeepAlive&quot;)) -&gt; IO ())
    -&gt; IO (NextElem (Output (Protobuf Lease &quot;leaseKeepAlive&quot;)))
    -&gt; IO ())
-&gt; IO ()
forall {k} (rpc :: k) (m :: * -&gt; *) r.
MonadIO m =&gt;
Connection
-&gt; ClientHandler' 'BiDiStreaming (ReaderT Connection m) rpc
-&gt; ((NextElem (Input rpc) -&gt; m ())
    -&gt; m (NextElem (Output rpc)) -&gt; m r)
-&gt; m r
</span><span class="hs-identifier hs-var">biDiStreaming</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680482592"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {k} (rpc :: k) (styp :: StreamingType) (m :: * -&gt; *).
(CanCallRPC m, SupportsClientRpc rpc,
 SupportsStreamingType rpc styp, Default (RequestMetadata rpc)) =&gt;
ClientHandler' styp m rpc
forall rpc (styp :: StreamingType) (m :: * -&gt; *).
(CanCallRPC m, SupportsClientRpc rpc,
 SupportsStreamingType rpc styp, Default (RequestMetadata rpc)) =&gt;
ClientHandler' styp m rpc
</span><span class="hs-identifier hs-var">rpc</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Protobuf</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Lease</span></span><span> </span><span class="annot"><span class="hs-string">&quot;leaseKeepAlive&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((NextElem (Input (Protobuf Lease &quot;leaseKeepAlive&quot;)) -&gt; IO ())
  -&gt; IO (NextElem (Output (Protobuf Lease &quot;leaseKeepAlive&quot;)))
  -&gt; IO ())
 -&gt; IO ())
-&gt; ((NextElem (Input (Protobuf Lease &quot;leaseKeepAlive&quot;)) -&gt; IO ())
    -&gt; IO (NextElem (Output (Protobuf Lease &quot;leaseKeepAlive&quot;)))
    -&gt; IO ())
-&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680482625"><span class="annot"><span class="annottext">NextElem (Input (Protobuf Lease &quot;leaseKeepAlive&quot;)) -&gt; IO ()
</span><a href="#local-6989586621680482625"><span class="hs-identifier hs-var">send</span></a></span></span><span> </span><span id="local-6989586621680482626"><span class="annot"><span class="annottext">IO (NextElem (Output (Protobuf Lease &quot;leaseKeepAlive&quot;)))
</span><a href="#local-6989586621680482626"><span class="hs-identifier hs-var">recv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-440"></span><span>      </span><span class="annot"><span class="annottext">IO Any -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Any -&gt; IO ())
-&gt; (IO DiffTime -&gt; IO Any) -&gt; IO DiffTime -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO DiffTime -&gt; IO Any
</span><a href="#local-6989586621680482624"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">(IO DiffTime -&gt; IO ()) -&gt; IO DiffTime -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-441"></span><span>        </span><span class="annot"><span class="annottext">NextElem (Input (Protobuf Lease &quot;leaseKeepAlive&quot;)) -&gt; IO ()
</span><a href="#local-6989586621680482625"><span class="hs-identifier hs-var">send</span></a></span><span> </span><span class="annot"><span class="annottext">(NextElem (Input (Protobuf Lease &quot;leaseKeepAlive&quot;)) -&gt; IO ())
-&gt; NextElem (Input (Protobuf Lease &quot;leaseKeepAlive&quot;)) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Input (Protobuf Lease &quot;leaseKeepAlive&quot;)
-&gt; NextElem (Input (Protobuf Lease &quot;leaseKeepAlive&quot;))
forall a. a -&gt; NextElem a
</span><span class="hs-identifier hs-var">NextElem</span></span><span> </span><span class="annot"><span class="annottext">(Input (Protobuf Lease &quot;leaseKeepAlive&quot;)
 -&gt; NextElem (Input (Protobuf Lease &quot;leaseKeepAlive&quot;)))
-&gt; Input (Protobuf Lease &quot;leaseKeepAlive&quot;)
-&gt; NextElem (Input (Protobuf Lease &quot;leaseKeepAlive&quot;))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proto LeaseKeepAliveRequest
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span> </span><span class="annot"><span class="annottext">Proto LeaseKeepAliveRequest
-&gt; (Proto LeaseKeepAliveRequest -&gt; Proto LeaseKeepAliveRequest)
-&gt; Proto LeaseKeepAliveRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto LeaseKeepAliveRequest)
  (Proto LeaseKeepAliveRequest)
  Int64
  Int64
</span><span class="">#id</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto LeaseKeepAliveRequest)
  (Proto LeaseKeepAliveRequest)
  Int64
  Int64
-&gt; Int64
-&gt; Proto LeaseKeepAliveRequest
-&gt; Proto LeaseKeepAliveRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621680482623"><span class="hs-identifier hs-var">leaseId</span></a></span><span>
</span><span id="line-442"></span><span>        </span><span class="annot"><span class="annottext">IO (NextElem (Output (Protobuf Lease &quot;leaseKeepAlive&quot;)))
IO (NextElem (Proto LeaseKeepAliveResponse))
</span><a href="#local-6989586621680482626"><span class="hs-identifier hs-var">recv</span></a></span><span> </span><span class="annot"><span class="annottext">IO (NextElem (Proto LeaseKeepAliveResponse))
-&gt; (NextElem (Proto LeaseKeepAliveResponse) -&gt; IO DiffTime)
-&gt; IO DiffTime
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-443"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">NextElem</span></span><span> </span><span id="local-6989586621680482627"><span class="annot"><span class="annottext">Proto LeaseKeepAliveResponse
</span><a href="#local-6989586621680482627"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; IO DiffTime
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(DiffTime -&gt; IO DiffTime)
-&gt; (Int64 -&gt; DiffTime) -&gt; Int64 -&gt; IO DiffTime
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; DiffTime
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Int64 -&gt; IO DiffTime) -&gt; Int64 -&gt; IO DiffTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proto LeaseKeepAliveResponse
</span><a href="#local-6989586621680482627"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Proto LeaseKeepAliveResponse
-&gt; Getting Int64 (Proto LeaseKeepAliveResponse) Int64 -&gt; Int64
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Int64 (Proto LeaseKeepAliveResponse) Int64
</span><span class="">#ttl</span></span><span>
</span><span id="line-444"></span><span>          </span><span class="annot"><span class="annottext">NextElem (Proto LeaseKeepAliveResponse)
</span><span class="hs-identifier hs-var">NoNextElem</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-445"></span><span>            </span><span class="annot"><span class="annottext">Tracer IO EtcdLog -&gt; EtcdLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680482591"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">EtcdLog
</span><a href="Hydra.Network.Etcd.html#NoKeepAliveResponse"><span class="hs-identifier hs-var">NoKeepAliveResponse</span></a></span><span>
</span><span id="line-446"></span><span>            </span><span class="annot"><span class="annottext">DiffTime -&gt; IO DiffTime
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">0</span></span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span>  </span><span id="local-6989586621680482601"><span class="annot"><span class="annottext">writeAlive :: Int64 -&gt; IO ()
</span><a href="#local-6989586621680482601"><span class="hs-identifier hs-var hs-var">writeAlive</span></a></span></span><span> </span><span id="local-6989586621680482630"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621680482630"><span class="hs-identifier hs-var">leaseId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadCatch m =&gt; Text -&gt; m a -&gt; m a
</span><a href="Hydra.Network.Etcd.html#withGrpcContext"><span class="hs-identifier hs-var">withGrpcContext</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;writeAlive&quot;</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-449"></span><span>    </span><span class="annot"><span class="annottext">IO (Proto PutResponse) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Proto PutResponse) -&gt; IO ())
-&gt; (Proto PutRequest -&gt; IO (Proto PutResponse))
-&gt; Proto PutRequest
-&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
-&gt; ClientHandler'
     'NonStreaming (ReaderT Connection IO) (Protobuf KV &quot;put&quot;)
-&gt; Input (Protobuf KV &quot;put&quot;)
-&gt; IO (Output (Protobuf KV &quot;put&quot;))
forall {k} (rpc :: k) (m :: * -&gt; *).
Connection
-&gt; ClientHandler' 'NonStreaming (ReaderT Connection m) rpc
-&gt; Input rpc
-&gt; m (Output rpc)
</span><span class="hs-identifier hs-var">nonStreaming</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680482592"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {k} (rpc :: k) (styp :: StreamingType) (m :: * -&gt; *).
(CanCallRPC m, SupportsClientRpc rpc,
 SupportsStreamingType rpc styp, Default (RequestMetadata rpc)) =&gt;
ClientHandler' styp m rpc
forall rpc (styp :: StreamingType) (m :: * -&gt; *).
(CanCallRPC m, SupportsClientRpc rpc,
 SupportsStreamingType rpc styp, Default (RequestMetadata rpc)) =&gt;
ClientHandler' styp m rpc
</span><span class="hs-identifier hs-var">rpc</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Protobuf</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">KV</span></span><span> </span><span class="annot"><span class="hs-string">&quot;put&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Proto PutRequest -&gt; IO ()) -&gt; Proto PutRequest -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-450"></span><span>      </span><span class="annot"><span class="annottext">Proto PutRequest
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-451"></span><span>        </span><span class="annot"><span class="annottext">Proto PutRequest
-&gt; (Proto PutRequest -&gt; Proto PutRequest) -&gt; Proto PutRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto PutRequest) (Proto PutRequest) ByteString ByteString
</span><span class="">#key</span></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto PutRequest) (Proto PutRequest) ByteString ByteString
-&gt; ByteString -&gt; Proto PutRequest -&gt; Proto PutRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;alive-&quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Host -&gt; ByteString
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680482593"><span class="hs-identifier hs-var">advertise</span></a></span><span>
</span><span id="line-452"></span><span>        </span><span class="annot"><span class="annottext">Proto PutRequest
-&gt; (Proto PutRequest -&gt; Proto PutRequest) -&gt; Proto PutRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto PutRequest) (Proto PutRequest) ByteString ByteString
</span><span class="">#value</span></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto PutRequest) (Proto PutRequest) ByteString ByteString
-&gt; ByteString -&gt; Proto PutRequest -&gt; Proto PutRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Host -&gt; ByteString
forall a. ToCBOR a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">serialize'</span></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680482593"><span class="hs-identifier hs-var">advertise</span></a></span><span>
</span><span id="line-453"></span><span>        </span><span class="annot"><span class="annottext">Proto PutRequest
-&gt; (Proto PutRequest -&gt; Proto PutRequest) -&gt; Proto PutRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto PutRequest) (Proto PutRequest) Int64 Int64
</span><span class="">#lease</span></span><span> </span><span class="annot"><span class="annottext">ASetter (Proto PutRequest) (Proto PutRequest) Int64 Int64
-&gt; Int64 -&gt; Proto PutRequest -&gt; Proto PutRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621680482630"><span class="hs-identifier hs-var">leaseId</span></a></span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span>  </span><span id="local-6989586621680482612"><span class="annot"><span class="annottext">getAlive :: IO [Host]
</span><a href="#local-6989586621680482612"><span class="hs-identifier hs-var hs-var">getAlive</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO [Host] -&gt; IO [Host]
forall (m :: * -&gt; *) a. MonadCatch m =&gt; Text -&gt; m a -&gt; m a
</span><a href="Hydra.Network.Etcd.html#withGrpcContext"><span class="hs-identifier hs-var">withGrpcContext</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;getAlive&quot;</span></span><span> </span><span class="annot"><span class="annottext">(IO [Host] -&gt; IO [Host]) -&gt; IO [Host] -&gt; IO [Host]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-456"></span><span>    </span><span id="local-6989586621680482631"><span class="annot"><span class="annottext">Proto RangeResponse
</span><a href="#local-6989586621680482631"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-457"></span><span>      </span><span class="annot"><span class="annottext">Connection
-&gt; ClientHandler'
     'NonStreaming (ReaderT Connection IO) (Protobuf KV &quot;range&quot;)
-&gt; Input (Protobuf KV &quot;range&quot;)
-&gt; IO (Output (Protobuf KV &quot;range&quot;))
forall {k} (rpc :: k) (m :: * -&gt; *).
Connection
-&gt; ClientHandler' 'NonStreaming (ReaderT Connection m) rpc
-&gt; Input rpc
-&gt; m (Output rpc)
</span><span class="hs-identifier hs-var">nonStreaming</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680482592"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {k} (rpc :: k) (styp :: StreamingType) (m :: * -&gt; *).
(CanCallRPC m, SupportsClientRpc rpc,
 SupportsStreamingType rpc styp, Default (RequestMetadata rpc)) =&gt;
ClientHandler' styp m rpc
forall rpc (styp :: StreamingType) (m :: * -&gt; *).
(CanCallRPC m, SupportsClientRpc rpc,
 SupportsStreamingType rpc styp, Default (RequestMetadata rpc)) =&gt;
ClientHandler' styp m rpc
</span><span class="hs-identifier hs-var">rpc</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Protobuf</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">KV</span></span><span> </span><span class="annot"><span class="hs-string">&quot;range&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Input (Protobuf KV &quot;range&quot;) -&gt; IO (Output (Protobuf KV &quot;range&quot;)))
-&gt; Input (Protobuf KV &quot;range&quot;) -&gt; IO (Output (Protobuf KV &quot;range&quot;))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-458"></span><span>        </span><span class="annot"><span class="annottext">Proto RangeRequest
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-459"></span><span>          </span><span class="annot"><span class="annottext">Proto RangeRequest
-&gt; (Proto RangeRequest -&gt; Proto RangeRequest) -&gt; Proto RangeRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto RangeRequest) (Proto RangeRequest) ByteString ByteString
</span><span class="">#key</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto RangeRequest) (Proto RangeRequest) ByteString ByteString
-&gt; ByteString -&gt; Proto RangeRequest -&gt; Proto RangeRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;alive&quot;</span></span><span>
</span><span id="line-460"></span><span>          </span><span class="annot"><span class="annottext">Proto RangeRequest
-&gt; (Proto RangeRequest -&gt; Proto RangeRequest) -&gt; Proto RangeRequest
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto RangeRequest) (Proto RangeRequest) ByteString ByteString
</span><span class="">#rangeEnd</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  (Proto RangeRequest) (Proto RangeRequest) ByteString ByteString
-&gt; ByteString -&gt; Proto RangeRequest -&gt; Proto RangeRequest
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;alivf&quot;</span></span><span> </span><span class="hs-comment">-- NOTE: e+1 to query prefixes</span><span>
</span><span id="line-461"></span><span>    </span><span class="annot"><span class="annottext">((Proto KeyValue -&gt; IO (Maybe Host))
 -&gt; [Proto KeyValue] -&gt; IO [Host])
-&gt; [Proto KeyValue]
-&gt; (Proto KeyValue -&gt; IO (Maybe Host))
-&gt; IO [Host]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">(Proto KeyValue -&gt; IO (Maybe Host))
-&gt; [Proto KeyValue] -&gt; IO [Host]
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m (Maybe b)) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapMaybeM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proto RangeResponse
</span><a href="#local-6989586621680482631"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Proto RangeResponse
-&gt; ((Proto KeyValue
     -&gt; Const (Endo [Proto KeyValue]) (Proto KeyValue))
    -&gt; Proto RangeResponse
    -&gt; Const (Endo [Proto KeyValue]) (Proto RangeResponse))
-&gt; [Proto KeyValue]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">([Proto KeyValue]
 -&gt; Const (Endo [Proto KeyValue]) [Proto KeyValue])
-&gt; Proto RangeResponse
-&gt; Const (Endo [Proto KeyValue]) (Proto RangeResponse)
</span><span class="">#kvs</span></span><span> </span><span class="annot"><span class="annottext">(([Proto KeyValue]
  -&gt; Const (Endo [Proto KeyValue]) [Proto KeyValue])
 -&gt; Proto RangeResponse
 -&gt; Const (Endo [Proto KeyValue]) (Proto RangeResponse))
-&gt; ((Proto KeyValue
     -&gt; Const (Endo [Proto KeyValue]) (Proto KeyValue))
    -&gt; [Proto KeyValue]
    -&gt; Const (Endo [Proto KeyValue]) [Proto KeyValue])
-&gt; (Proto KeyValue
    -&gt; Const (Endo [Proto KeyValue]) (Proto KeyValue))
-&gt; Proto RangeResponse
-&gt; Const (Endo [Proto KeyValue]) (Proto RangeResponse)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Proto KeyValue -&gt; Const (Endo [Proto KeyValue]) (Proto KeyValue))
-&gt; [Proto KeyValue]
-&gt; Const (Endo [Proto KeyValue]) [Proto KeyValue]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Traversable.html#traverse"><span class="hs-identifier hs-var">traverse</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Proto KeyValue -&gt; IO (Maybe Host)) -&gt; IO [Host])
-&gt; (Proto KeyValue -&gt; IO (Maybe Host)) -&gt; IO [Host]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680482634"><span class="annot"><span class="annottext">Proto KeyValue
</span><a href="#local-6989586621680482634"><span class="hs-identifier hs-var">kv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-462"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680482635"><span class="annot"><span class="annottext">value :: ByteString
</span><a href="#local-6989586621680482635"><span class="hs-identifier hs-var hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proto KeyValue
</span><a href="#local-6989586621680482634"><span class="hs-identifier hs-var">kv</span></a></span><span> </span><span class="annot"><span class="annottext">Proto KeyValue
-&gt; Getting ByteString (Proto KeyValue) ByteString -&gt; ByteString
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting ByteString (Proto KeyValue) ByteString
</span><span class="">#value</span></span><span>
</span><span id="line-463"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Either DecoderError Host
forall a. FromCBOR a =&gt; ByteString -&gt; Either DecoderError a
</span><span class="hs-identifier hs-var">decodeFull'</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680482635"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-464"></span><span>        </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680482636"><span class="annot"><span class="annottext">DecoderError
</span><a href="#local-6989586621680482636"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-465"></span><span>          </span><span class="annot"><span class="annottext">Tracer IO EtcdLog -&gt; EtcdLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span>
</span><span id="line-466"></span><span>            </span><span class="annot"><span class="annottext">Tracer IO EtcdLog
</span><a href="#local-6989586621680482591"><span class="hs-identifier hs-var">tracer</span></a></span><span>
</span><span id="line-467"></span><span>            </span><span class="annot"><a href="Hydra.Network.Etcd.html#FailedToDecodeValue"><span class="hs-identifier hs-type">FailedToDecodeValue</span></a></span><span>
</span><span id="line-468"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:key:EtcdLog :: Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Akey%3AEtcdLog"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
forall a b. ConvertUtf8 a b =&gt; b -&gt; a
</span><span class="hs-identifier hs-var">decodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Text) -&gt; ByteString -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proto KeyValue
</span><a href="#local-6989586621680482634"><span class="hs-identifier hs-var">kv</span></a></span><span> </span><span class="annot"><span class="annottext">Proto KeyValue
-&gt; Getting ByteString (Proto KeyValue) ByteString -&gt; ByteString
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting ByteString (Proto KeyValue) ByteString
</span><span class="">#key</span></span><span>
</span><span id="line-469"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:value:EtcdLog :: Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Avalue%3AEtcdLog"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Text
</span><span class="hs-identifier hs-var">encodeBase16</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680482635"><span class="hs-identifier hs-var">value</span></a></span><span>
</span><span id="line-470"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:reason:EtcdLog :: Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Areason%3AEtcdLog"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DecoderError -&gt; Text
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">DecoderError
</span><a href="#local-6989586621680482636"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-471"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-472"></span><span>          </span><span class="annot"><span class="annottext">Maybe Host -&gt; IO (Maybe Host)
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Host
forall a. Maybe a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-473"></span><span>        </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680482637"><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680482637"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Host -&gt; IO (Maybe Host)
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Host -&gt; IO (Maybe Host)) -&gt; Maybe Host -&gt; IO (Maybe Host)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Host -&gt; Maybe Host
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Host
</span><a href="#local-6989586621680482637"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span class="annot"><span class="hs-comment">-- | Add context to the 'grpcErrorMessage' of any 'GrpcException' raised.</span></span><span>
</span><span id="line-476"></span><span id="local-6989586621680480965"><span id="local-6989586621680480966"><span class="annot"><a href="Hydra.Network.Etcd.html#withGrpcContext"><span class="hs-identifier hs-type">withGrpcContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621680480965"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/text-2.0.2/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680480965"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480966"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680480965"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480966"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-477"></span><span id="withGrpcContext"><span class="annot"><span class="annottext">withGrpcContext :: forall (m :: * -&gt; *) a. MonadCatch m =&gt; Text -&gt; m a -&gt; m a
</span><a href="Hydra.Network.Etcd.html#withGrpcContext"><span class="hs-identifier hs-var hs-var">withGrpcContext</span></a></span></span><span> </span><span id="local-6989586621680482648"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680482648"><span class="hs-identifier hs-var">context</span></a></span></span><span> </span><span id="local-6989586621680482649"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621680482649"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-478"></span><span>  </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621680482649"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (GrpcException -&gt; m a) -&gt; m a
forall e a. Exception e =&gt; m a -&gt; (e -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catch`</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680482650"><span class="annot"><span class="annottext">e :: GrpcException
</span><a href="#local-6989586621680482650"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">GrpcException</span></span><span class="hs-special">{</span><span id="local-6989586621680482651"><span class="annot"><span class="annottext">Maybe Text
grpcErrorMessage :: GrpcException -&gt; Maybe Text
grpcErrorMessage :: Maybe Text
</span><span class="hs-identifier hs-var hs-var">grpcErrorMessage</span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-479"></span><span>    </span><span class="annot"><span class="annottext">GrpcException -&gt; m a
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span>
</span><span id="line-480"></span><span>      </span><span class="annot"><span class="annottext">GrpcException
</span><a href="#local-6989586621680482650"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-481"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-var">grpcErrorMessage</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-482"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680482651"><span class="hs-identifier hs-type">grpcErrorMessage</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-483"></span><span>              </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680482648"><span class="hs-identifier hs-var">context</span></a></span><span>
</span><span id="line-484"></span><span>              </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680482652"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680482652"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Maybe Text) -&gt; Text -&gt; Maybe Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680482648"><span class="hs-identifier hs-var">context</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680482652"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-485"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-486"></span><span>
</span><span id="line-487"></span><span class="hs-comment">-- | Like 'withProcessTerm', but sends first SIGINT and only SIGTERM if not</span><span>
</span><span id="line-488"></span><span class="hs-comment">-- stopped within 5 seconds.</span><span>
</span><span id="line-489"></span><span id="local-6989586621680480752"><span id="local-6989586621680480753"><span id="local-6989586621680480754"><span id="local-6989586621680480755"><span id="local-6989586621680480756"><span class="annot"><a href="Hydra.Network.Etcd.html#withProcessInterrupt"><span class="hs-identifier hs-type">withProcessInterrupt</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-490"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.IO.Class.html#MonadIO"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480752"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621680480752"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-491"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ProcessConfig</span></span><span> </span><span class="annot"><a href="#local-6989586621680480753"><span class="hs-identifier hs-type">stdin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480754"><span class="hs-identifier hs-type">stdout</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480755"><span class="hs-identifier hs-type">stderr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-492"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Process</span></span><span> </span><span class="annot"><a href="#local-6989586621680480753"><span class="hs-identifier hs-type">stdin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480754"><span class="hs-identifier hs-type">stdout</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480755"><span class="hs-identifier hs-type">stderr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680480752"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480756"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-493"></span><span>  </span><span class="annot"><a href="#local-6989586621680480752"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480756"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span></span><span>
</span><span id="line-494"></span><span id="withProcessInterrupt"><span class="annot"><span class="annottext">withProcessInterrupt :: forall (m :: * -&gt; *) stdin stdout stderr a.
(MonadIO m, MonadThrow m) =&gt;
ProcessConfig stdin stdout stderr
-&gt; (Process stdin stdout stderr -&gt; m a) -&gt; m a
</span><a href="Hydra.Network.Etcd.html#withProcessInterrupt"><span class="hs-identifier hs-var hs-var">withProcessInterrupt</span></a></span></span><span> </span><span id="local-6989586621680482658"><span class="annot"><span class="annottext">ProcessConfig stdin stdout stderr
</span><a href="#local-6989586621680482658"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-495"></span><span>  </span><span class="annot"><span class="annottext">m (Process stdin stdout stderr)
-&gt; (Process stdin stdout stderr -&gt; m ())
-&gt; (Process stdin stdout stderr -&gt; m a)
-&gt; m a
forall a b c. m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
forall (m :: * -&gt; *) a b c.
MonadThrow m =&gt;
m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
</span><span class="hs-identifier hs-var">bracket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProcessConfig stdin stdout stderr
-&gt; m (Process stdin stdout stderr)
forall (m :: * -&gt; *) stdin stdout stderr.
MonadIO m =&gt;
ProcessConfig stdin stdout stderr
-&gt; m (Process stdin stdout stderr)
</span><span class="hs-identifier hs-var">startProcess</span></span><span> </span><span class="annot"><span class="annottext">(ProcessConfig stdin stdout stderr
 -&gt; m (Process stdin stdout stderr))
-&gt; ProcessConfig stdin stdout stderr
-&gt; m (Process stdin stdout stderr)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ProcessConfig stdin stdout stderr
</span><a href="#local-6989586621680482658"><span class="hs-identifier hs-var">config</span></a></span><span> </span><span class="annot"><span class="annottext">ProcessConfig stdin stdout stderr
-&gt; (ProcessConfig stdin stdout stderr
    -&gt; ProcessConfig stdin stdout stderr)
-&gt; ProcessConfig stdin stdout stderr
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; ProcessConfig stdin stdout stderr
-&gt; ProcessConfig stdin stdout stderr
forall stdin stdout stderr.
Bool
-&gt; ProcessConfig stdin stdout stderr
-&gt; ProcessConfig stdin stdout stderr
</span><span class="hs-identifier hs-var">setCreateGroup</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Process stdin stdout stderr -&gt; m ()
forall {m :: * -&gt; *} {stdin} {stdout} {stderr}.
MonadIO m =&gt;
Process stdin stdout stderr -&gt; m ()
</span><a href="#local-6989586621680482660"><span class="hs-identifier hs-var">signalAndStopProcess</span></a></span><span>
</span><span id="line-496"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-497"></span><span>  </span><span id="local-6989586621680482660"><span class="annot"><span class="annottext">signalAndStopProcess :: Process stdin stdout stderr -&gt; m ()
</span><a href="#local-6989586621680482660"><span class="hs-identifier hs-var hs-var">signalAndStopProcess</span></a></span></span><span> </span><span id="local-6989586621680482680"><span class="annot"><span class="annottext">Process stdin stdout stderr
</span><a href="#local-6989586621680482680"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-498"></span><span>    </span><span class="annot"><span class="annottext">ProcessHandle -&gt; IO ()
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/process-1.6.19.0/src/System.Process.Internals.html#interruptProcessGroupOf"><span class="hs-identifier hs-var">interruptProcessGroupOf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Process stdin stdout stderr -&gt; ProcessHandle
forall stdin stdout stderr.
Process stdin stdout stderr -&gt; ProcessHandle
</span><span class="hs-identifier hs-var">unsafeProcessHandle</span></span><span> </span><span class="annot"><span class="annottext">Process stdin stdout stderr
</span><a href="#local-6989586621680482680"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO ()
forall (m :: * -&gt; *) a b. MonadAsync m =&gt; m a -&gt; m b -&gt; m ()
</span><span class="hs-identifier hs-var">race_</span></span><span>
</span><span id="line-500"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO ExitCode -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ExitCode -&gt; IO ()) -&gt; IO ExitCode -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Process stdin stdout stderr -&gt; IO ExitCode
forall (m :: * -&gt; *) stdin stdout stderr.
MonadIO m =&gt;
Process stdin stdout stderr -&gt; m ExitCode
</span><span class="hs-identifier hs-var">waitExitCode</span></span><span> </span><span class="annot"><span class="annottext">Process stdin stdout stderr
</span><a href="#local-6989586621680482680"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-501"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
forall (m :: * -&gt; *). MonadDelay m =&gt; DiffTime -&gt; m ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">5</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Process stdin stdout stderr -&gt; IO ()
forall {m :: * -&gt; *} {stdin} {stdout} {stderr}.
MonadIO m =&gt;
Process stdin stdout stderr -&gt; m ()
</span><span class="hs-identifier hs-var">stopProcess</span></span><span> </span><span class="annot"><span class="annottext">Process stdin stdout stderr
</span><a href="#local-6989586621680482680"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span class="annot"><span class="hs-comment">-- * Persistent queue</span></span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span class="hs-keyword">data</span><span> </span><span id="PersistentQueue"><span class="annot"><a href="Hydra.Network.Etcd.html#PersistentQueue"><span class="hs-identifier hs-var">PersistentQueue</span></a></span></span><span> </span><span id="local-6989586621680481057"><span class="annot"><a href="#local-6989586621680481057"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680481058"><span class="annot"><a href="#local-6989586621680481058"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PersistentQueue"><span class="annot"><a href="Hydra.Network.Etcd.html#PersistentQueue"><span class="hs-identifier hs-var">PersistentQueue</span></a></span></span><span>
</span><span id="line-506"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="%24sel%3Aqueue%3APersistentQueue"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
PersistentQueue m a -&gt; TBQueue m (Natural, a)
</span><a href="Hydra.Network.Etcd.html#%24sel%3Aqueue%3APersistentQueue"><span class="hs-identifier hs-var hs-var">queue</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TBQueue</span></span><span> </span><span class="annot"><a href="#local-6989586621680481057"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-bignum-1.3/src/GHC.Num.Natural.html#Natural"><span class="hs-identifier hs-type">Natural</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680481058"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AnextIx%3APersistentQueue"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. PersistentQueue m a -&gt; TVar m Natural
</span><a href="Hydra.Network.Etcd.html#%24sel%3AnextIx%3APersistentQueue"><span class="hs-identifier hs-var hs-var">nextIx</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="#local-6989586621680481057"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-bignum-1.3/src/GHC.Num.Natural.html#Natural"><span class="hs-identifier hs-type">Natural</span></a></span><span>
</span><span id="line-508"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Adirectory%3APersistentQueue"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. PersistentQueue m a -&gt; [Char]
</span><a href="Hydra.Network.Etcd.html#%24sel%3Adirectory%3APersistentQueue"><span class="hs-identifier hs-var hs-var">directory</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-509"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-510"></span><span>
</span><span id="line-511"></span><span class="annot"><span class="hs-comment">-- | Create a new persistent queue at file path and given capacity.</span></span><span>
</span><span id="line-512"></span><span id="local-6989586621680480789"><span id="local-6989586621680480790"><span class="annot"><a href="Hydra.Network.Etcd.html#newPersistentQueue"><span class="hs-identifier hs-type">newPersistentQueue</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-513"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621680480789"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.IO.Class.html#MonadIO"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480789"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FromCBOR</span></span><span> </span><span class="annot"><a href="#local-6989586621680480790"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621680480789"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.Fail.html#MonadFail"><span class="hs-identifier hs-type">MonadFail</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480789"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-514"></span><span>  </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-515"></span><span>  </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-bignum-1.3/src/GHC.Num.Natural.html#Natural"><span class="hs-identifier hs-type">Natural</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-516"></span><span>  </span><span class="annot"><a href="#local-6989586621680480789"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.Network.Etcd.html#PersistentQueue"><span class="hs-identifier hs-type">PersistentQueue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480789"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480790"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-517"></span><span id="newPersistentQueue"><span class="annot"><span class="annottext">newPersistentQueue :: forall (m :: * -&gt; *) a.
(MonadSTM m, MonadIO m, FromCBOR a, MonadCatch m, MonadFail m) =&gt;
[Char] -&gt; Natural -&gt; m (PersistentQueue m a)
</span><a href="Hydra.Network.Etcd.html#newPersistentQueue"><span class="hs-identifier hs-var hs-var">newPersistentQueue</span></a></span></span><span> </span><span id="local-6989586621680482738"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680482738"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621680482739"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482739"><span class="hs-identifier hs-var">capacity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-518"></span><span>  </span><span id="local-6989586621680482740"><span class="annot"><span class="annottext">TBQueue m (Natural, a)
</span><a href="#local-6989586621680482740"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; m (TBQueue m (Natural, a))
forall a. Natural -&gt; m (TBQueue m a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; Natural -&gt; m (TBQueue m a)
</span><span class="hs-identifier hs-var">newTBQueueIO</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482739"><span class="hs-identifier hs-var">capacity</span></a></span><span>
</span><span id="line-519"></span><span>  </span><span id="local-6989586621680482741"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482741"><span class="hs-identifier hs-var">highestId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-520"></span><span>    </span><span class="annot"><span class="annottext">m Natural -&gt; m (Either IOException Natural)
forall e a. Exception e =&gt; m a -&gt; m (Either e a)
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TBQueue m (Natural, a) -&gt; m Natural
</span><a href="#local-6989586621680482742"><span class="hs-identifier hs-var">loadExisting</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueue m (Natural, a)
</span><a href="#local-6989586621680482740"><span class="hs-identifier hs-var">queue</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (Either IOException Natural)
-&gt; (Either IOException Natural -&gt; m Natural) -&gt; m Natural
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-521"></span><span>      </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IOException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.Exception.html#IOException"><span class="hs-identifier hs-type">IOException</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-522"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [Char] -&gt; IO ()
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/directory-1.3.8.5/src/System.Directory.html#createDirectoryIfMissing"><span class="hs-identifier hs-var">createDirectoryIfMissing</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680482738"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-523"></span><span>        </span><span class="annot"><span class="annottext">Natural -&gt; m Natural
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-524"></span><span>      </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680482743"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482743"><span class="hs-identifier hs-var">highest</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; m Natural
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482743"><span class="hs-identifier hs-var">highest</span></a></span><span>
</span><span id="line-525"></span><span>  </span><span id="local-6989586621680482744"><span class="annot"><span class="annottext">TVar m Natural
</span><a href="#local-6989586621680482744"><span class="hs-identifier hs-var">nextIx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; m (TVar m Natural)
forall a. a -&gt; m (TVar m a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (TVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; m (TVar m Natural)) -&gt; Natural -&gt; m (TVar m Natural)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482741"><span class="hs-identifier hs-var">highestId</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span>
</span><span id="line-526"></span><span>  </span><span class="annot"><span class="annottext">PersistentQueue m a -&gt; m (PersistentQueue m a)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#PersistentQueue"><span class="hs-identifier hs-type">PersistentQueue</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">TBQueue m (Natural, a)
$sel:queue:PersistentQueue :: TBQueue m (Natural, a)
queue :: TBQueue m (Natural, a)
</span><a href="Hydra.Network.Etcd.html#%24sel%3Aqueue%3APersistentQueue"><span class="hs-identifier hs-var hs-var">queue</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TVar m Natural
$sel:nextIx:PersistentQueue :: TVar m Natural
nextIx :: TVar m Natural
</span><a href="Hydra.Network.Etcd.html#%24sel%3AnextIx%3APersistentQueue"><span class="hs-identifier hs-var hs-var">nextIx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:directory:PersistentQueue :: [Char]
</span><a href="Hydra.Network.Etcd.html#%24sel%3Adirectory%3APersistentQueue"><span class="hs-identifier hs-var">directory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680482738"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-527"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-528"></span><span>  </span><span id="local-6989586621680482742"><span class="annot"><span class="annottext">loadExisting :: TBQueue m (Natural, a) -&gt; m Natural
</span><a href="#local-6989586621680482742"><span class="hs-identifier hs-var hs-var">loadExisting</span></a></span></span><span> </span><span id="local-6989586621680482745"><span class="annot"><span class="annottext">TBQueue m (Natural, a)
</span><a href="#local-6989586621680482745"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-529"></span><span>    </span><span id="local-6989586621680482746"><span class="annot"><span class="annottext">[[Char]]
</span><a href="#local-6989586621680482746"><span class="hs-identifier hs-var">paths</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [[Char]] -&gt; m [[Char]]
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO [[Char]] -&gt; m [[Char]]) -&gt; IO [[Char]] -&gt; m [[Char]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; IO [[Char]]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/directory-1.3.8.5/src/System.Directory.html#listDirectory"><span class="hs-identifier hs-var">listDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680482738"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-530"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Natural] -&gt; [Natural]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.OldList.html#sort"><span class="hs-identifier hs-var">sort</span></a></span><span> </span><span class="annot"><span class="annottext">([Natural] -&gt; [Natural]) -&gt; [Natural] -&gt; [Natural]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Maybe Natural) -&gt; [[Char]] -&gt; [Natural]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#mapMaybe"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Maybe Natural
forall a. Read a =&gt; [Char] -&gt; Maybe a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Text.Read.html#readMaybe"><span class="hs-identifier hs-var">readMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[[Char]]
</span><a href="#local-6989586621680482746"><span class="hs-identifier hs-var">paths</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-531"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; m Natural
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-532"></span><span>      </span><span id="local-6989586621680482750"><span class="annot"><span class="annottext">[Natural]
</span><a href="#local-6989586621680482750"><span class="hs-identifier hs-var">idxs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-533"></span><span>        </span><span class="annot"><span class="annottext">[Natural] -&gt; (Natural -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[Natural]
</span><a href="#local-6989586621680482750"><span class="hs-identifier hs-var">idxs</span></a></span><span> </span><span class="annot"><span class="annottext">((Natural -&gt; m ()) -&gt; m ()) -&gt; (Natural -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680482751"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482751"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-bignum-1.3/src/GHC.Num.Natural.html#Natural"><span class="hs-identifier hs-type">Natural</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-534"></span><span>          </span><span id="local-6989586621680482752"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680482752"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; m ByteString
forall (m :: * -&gt; *). MonadIO m =&gt; [Char] -&gt; m ByteString
</span><span class="hs-identifier hs-var">readFileBS</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680482738"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/filepath-1.4.300.1/src/System.FilePath.Posix.html#%3C%2F%3E"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; [Char]
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482751"><span class="hs-identifier hs-var">idx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-535"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Either DecoderError a
forall a. FromCBOR a =&gt; ByteString -&gt; Either DecoderError a
</span><span class="hs-identifier hs-var">decodeFull'</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680482752"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-536"></span><span>            </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680482754"><span class="annot"><span class="annottext">DecoderError
</span><a href="#local-6989586621680482754"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-537"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; m ()
forall a. [Char] -&gt; m a
forall (m :: * -&gt; *) a. MonadFail m =&gt; [Char] -&gt; m a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.Fail.html#fail"><span class="hs-identifier hs-var">fail</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; m ()) -&gt; [Char] -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Failed to decode item: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">DecoderError -&gt; [Char]
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">DecoderError
</span><a href="#local-6989586621680482754"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-538"></span><span>            </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680482755"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680482755"><span class="hs-identifier hs-var">item</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-539"></span><span>              </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueue m (Natural, a) -&gt; (Natural, a) -&gt; STM m ()
forall a. TBQueue m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TBQueue m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTBQueue</span></span><span> </span><span class="annot"><span class="annottext">TBQueue m (Natural, a)
</span><a href="#local-6989586621680482745"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482751"><span class="hs-identifier hs-var">idx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680482755"><span class="hs-identifier hs-var">item</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-540"></span><span>        </span><span class="annot"><span class="annottext">Natural -&gt; m Natural
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; m Natural) -&gt; Natural -&gt; m Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Natural] -&gt; Natural
forall a. HasCallStack =&gt; [a] -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.List.html#last"><span class="hs-identifier hs-var">List.last</span></a></span><span> </span><span class="annot"><span class="annottext">[Natural]
</span><a href="#local-6989586621680482750"><span class="hs-identifier hs-var">idxs</span></a></span><span>
</span><span id="line-541"></span><span>
</span><span id="line-542"></span><span class="annot"><span class="hs-comment">-- | Write a value to the queue, blocking if the queue is full.</span></span><span>
</span><span id="line-543"></span><span id="local-6989586621680480792"><span id="local-6989586621680480793"><span class="annot"><a href="Hydra.Network.Etcd.html#writePersistentQueue"><span class="hs-identifier hs-type">writePersistentQueue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ToCBOR</span></span><span> </span><span class="annot"><a href="#local-6989586621680480792"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621680480793"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.IO.Class.html#MonadIO"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480793"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#PersistentQueue"><span class="hs-identifier hs-type">PersistentQueue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480793"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480792"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680480792"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680480793"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-544"></span><span id="writePersistentQueue"><span class="annot"><span class="annottext">writePersistentQueue :: forall a (m :: * -&gt; *).
(ToCBOR a, MonadSTM m, MonadIO m) =&gt;
PersistentQueue m a -&gt; a -&gt; m ()
</span><a href="Hydra.Network.Etcd.html#writePersistentQueue"><span class="hs-identifier hs-var hs-var">writePersistentQueue</span></a></span></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#PersistentQueue"><span class="hs-identifier hs-type">PersistentQueue</span></a></span><span class="hs-special">{</span><span id="local-6989586621680482785"><span class="annot"><span class="annottext">TBQueue m (Natural, a)
$sel:queue:PersistentQueue :: forall (m :: * -&gt; *) a.
PersistentQueue m a -&gt; TBQueue m (Natural, a)
queue :: TBQueue m (Natural, a)
</span><a href="Hydra.Network.Etcd.html#%24sel%3Aqueue%3APersistentQueue"><span class="hs-identifier hs-var hs-var">queue</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680482786"><span class="annot"><span class="annottext">TVar m Natural
$sel:nextIx:PersistentQueue :: forall (m :: * -&gt; *) a. PersistentQueue m a -&gt; TVar m Natural
nextIx :: TVar m Natural
</span><a href="Hydra.Network.Etcd.html#%24sel%3AnextIx%3APersistentQueue"><span class="hs-identifier hs-var hs-var">nextIx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680482787"><span class="annot"><span class="annottext">[Char]
$sel:directory:PersistentQueue :: forall (m :: * -&gt; *) a. PersistentQueue m a -&gt; [Char]
directory :: [Char]
</span><a href="Hydra.Network.Etcd.html#%24sel%3Adirectory%3APersistentQueue"><span class="hs-identifier hs-var hs-var">directory</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680482788"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680482788"><span class="hs-identifier hs-var">item</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-545"></span><span>  </span><span id="local-6989586621680482789"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482789"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m Natural -&gt; m Natural
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m Natural -&gt; m Natural) -&gt; STM m Natural -&gt; m Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-546"></span><span>    </span><span id="local-6989586621680482790"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482790"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m Natural -&gt; STM m Natural
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m Natural
</span><a href="#local-6989586621680482786"><span class="hs-identifier hs-var">nextIx</span></a></span><span>
</span><span id="line-547"></span><span>    </span><span class="annot"><span class="annottext">TVar m Natural -&gt; (Natural -&gt; Natural) -&gt; STM m ()
forall a. TVar m a -&gt; (a -&gt; a) -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><span class="hs-identifier hs-var">modifyTVar'</span></span><span> </span><span class="annot"><span class="annottext">TVar m Natural
</span><a href="#local-6989586621680482786"><span class="hs-identifier hs-var">nextIx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>    </span><span class="annot"><span class="annottext">Natural -&gt; STM m Natural
forall a. a -&gt; STM m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482790"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-549"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; ByteString -&gt; m ()
forall (m :: * -&gt; *). MonadIO m =&gt; [Char] -&gt; ByteString -&gt; m ()
</span><span class="hs-identifier hs-var">writeFileBS</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680482787"><span class="hs-identifier hs-var">directory</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/filepath-1.4.300.1/src/System.FilePath.Posix.html#%3C%2F%3E"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; [Char]
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482789"><span class="hs-identifier hs-var">next</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; m ()) -&gt; ByteString -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; ByteString
forall a. ToCBOR a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">serialize'</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680482788"><span class="hs-identifier hs-var">item</span></a></span><span>
</span><span id="line-550"></span><span>  </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueue m (Natural, a) -&gt; (Natural, a) -&gt; STM m ()
forall a. TBQueue m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TBQueue m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTBQueue</span></span><span> </span><span class="annot"><span class="annottext">TBQueue m (Natural, a)
</span><a href="#local-6989586621680482785"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482789"><span class="hs-identifier hs-var">next</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680482788"><span class="hs-identifier hs-var">item</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-551"></span><span>
</span><span id="line-552"></span><span class="hs-comment">-- | Get the next value from the queue without removing it, blocking if the</span><span>
</span><span id="line-553"></span><span class="hs-comment">-- queue is empty.</span><span>
</span><span id="line-554"></span><span id="local-6989586621680480967"><span id="local-6989586621680480968"><span class="annot"><a href="Hydra.Network.Etcd.html#peekPersistentQueue"><span class="hs-identifier hs-type">peekPersistentQueue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621680480967"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#PersistentQueue"><span class="hs-identifier hs-type">PersistentQueue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480967"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480968"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680480967"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480968"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-555"></span><span id="peekPersistentQueue"><span class="annot"><span class="annottext">peekPersistentQueue :: forall (m :: * -&gt; *) a. MonadSTM m =&gt; PersistentQueue m a -&gt; m a
</span><a href="Hydra.Network.Etcd.html#peekPersistentQueue"><span class="hs-identifier hs-var hs-var">peekPersistentQueue</span></a></span></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#PersistentQueue"><span class="hs-identifier hs-type">PersistentQueue</span></a></span><span class="hs-special">{</span><span id="local-6989586621680482802"><span class="annot"><span class="annottext">TBQueue m (Natural, a)
$sel:queue:PersistentQueue :: forall (m :: * -&gt; *) a.
PersistentQueue m a -&gt; TBQueue m (Natural, a)
queue :: TBQueue m (Natural, a)
</span><a href="Hydra.Network.Etcd.html#%24sel%3Aqueue%3APersistentQueue"><span class="hs-identifier hs-var hs-var">queue</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-556"></span><span>  </span><span class="annot"><span class="annottext">(Natural, a) -&gt; a
forall a b. (a, b) -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">((Natural, a) -&gt; a) -&gt; m (Natural, a) -&gt; m a
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (Natural, a) -&gt; m (Natural, a)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TBQueue m (Natural, a) -&gt; STM m (Natural, a)
forall a. TBQueue m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TBQueue m a -&gt; STM m a
</span><span class="hs-identifier hs-var">peekTBQueue</span></span><span> </span><span class="annot"><span class="annottext">TBQueue m (Natural, a)
</span><a href="#local-6989586621680482802"><span class="hs-identifier hs-var">queue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span>
</span><span id="line-558"></span><span class="hs-comment">-- | Remove an element from the queue if it matches the given item. Use</span><span>
</span><span id="line-559"></span><span class="hs-comment">-- 'peekPersistentQueue' to wait for next items before popping it.</span><span>
</span><span id="line-560"></span><span id="local-6989586621680480972"><span id="local-6989586621680480973"><span class="annot"><a href="Hydra.Network.Etcd.html#popPersistentQueue"><span class="hs-identifier hs-type">popPersistentQueue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621680480972"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.IO.Class.html#MonadIO"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480972"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480973"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#PersistentQueue"><span class="hs-identifier hs-type">PersistentQueue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480972"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680480973"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680480973"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680480972"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-561"></span><span id="popPersistentQueue"><span class="annot"><span class="annottext">popPersistentQueue :: forall (m :: * -&gt; *) a.
(MonadSTM m, MonadIO m, Eq a) =&gt;
PersistentQueue m a -&gt; a -&gt; m ()
</span><a href="Hydra.Network.Etcd.html#popPersistentQueue"><span class="hs-identifier hs-var hs-var">popPersistentQueue</span></a></span></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#PersistentQueue"><span class="hs-identifier hs-type">PersistentQueue</span></a></span><span class="hs-special">{</span><span id="local-6989586621680482827"><span class="annot"><span class="annottext">TBQueue m (Natural, a)
$sel:queue:PersistentQueue :: forall (m :: * -&gt; *) a.
PersistentQueue m a -&gt; TBQueue m (Natural, a)
queue :: TBQueue m (Natural, a)
</span><a href="Hydra.Network.Etcd.html#%24sel%3Aqueue%3APersistentQueue"><span class="hs-identifier hs-var hs-var">queue</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680482828"><span class="annot"><span class="annottext">[Char]
$sel:directory:PersistentQueue :: forall (m :: * -&gt; *) a. PersistentQueue m a -&gt; [Char]
directory :: [Char]
</span><a href="Hydra.Network.Etcd.html#%24sel%3Adirectory%3APersistentQueue"><span class="hs-identifier hs-var hs-var">directory</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680482829"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680482829"><span class="hs-identifier hs-var">item</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-562"></span><span>  </span><span id="local-6989586621680482830"><span class="annot"><span class="annottext">Maybe Natural
</span><a href="#local-6989586621680482830"><span class="hs-identifier hs-var">popped</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Maybe Natural) -&gt; m (Maybe Natural)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (Maybe Natural) -&gt; m (Maybe Natural))
-&gt; STM m (Maybe Natural) -&gt; m (Maybe Natural)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-563"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680482831"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482831"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680482832"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680482832"><span class="hs-identifier hs-var">next</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TBQueue m (Natural, a) -&gt; STM m (Natural, a)
forall a. TBQueue m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TBQueue m a -&gt; STM m a
</span><span class="hs-identifier hs-var">peekTBQueue</span></span><span> </span><span class="annot"><span class="annottext">TBQueue m (Natural, a)
</span><a href="#local-6989586621680482827"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-564"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680482832"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680482829"><span class="hs-identifier hs-var">item</span></a></span><span>
</span><span id="line-565"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TBQueue m (Natural, a) -&gt; STM m (Natural, a)
forall a. TBQueue m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TBQueue m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTBQueue</span></span><span> </span><span class="annot"><span class="annottext">TBQueue m (Natural, a)
</span><a href="#local-6989586621680482827"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (Natural, a) -&gt; Maybe Natural -&gt; STM m (Maybe Natural)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; b -&gt; f b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#%24%3E"><span class="hs-operator hs-var">$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Maybe Natural
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482831"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-566"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe Natural -&gt; STM m (Maybe Natural)
forall a. a -&gt; STM m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Natural
forall a. Maybe a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-567"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Natural
</span><a href="#local-6989586621680482830"><span class="hs-identifier hs-var">popped</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-568"></span><span>    </span><span class="annot"><span class="annottext">Maybe Natural
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-569"></span><span>    </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680482834"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482834"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-570"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; ([Char] -&gt; IO ()) -&gt; [Char] -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; IO ()
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/directory-1.3.8.5/src/System.Directory.html#removeFile"><span class="hs-identifier hs-var">removeFile</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; m ()) -&gt; [Char] -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680482828"><span class="hs-identifier hs-var">directory</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/filepath-1.4.300.1/src/System.FilePath.Posix.html#%3C%2F%3E"><span class="hs-operator hs-var">&lt;/&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; [Char]
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680482834"><span class="hs-identifier hs-var">index</span></a></span><span>
</span><span id="line-571"></span><span>
</span><span id="line-572"></span><span class="annot"><span class="hs-comment">-- * Tracing</span></span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span class="hs-keyword">data</span><span> </span><span id="EtcdLog"><span class="annot"><a href="Hydra.Network.Etcd.html#EtcdLog"><span class="hs-identifier hs-var">EtcdLog</span></a></span></span><span>
</span><span id="line-575"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="EtcdLog"><span class="annot"><a href="Hydra.Network.Etcd.html#EtcdLog"><span class="hs-identifier hs-var">EtcdLog</span></a></span></span><span> </span><span class="hs-special">{</span><span id="etcd"><span class="annot"><span class="annottext">EtcdLog -&gt; Value
</span><a href="Hydra.Network.Etcd.html#etcd"><span class="hs-identifier hs-var hs-var">etcd</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span class="hs-special">}</span><span>
</span><span id="line-576"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Reconnecting"><span class="annot"><a href="Hydra.Network.Etcd.html#Reconnecting"><span class="hs-identifier hs-var">Reconnecting</span></a></span></span><span>
</span><span id="line-577"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="BroadcastFailed"><span class="annot"><a href="Hydra.Network.Etcd.html#BroadcastFailed"><span class="hs-identifier hs-var">BroadcastFailed</span></a></span></span><span> </span><span class="hs-special">{</span><span id="%24sel%3Areason%3AEtcdLog"><span class="annot"><span class="annottext">EtcdLog -&gt; Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Areason%3AEtcdLog"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/text-2.0.2/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-578"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="FailedToDecodeLog"><span class="annot"><a href="Hydra.Network.Etcd.html#FailedToDecodeLog"><span class="hs-identifier hs-var">FailedToDecodeLog</span></a></span></span><span> </span><span class="hs-special">{</span><span id="%24sel%3Alog%3AEtcdLog"><span class="annot"><span class="annottext">EtcdLog -&gt; Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Alog%3AEtcdLog"><span class="hs-identifier hs-var hs-var">log</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/text-2.0.2/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">,</span><span> </span><span id="%24sel%3Areason%3AEtcdLog"><span class="annot"><a href="Hydra.Network.Etcd.html#%24sel%3Areason%3AEtcdLog"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/text-2.0.2/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-579"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="FailedToDecodeValue"><span class="annot"><a href="Hydra.Network.Etcd.html#FailedToDecodeValue"><span class="hs-identifier hs-var">FailedToDecodeValue</span></a></span></span><span> </span><span class="hs-special">{</span><span id="%24sel%3Akey%3AEtcdLog"><span class="annot"><span class="annottext">EtcdLog -&gt; Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Akey%3AEtcdLog"><span class="hs-identifier hs-var hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/text-2.0.2/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">,</span><span> </span><span id="%24sel%3Avalue%3AEtcdLog"><span class="annot"><span class="annottext">EtcdLog -&gt; Text
</span><a href="Hydra.Network.Etcd.html#%24sel%3Avalue%3AEtcdLog"><span class="hs-identifier hs-var hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/text-2.0.2/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">,</span><span> </span><span id="%24sel%3Areason%3AEtcdLog"><span class="annot"><a href="Hydra.Network.Etcd.html#%24sel%3Areason%3AEtcdLog"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/text-2.0.2/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-580"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CreatedLease"><span class="annot"><a href="Hydra.Network.Etcd.html#CreatedLease"><span class="hs-identifier hs-var">CreatedLease</span></a></span></span><span> </span><span class="hs-special">{</span><span id="%24sel%3AleaseId%3AEtcdLog"><span class="annot"><span class="annottext">EtcdLog -&gt; Int64
</span><a href="Hydra.Network.Etcd.html#%24sel%3AleaseId%3AEtcdLog"><span class="hs-identifier hs-var hs-var">leaseId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Int.html#Int64"><span class="hs-identifier hs-type">Int64</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-581"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="LowLeaseTTL"><span class="annot"><a href="Hydra.Network.Etcd.html#LowLeaseTTL"><span class="hs-identifier hs-var">LowLeaseTTL</span></a></span></span><span> </span><span class="hs-special">{</span><span id="%24sel%3AttlRemaining%3AEtcdLog"><span class="annot"><span class="annottext">EtcdLog -&gt; DiffTime
</span><a href="Hydra.Network.Etcd.html#%24sel%3AttlRemaining%3AEtcdLog"><span class="hs-identifier hs-var hs-var">ttlRemaining</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/time-1.12.2/src/Data.Time.Clock.Internal.DiffTime.html#DiffTime"><span class="hs-identifier hs-type">DiffTime</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-582"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="NoKeepAliveResponse"><span class="annot"><a href="Hydra.Network.Etcd.html#NoKeepAliveResponse"><span class="hs-identifier hs-var">NoKeepAliveResponse</span></a></span></span><span>
</span><span id="line-583"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MatchingProtocolVersion"><span class="annot"><a href="Hydra.Network.Etcd.html#MatchingProtocolVersion"><span class="hs-identifier hs-var">MatchingProtocolVersion</span></a></span></span><span> </span><span class="hs-special">{</span><span id="version"><span class="annot"><span class="annottext">EtcdLog -&gt; ProtocolVersion
</span><a href="Hydra.Network.Etcd.html#version"><span class="hs-identifier hs-var hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hydra.Network.html#ProtocolVersion"><span class="hs-identifier hs-type">ProtocolVersion</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-584"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680482836"><span id="local-6989586621680482852"><span class="annot"><span class="annottext">EtcdLog -&gt; EtcdLog -&gt; Bool
(EtcdLog -&gt; EtcdLog -&gt; Bool)
-&gt; (EtcdLog -&gt; EtcdLog -&gt; Bool) -&gt; Eq EtcdLog
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: EtcdLog -&gt; EtcdLog -&gt; Bool
== :: EtcdLog -&gt; EtcdLog -&gt; Bool
$c/= :: EtcdLog -&gt; EtcdLog -&gt; Bool
/= :: EtcdLog -&gt; EtcdLog -&gt; Bool
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680482857"><span id="local-6989586621680482882"><span id="local-6989586621680482886"><span class="annot"><span class="annottext">Int -&gt; EtcdLog -&gt; [Char] -&gt; [Char]
[EtcdLog] -&gt; [Char] -&gt; [Char]
EtcdLog -&gt; [Char]
(Int -&gt; EtcdLog -&gt; [Char] -&gt; [Char])
-&gt; (EtcdLog -&gt; [Char])
-&gt; ([EtcdLog] -&gt; [Char] -&gt; [Char])
-&gt; Show EtcdLog
forall a.
(Int -&gt; a -&gt; [Char] -&gt; [Char])
-&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; [Char] -&gt; [Char]) -&gt; Show a
$cshowsPrec :: Int -&gt; EtcdLog -&gt; [Char] -&gt; [Char]
showsPrec :: Int -&gt; EtcdLog -&gt; [Char] -&gt; [Char]
$cshow :: EtcdLog -&gt; [Char]
show :: EtcdLog -&gt; [Char]
$cshowList :: [EtcdLog] -&gt; [Char] -&gt; [Char]
showList :: [EtcdLog] -&gt; [Char] -&gt; [Char]
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680482890"><span id="local-6989586621680482892"><span class="annot"><span class="annottext">(forall x. EtcdLog -&gt; Rep EtcdLog x)
-&gt; (forall x. Rep EtcdLog x -&gt; EtcdLog) -&gt; Generic EtcdLog
forall x. Rep EtcdLog x -&gt; EtcdLog
forall x. EtcdLog -&gt; Rep EtcdLog x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cfrom :: forall x. EtcdLog -&gt; Rep EtcdLog x
from :: forall x. EtcdLog -&gt; Rep EtcdLog x
$cto :: forall x. Rep EtcdLog x -&gt; EtcdLog
to :: forall x. Rep EtcdLog x -&gt; EtcdLog
</span><a href="file:///nix/store/6hbgd0w57swq4rl9pcga8m90m9ayylh2-ghc-9.6.6-doc/share/doc/ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680482896"><span id="local-6989586621680482903"><span id="local-6989586621680482906"><span id="local-6989586621680482909"><span id="local-6989586621680482912"><span class="annot"><span class="annottext">[EtcdLog] -&gt; Value
[EtcdLog] -&gt; Encoding
EtcdLog -&gt; Bool
EtcdLog -&gt; Value
EtcdLog -&gt; Encoding
(EtcdLog -&gt; Value)
-&gt; (EtcdLog -&gt; Encoding)
-&gt; ([EtcdLog] -&gt; Value)
-&gt; ([EtcdLog] -&gt; Encoding)
-&gt; (EtcdLog -&gt; Bool)
-&gt; ToJSON EtcdLog
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; (a -&gt; Bool)
-&gt; ToJSON a
$ctoJSON :: EtcdLog -&gt; Value
toJSON :: EtcdLog -&gt; Value
$ctoEncoding :: EtcdLog -&gt; Encoding
toEncoding :: EtcdLog -&gt; Encoding
$ctoJSONList :: [EtcdLog] -&gt; Value
toJSONList :: [EtcdLog] -&gt; Value
$ctoEncodingList :: [EtcdLog] -&gt; Encoding
toEncodingList :: [EtcdLog] -&gt; Encoding
$comitField :: EtcdLog -&gt; Bool
omitField :: EtcdLog -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>
</span><span id="line-587"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Arbitrary</span></span><span> </span><span class="annot"><a href="Hydra.Network.Etcd.html#EtcdLog"><span class="hs-identifier hs-type">EtcdLog</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-588"></span><span>  </span><span id="local-6989586621680483484"><span class="annot"><span class="annottext">arbitrary :: Gen EtcdLog
</span><a href="#local-6989586621680483484"><span class="hs-identifier hs-var hs-var hs-var hs-var">arbitrary</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Gen EtcdLog
forall a.
(Generic a, GA UnsizedOpts (Rep a),
 UniformWeight (Weights_ (Rep a))) =&gt;
Gen a
</span><span class="hs-identifier hs-var">genericArbitrary</span></span><span>
</span><span id="line-589"></span><span>  </span><span id="local-6989586621680483577"><span class="annot"><span class="annottext">shrink :: EtcdLog -&gt; [EtcdLog]
</span><a href="#local-6989586621680483577"><span class="hs-identifier hs-var hs-var hs-var hs-var">shrink</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EtcdLog -&gt; [EtcdLog]
forall a.
(Generic a, RecursivelyShrink (Rep a), GSubterms (Rep a) a) =&gt;
a -&gt; [a]
</span><span class="hs-identifier hs-var">genericShrink</span></span><span>
</span><span id="line-590"></span></pre></body></html>