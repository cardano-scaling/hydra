"use strict";(self.webpackChunkhydra_head_protocol_docs=self.webpackChunkhydra_head_protocol_docs||[]).push([[7311],{96632:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>a});var t=s(84968),i=s(74848),r=s(28453);const o={slug:19,title:"19. Use of reference scripts\n",authors:[],tags:["Accepted"]},d=void 0,c={authorsImageUrls:[]},a=[{value:"Status",id:"status",level:2},{value:"Context",id:"context",level:2},{value:"Decision",id:"decision",level:2},{value:"Consequences",id:"consequences",level:2}];function l(e){const n={a:"a",code:"code",em:"em",h2:"h2",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"status",children:"Status"}),"\n",(0,i.jsx)(n.p,{children:"Accepted"}),"\n",(0,i.jsx)(n.h2,{id:"context",children:"Context"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["In the desire to make Hydra transactions smaller and cheaper (at the time of writing any abort tx was too big), we want to use the ",(0,i.jsx)(n.strong,{children:"reference script"})," and ",(0,i.jsx)(n.strong,{children:"reference input"})," features of the upcoming ",(0,i.jsx)(n.code,{children:"Babbage"})," ledger era. See the ",(0,i.jsx)(n.a,{href:"https://hydra.iohk.io/build/16861604/download/1/babbage-changes.pdf",children:"babbage ledger spec"}),", ",(0,i.jsx)(n.a,{href:"https://github.com/cardano-foundation/CIPs/tree/master/CIP-0031",children:"CIP-31"})," and ",(0,i.jsx)(n.a,{href:"https://github.com/cardano-foundation/CIPs/tree/master/CIP-0033",children:"CIP-33"})," for details."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"With these features we do not need to (re-)include scripts in each transaction."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"The CIPs do not specify how reference scripts are to be managed and we can see at least two options:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Add them as outputs to the ",(0,i.jsx)(n.code,{children:"init"})," transaction or prior that as part of each Hydra Head instance"]}),"\n",(0,i.jsx)(n.li,{children:"Post them out-of-band, separate to individual Head instances"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:'Ownership of the outputs holding the scripts is to be considered. If these "reference outputs" are spent, they cannot be referred to anymore. This would mean all heads referring to them can be denied of service (DoS).'}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Each head will need to refer to the correct version of the hydra scripts. That is, consistent with the script hashes known to the ",(0,i.jsx)(n.code,{children:"hydra-node"}),"."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"This is also related to the problem of managing script versions & updates."}),"\n",(0,i.jsxs)(n.li,{children:["Right now, the ",(0,i.jsx)(n.code,{children:"hydra-node"})," is compiled against ",(0,i.jsx)(n.code,{children:"hydra-plutus"})," to access compiled script content and hashes."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["The general trade-off is: instead of paying ADA fees for scripts adding to the transaction size in ",(0,i.jsx)(n.em,{children:"each"})," transaction, ADA deposits will need to be put down to have scripts be part of the UTxO set in the ledger ",(0,i.jsx)(n.em,{children:"once"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"decision",children:"Decision"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Publish outputs holding Hydra scripts out-of-band (option 2), because"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["All scripts would not fit into the ",(0,i.jsx)(n.code,{children:"init"})," transaction directly, we would need to post multiple."]}),"\n",(0,i.jsx)(n.li,{children:"Costs (deposits) would need to be paid for each head instance."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["The scripts are stored at outputs addressed to some ",(0,i.jsx)(n.strong,{children:"unspendable"})," ",(0,i.jsx)(n.code,{children:"v_publish"})," validator."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"This is to avoid DoS risk and unnecessariy centralization"}),"\n",(0,i.jsxs)(n.li,{children:['We have considered "garbage collection" by allowing spending these outputs into re-publishing new versions of the script.',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'This would make things even more complicated and we decided to not bother about "littering the chain" right now.'}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["We will publish scripts on release of the ",(0,i.jsx)(n.code,{children:"hydra-node"}),", or more specifically of the ",(0,i.jsx)(n.code,{children:"hydra-plutus"})," package."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"consequences",children:"Consequences"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["We need a process and/or tool to publish ",(0,i.jsx)(n.code,{children:"hydra-plutus"})," scripts and need to pay the deposits."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Any other party could do the same, this does not lead to centralization."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"hydra-node"})," would be need to know the ",(0,i.jsx)(n.code,{children:"TxIn"}),'s of the "right" published scripts.']}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"In the simplest case we would just make this configurable and provide configurations for the various networks after publishing scripts."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["If we combine the ",(0,i.jsx)(n.code,{children:"v_publish"}),' validator with a "tag", this allows nodes to "discover" scripts of a known version']}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["For example, we could define ",(0,i.jsx)(n.code,{children:"HydraHeadV1"}),", ",(0,i.jsx)(n.code,{children:"HydraInitialV1"})," and ",(0,i.jsx)(n.code,{children:"HydraCommitV1"})," as such tags"]}),"\n",(0,i.jsx)(n.li,{children:"We could parameterize the validator by the tag, yielding unique addresses per tag."}),"\n",(0,i.jsx)(n.li,{children:'Alternatively, the "tag" could be stored in a canonical form as datum on the script outputs.'}),"\n",(0,i.jsxs)(n.li,{children:["In any case, this allows for some checking consistency or easier configuration (not needing to enumerate which ",(0,i.jsx)(n.code,{children:"TxIn"})," is which script)"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["By also knowing the script hashes the ",(0,i.jsx)(n.code,{children:"hydra-node"}),' can verify the integrity of "found" reference scripts']}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"This would be possible right now, as they are compiled into the node"}),"\n",(0,i.jsx)(n.li,{children:"Might be undesirable later for easier system configuration"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["By making ",(0,i.jsx)(n.code,{children:"v_publish"}),' unspendable, we "litter" the chain. However, any garbage collection scheme would mean potential to DoS again.']}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Extended diagram for the ",(0,i.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:s(25673).A+"",children:"abort"})," on-chain life-cycles of a Hydra Head to include reference scripts."]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},25673:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/files/on-chain-abort-reference-scripts-4fdf2aae00b80ca995690fe6f3208f4e.jpg"},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>d});var t=s(96540);const i={},r=t.createContext(i);function o(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(r.Provider,{value:n},e.children)}},84968:e=>{e.exports=JSON.parse('{"permalink":"/head-protocol/adr/19","source":"@site/adr/2022-07-22_019-reference-scripts.md","title":"19. Use of reference scripts\\n","description":"Status","date":"2022-07-22T00:00:00.000Z","tags":[{"inline":true,"label":"Accepted","permalink":"/head-protocol/adr/tags/accepted"}],"readingTime":3.01,"hasTruncateMarker":false,"authors":[],"frontMatter":{"slug":"19","title":"19. Use of reference scripts\\n","authors":[],"tags":["Accepted"]},"unlisted":false,"prevItem":{"title":"18. Single state in Hydra.Node.\\n","permalink":"/head-protocol/adr/18"},"nextItem":{"title":"20. Handling time\\n","permalink":"/head-protocol/adr/20"}}')}}]);