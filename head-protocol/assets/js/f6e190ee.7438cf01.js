"use strict";(self.webpackChunkhydra_head_protocol_docs=self.webpackChunkhydra_head_protocol_docs||[]).push([[1296],{88374:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"how-to/commit-script-utxo","title":"Commit a Script UTxO into a Head","description":"This guide provides a walkthrough on how to commit a UTxO from a script into a Hydra Head.","source":"@site/docs/how-to/commit-script-utxo.md","sourceDirName":"how-to","slug":"/how-to/commit-script-utxo","permalink":"/head-protocol/docs/how-to/commit-script-utxo","draft":false,"unlisted":false,"editUrl":"https://github.com/cardano-scaling/hydra/tree/master/docs/docs/how-to/commit-script-utxo.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"userDocumentation","previous":{"title":"Commit using a blueprint","permalink":"/head-protocol/docs/how-to/commit-blueprint"},"next":{"title":"Submit a transaction","permalink":"/head-protocol/docs/how-to/submit-transaction"}}');var s=n(74848),r=n(28453);const a={sidebar_position:2},o="Commit a Script UTxO into a Head",c={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Step 1: Set Up Your Environment",id:"step-1-set-up-your-environment",level:2},{value:"Step 2: Create the script",id:"step-2-create-the-script",level:2},{value:"Step 3: Create the script address",id:"step-3-create-the-script-address",level:2},{value:"Step 4: Lock funds in the script address",id:"step-4-lock-funds-in-the-script-address",level:2},{value:"Step 5: Prepare the Blueprint",id:"step-5-prepare-the-blueprint",level:2},{value:"Step 6: Prepare the commit",id:"step-6-prepare-the-commit",level:2},{value:"Bonus: Experimenting with a Failing Script",id:"bonus-experimenting-with-a-failing-script",level:2}];function l(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"commit-a-script-utxo-into-a-head",children:"Commit a Script UTxO into a Head"})}),"\n",(0,s.jsx)(t.p,{children:"This guide provides a walkthrough on how to commit a UTxO from a script into a Hydra Head."}),"\n",(0,s.jsxs)(t.p,{children:["A ",(0,s.jsx)(t.strong,{children:"Script UTxO"}),' is a special kind of Unspent Transaction Output (UTxO) that isn\'t controlled by a simple private key. Instead, it is locked by a script - a small program that runs on the blockchain. To spend the funds in a Script UTxO, you must provide data (a "redeemer" and "datum") that satisfies the conditions defined in that script.']}),"\n",(0,s.jsx)(t.p,{children:"Committing a script UTxO to a Hydra Head is a powerful feature that allows for more complex on-chain validation logic to be brought into the Head. This is useful for scenarios where you need to enforce specific rules on how funds can be spent, even within the Head's off-chain environment."}),"\n",(0,s.jsx)(t.p,{children:'This tutorial will guide you through the entire process, which involves creating a script, locking an on-chain UTxO with it, and then preparing a special "blueprint" transaction to commit this script UTxO into an open Head.'}),"\n",(0,s.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(t.p,{children:["This tutorial assumes you are familiar with the process of committing a standard UTxO to a Hydra Head. If you are not, please first read the ",(0,s.jsx)(t.a,{href:"/head-protocol/docs/how-to/commit-blueprint",children:"Commit using a blueprint"})," tutorial."]}),"\n",(0,s.jsx)(t.p,{children:"You will also need:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["A running ",(0,s.jsx)(t.code,{children:"cardano-node"})," connected to a testnet."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"cardano-cli"})," in your ",(0,s.jsx)(t.code,{children:"PATH"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"hydra-node"})," and ",(0,s.jsx)(t.code,{children:"hydra-tui"})," in your ",(0,s.jsx)(t.code,{children:"PATH"}),"."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"step-1-set-up-your-environment",children:"Step 1: Set Up Your Environment"}),"\n",(0,s.jsxs)(t.p,{children:["To avoid specifying the network identifier and the path to the node's socket in every command, you can set the following environment variables in your shell. Make sure to replace the values with the ones that are appropriate for your setup (e.g., for the pre-production testnet, the magic is ",(0,s.jsx)(t.code,{children:"1"}),")."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"export CARDANO_NODE_SOCKET_PATH=<path-to>/node.socket\nexport CARDANO_TESTNET_MAGIC=1\nexport CREDENTIALS_PATH=hydra-cluster/config/credentials\n"})}),"\n",(0,s.jsx)(t.h2,{id:"step-2-create-the-script",children:"Step 2: Create the script"}),"\n",(0,s.jsx)(t.p,{children:'For this tutorial, we will use a simple "always true" validator script. This script will always succeed, regardless of the redeemer or datum.'}),"\n",(0,s.jsxs)(t.p,{children:["Create a file named ",(0,s.jsx)(t.code,{children:"always-true.plutus"})," with the following content:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'{\n    "type": "PlutusScriptV2",\n    "description": "Always true validator",\n    "cborHex": "49480100002221200101"\n}\n'})}),"\n",(0,s.jsx)(t.h2,{id:"step-3-create-the-script-address",children:"Step 3: Create the script address"}),"\n",(0,s.jsxs)(t.p,{children:["Now, we need to create an address for this script. We can do this using ",(0,s.jsx)(t.code,{children:"cardano-cli"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"cardano-cli address build \\\n  --payment-script-file always-true.plutus \\\n  --testnet-magic $CARDANO_TESTNET_MAGIC \\\n  --out-file script.addr\n"})}),"\n",(0,s.jsxs)(t.p,{children:["This will create a file named ",(0,s.jsx)(t.code,{children:"script.addr"})," containing the script address. You can inspect the address using ",(0,s.jsx)(t.code,{children:"cat"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"cat script.addr\n"})}),"\n",(0,s.jsx)(t.h2,{id:"step-4-lock-funds-in-the-script-address",children:"Step 4: Lock funds in the script address"}),"\n",(0,s.jsx)(t.p,{children:"Before we can commit a script UTxO, we need to create one. This is done by sending funds to the script address."}),"\n",(0,s.jsxs)(t.p,{children:["First, we need a UTxO in a wallet to fund the transaction. The following command will find the first available UTxO in a wallet funded by ",(0,s.jsx)(t.code,{children:"alice-funds.sk"}),", and export its transaction input (",(0,s.jsx)(t.code,{children:"TxIn"}),") to an environment variable."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"export UTXO_TXIX=$(cardano-cli query utxo --address $(cardano-cli address build --payment-verification-key-file ${CREDENTIALS_PATH}/alice-funds.vk --testnet-magic $CARDANO_TESTNET_MAGIC) --testnet-magic $CARDANO_TESTNET_MAGIC --output-json | jq -r 'keys[0]')\necho \"Captured funding UTxO TxIn: $UTXO_TXIX\"\n"})}),"\n",(0,s.jsx)(t.p,{children:"Now that we have a funding UTxO, we can build the transaction to lock 10 ADA at the script address."}),"\n",(0,s.jsxs)(t.p,{children:["First, create a file named ",(0,s.jsx)(t.code,{children:"datum.json"})," that contains the datum. For this example, we will just use the integer ",(0,s.jsx)(t.code,{children:"42"}),"."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'{\n    "constructor": 0,\n    "fields": [\n        {\n            "int": 42\n        }\n    ]\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:"Now, build the transaction:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"cardano-cli conway transaction build \\\n  --tx-in $UTXO_TXIX \\\n  --tx-out $(cat script.addr)+10000000 \\\n  --tx-out-inline-datum-file datum.json \\\n  --change-address $(cardano-cli address build --payment-verification-key-file ${CREDENTIALS_PATH}/alice-funds.vk --testnet-magic $CARDANO_TESTNET_MAGIC) \\\n  --testnet-magic $CARDANO_TESTNET_MAGIC \\\n  --out-file tx.raw\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Note that we are also providing an inline datum via the ",(0,s.jsx)(t.code,{children:"datum.json"})," file. Even though our script does not use it, a datum is required for all script UTxOs."]}),"\n",(0,s.jsx)(t.p,{children:"Now, sign and submit the transaction:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"cardano-cli conway transaction sign \\\n  --tx-body-file tx.raw \\\n  --signing-key-file ${CREDENTIALS_PATH}/alice-funds.sk \\\n  --out-file tx.signed\n\ncardano-cli conway transaction submit \\\n  --tx-file tx.signed \\\n  --testnet-magic $CARDANO_TESTNET_MAGIC\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Once the transaction is confirmed, you can query the script address to find the transaction input (",(0,s.jsx)(t.code,{children:"TxIn"}),") of the script UTxO we just created."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"export SCRIPT_UTXO_TXIX=$(cardano-cli query utxo --address $(cat script.addr) --testnet-magic $CARDANO_TESTNET_MAGIC --output-json | jq -r 'keys[0]')\necho \"Captured script UTxO TxIn: $SCRIPT_UTXO_TXIX\"\n"})}),"\n",(0,s.jsx)(t.h2,{id:"step-5-prepare-the-blueprint",children:"Step 5: Prepare the Blueprint"}),"\n",(0,s.jsxs)(t.p,{children:["Now we are ready to prepare the commit. We will create a blueprint transaction that spends the script UTxO. Note that this transaction is not meant to be signed and submitted to the Cardano network. It is just a blueprint that we will send to the ",(0,s.jsx)(t.code,{children:"hydra-node"})," to get a properly drafted commit transaction."]}),"\n",(0,s.jsxs)(t.p,{children:["We use ",(0,s.jsx)(t.code,{children:"cardano-cli ... build-raw"})," to construct this blueprint because it gives us full control over the transaction structure without trying to automatically balance it or calculate fees, which is perfect for a blueprint."]}),"\n",(0,s.jsxs)(t.p,{children:["For a script UTxO, the blueprint only needs to declare the script UTxO as an input. The ",(0,s.jsx)(t.code,{children:"hydra-node"})," will use this, along with the UTxO context provided in the next step, to build the full commit transaction."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"cardano-cli conway transaction build-raw \\\n  --tx-in $SCRIPT_UTXO_TXIX \\\n  --tx-in-script-file always-true.plutus \\\n  --tx-in-inline-datum-present \\\n  --tx-in-redeemer-value 42 \\\n  --tx-in-execution-units '(1000000, 100000)' \\\n  --tx-out $(cardano-cli address build --payment-verification-key-file ${CREDENTIALS_PATH}/alice-funds.vk --testnet-magic $CARDANO_TESTNET_MAGIC)+10000000 \\\n  --fee 0 \\\n  --out-file tx.json\n"})}),"\n",(0,s.jsxs)(t.p,{children:["A real-world script, like one written in ",(0,s.jsx)(t.a,{href:"https://aiken-lang.org/",children:"Aiken"}),', would use the datum to carry state and the redeemer to provide input for validation. Our "always-true" script doesn\'t actually check any of these, but they are still required fields for a valid transaction that spends a script UTxO. Note that we use ',(0,s.jsx)(t.code,{children:"--tx-in-inline-datum-present"})," because the datum was already included on-chain when we created the script UTxO. We also provide ",(0,s.jsx)(t.code,{children:"--tx-in-execution-units"}),". This is required for any script spend to tell the network how much computational resource to budget for the script's execution. Since our script does nothing, we can use ",(0,s.jsx)(t.code,{children:"(0, 0)"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"step-6-prepare-the-commit",children:"Step 6: Prepare the commit"}),"\n",(0,s.jsxs)(t.p,{children:["This final step brings everything together. We will start a ",(0,s.jsx)(t.code,{children:"hydra-node"}),", initialize a Head, and then send our blueprint and UTxO context to the ",(0,s.jsx)(t.code,{children:"/commit"})," endpoint."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"1. Start the Hydra Node and TUI"})}),"\n",(0,s.jsxs)(t.p,{children:["In a ",(0,s.jsx)(t.strong,{children:"new terminal"}),", start a single-party ",(0,s.jsx)(t.code,{children:"hydra-node"}),"."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"hydra-node \\\n  --node-id 1 \\\n  --api-port 4001 \\\n  --hydra-signing-key ${CREDENTIALS_PATH}/../alice.sk \\\n  --cardano-signing-key ${CREDENTIALS_PATH}/alice.sk \\\n  --ledger-protocol-parameters devnet/protocol-parameters.json \\\n  --testnet-magic $CARDANO_TESTNET_MAGIC \\\n  --node-socket $CARDANO_NODE_SOCKET_PATH\n"})}),"\n",(0,s.jsxs)(t.p,{children:["In another ",(0,s.jsx)(t.strong,{children:"new terminal"}),", start the ",(0,s.jsx)(t.code,{children:"hydra-tui"}),"."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"hydra-tui \\\n  --connect 0.0.0.0:4001 \\\n  --cardano-signing-key ${CREDENTIALS_PATH}/alice-funds.sk\n"})}),"\n",(0,s.jsxs)(t.p,{children:["In the TUI, press ",(0,s.jsx)(t.code,{children:"i"})," to initialize the Head. Once the state is ",(0,s.jsx)(t.code,{children:"Initializing"}),", you can quit the TUI (",(0,s.jsx)(t.code,{children:"q"}),") and proceed."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"2. Send the Commit Request"})}),"\n",(0,s.jsxs)(t.p,{children:["Now, we will build the commit request. This request contains two parts: the ",(0,s.jsx)(t.code,{children:"utxo"})," context (which must include the script) and the ",(0,s.jsx)(t.code,{children:"blueprintTx"})," (which provides the witness information)."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:'# Set variables\nBLUEPRINT_JSON=$(cat tx.json)\nUTXO_JSON=$(cardano-cli query utxo --tx-in ${SCRIPT_UTXO_TXIX} --testnet-magic $CARDANO_TESTNET_MAGIC --output-json)\n\n# Create the request body\njq -n \\\n  --argjson utxo "${UTXO_JSON}" \\\n  --argjson blueprintTx "${BLUEPRINT_JSON}" \\\n  \'{ "utxo": $utxo, "blueprintTx": $blueprintTx }\' \\\n  > commit-request.json\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Now, use ",(0,s.jsx)(t.code,{children:"curl"})," to send the request to the ",(0,s.jsx)(t.code,{children:"hydra-node"}),", which will respond with a drafted commit transaction:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"curl -X POST --data @commit-request.json http://127.0.0.1:4001/commit > commit-tx.json\n"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"3. Sign and Submit"})}),"\n",(0,s.jsxs)(t.p,{children:["This is the final step. The ",(0,s.jsx)(t.code,{children:"commit-tx.json"})," file now contains a valid, balanced transaction drafted by the ",(0,s.jsx)(t.code,{children:"hydra-node"}),". We just need to sign it with both our funds key and our party key, and then submit it."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"cardano-cli conway transaction sign \\\n  --tx-body-file commit-tx.json \\\n  --signing-key-file ${CREDENTIALS_PATH}/alice-funds.sk \\\n  --signing-key-file ${CREDENTIALS_PATH}/alice.sk \\\n  --out-file signed-tx.json\n\ncardano-cli conway transaction submit \\\n  --tx-file signed-tx.json \\\n  --testnet-magic $CARDANO_TESTNET_MAGIC\n"})}),"\n",(0,s.jsx)(t.p,{children:"And that's it! After the transaction is confirmed on-chain, your script UTxO will be committed to the Head."}),"\n",(0,s.jsx)(t.h2,{id:"bonus-experimenting-with-a-failing-script",children:"Bonus: Experimenting with a Failing Script"}),"\n",(0,s.jsxs)(t.p,{children:['It can be very insightful to see what happens when a script validator fails. To demonstrate this, you can create an "always false" validator and see how ',(0,s.jsx)(t.code,{children:"cardano-cli"}),"'s local validation prevents you from even building a transaction that uses it."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsxs)(t.strong,{children:["1. Create the ",(0,s.jsx)(t.code,{children:"always-false.plutus"})," script"]})}),"\n",(0,s.jsxs)(t.p,{children:["Create a new file named ",(0,s.jsx)(t.code,{children:"always-false.plutus"})," with the following content. This is a valid Plutus script that is guaranteed to fail validation."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'{\n    "type": "PlutusScriptV2",\n    "description": "Always false validator",\n    "cborHex": "49480100002221200100"\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"2. Lock funds with the failing script"})}),"\n",(0,s.jsxs)(t.p,{children:["Follow the same steps as in ",(0,s.jsx)(t.strong,{children:"Step 3"})," and ",(0,s.jsx)(t.strong,{children:"Step 4"})," of the main tutorial, but use ",(0,s.jsx)(t.code,{children:"always-false.plutus"})," instead of ",(0,s.jsx)(t.code,{children:"always-true.plutus"})," to create a new script address and lock a new UTxO in it."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"3. Attempt to build a blueprint"})}),"\n",(0,s.jsxs)(t.p,{children:["Now, try to run the ",(0,s.jsx)(t.code,{children:"build-raw"})," command from ",(0,s.jsx)(t.strong,{children:"Step 5"})," using the UTxO locked by the failing script."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Expected Result: Failure"})}),"\n",(0,s.jsxs)(t.p,{children:["You will find that the ",(0,s.jsx)(t.code,{children:"cardano-cli conway transaction build-raw"})," command itself will fail. It will produce an error message similar to this:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-shell",children:"Command failed: transaction build-raw  Error: A script in the transaction has failed.\n"})}),"\n",(0,s.jsxs)(t.p,{children:["This is a powerful feature of ",(0,s.jsx)(t.code,{children:"cardano-cli"}),". It evaluates the scripts locally ",(0,s.jsx)(t.em,{children:"before"})," creating the transaction. By catching the script failure at this early stage, it prevents you from submitting a transaction that would be guaranteed to fail on the blockchain, saving you time and the transaction fees."]})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>o});var i=n(96540);const s={},r=i.createContext(s);function a(e){const t=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(r.Provider,{value:t},e.children)}}}]);