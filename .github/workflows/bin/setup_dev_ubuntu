#!/usr/bin/env bash

set -euo pipefail

apt-get update
# Install netbase to work around https://github.com/input-output-hk/cardano-node/issues/2752
apt-get install -y netbase
# Install ghcup dependencies
apt-get install -y --no-install-recommends \
    curl \
    libnuma-dev \
    zlib1g-dev \
    libgmp-dev \
    libgmp10 \
    git \
    wget \
    lsb-release \
    software-properties-common \
    gnupg2 \
    apt-transport-https \
    gcc \
    autoconf \
    automake \
    build-essential

# TODO install cardano-node
# ADD cardano-node.tar.gz /srv/cardano

# Install ghc and cabal
ghcup -v install ghc --isolate /usr/local --force 8.10.7 && \
ghcup -v install cabal --isolate /usr/local/bin --force 3.10.1.0

# Install cardano-node dependencies see https://developers.cardano.org/docs/get-started/installing-cardano-node/#linux
apt-get install -y \
  automake \
  build-essential \
  pkg-config \
  libffi-dev \
  libgmp-dev \
  libssl-dev \
  libtinfo-dev \
  libsystemd-dev \
  zlib1g-dev \
  make \
  g++ \
  tmux \
  git \
  jq \
  wget \
  libncursesw5 \
  libtool \
  autoconf

# Install libsodium
(
  cd /srv
  git clone https://github.com/input-output-hk/libsodium
  cd /srv/libsodium
  git checkout 66f017f1
  ./autogen.sh
  ./configure
  make
  make install
)

# Install secp256k1
(
  cd /srv/
  git clone https://github.com/bitcoin-core/secp256k1
  cd /srv/secp256k1
  git checkout ac83be33
  ./autogen.sh
  ./configure --enable-module-schnorrsig --enable-experimental
  make
  make install
)

cat <<EOF
# Setup the following environment varialbles:
LD_LIBRARY_PATH="/usr/local/lib:${LD_LIBRARY_PATH}"
PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:${PKG_CONFIG_PATH}"
EOF
